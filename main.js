/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository
*/

var M=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var j=(u,t)=>{for(var e in t)M(u,e,{get:t[e],enumerable:!0})},G=(u,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of V(t))!_.call(u,r)&&r!==e&&M(u,r,{get:()=>t[r],enumerable:!(n=A(t,r))||n.enumerable});return u};var W=u=>G(M({},"__esModule",{value:!0}),u);var R={};j(R,{default:()=>L});module.exports=W(R);var g=require("obsidian");var m=require("obsidian"),U={scripts:[],automaticallyCheckForUpdates:!0,updateInterval:24,debug:!1},k=class extends m.PluginSettingTab{constructor(e,n){super(e,n);this.plugin=n}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Tampermonkey \u8BBE\u7F6E"}),e.createEl("p",{text:"\u8FD9\u4E2A\u63D2\u4EF6\u5141\u8BB8\u4F60\u5728Obsidian\u7684\u5185\u90E8\u6D4F\u89C8\u5668\u4E2D\u4F7F\u7528\u7528\u6237\u811A\u672C\u3002"}),e.createEl("h3",{text:"\u5E38\u89C4\u8BBE\u7F6E"}),new m.Setting(e).setName("\u81EA\u52A8\u68C0\u67E5\u66F4\u65B0").setDesc("\u5B9A\u671F\u68C0\u67E5\u7528\u6237\u811A\u672C\u7684\u66F4\u65B0").addToggle(r=>r.setValue(this.plugin.settings.automaticallyCheckForUpdates).onChange(async o=>{this.plugin.settings.automaticallyCheckForUpdates=o,await this.plugin.saveSettings()})),new m.Setting(e).setName("\u66F4\u65B0\u68C0\u67E5\u95F4\u9694").setDesc("\u68C0\u67E5\u811A\u672C\u66F4\u65B0\u7684\u95F4\u9694(\u5C0F\u65F6)").addSlider(r=>r.setLimits(1,168,1).setValue(this.plugin.settings.updateInterval).setDynamicTooltip().onChange(async o=>{this.plugin.settings.updateInterval=o,await this.plugin.saveSettings()})),new m.Setting(e).setName("\u8C03\u8BD5\u6A21\u5F0F").setDesc("\u542F\u7528\u8C03\u8BD5\u65E5\u5FD7").addToggle(r=>r.setValue(this.plugin.settings.debug).onChange(async o=>{this.plugin.settings.debug=o,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u811A\u672C\u7BA1\u7406"}),new m.Setting(e).setName("\u5BFC\u5165\u811A\u672C").setDesc("\u4ECE\u6587\u4EF6\u5BFC\u5165\u7528\u6237\u811A\u672C").addButton(r=>r.setButtonText("\u5BFC\u5165").setCta().onClick(()=>{this.importScript()})),new m.Setting(e).setName("\u521B\u5EFA\u65B0\u811A\u672C").setDesc("\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u7528\u6237\u811A\u672C").addButton(r=>r.setButtonText("\u521B\u5EFA").setCta().onClick(()=>{this.createScript()})),e.createEl("h3",{text:"\u5DF2\u5B89\u88C5\u7684\u811A\u672C"});let n=e.createDiv({cls:"tampermonkey-script-list"});this.plugin.settings.scripts.length===0?n.createEl("p",{text:'\u6CA1\u6709\u5DF2\u5B89\u88C5\u7684\u7528\u6237\u811A\u672C\u3002\u70B9\u51FB\u4E0A\u65B9\u7684"\u5BFC\u5165"\u6216"\u521B\u5EFA"\u6309\u94AE\u6765\u6DFB\u52A0\u811A\u672C\u3002'}):this.plugin.settings.scripts.forEach(r=>{this.createScriptItem(n,r)})}createScriptItem(e,n){let r=e.createDiv({cls:"tampermonkey-script-item"}),o=r.createDiv({cls:"tampermonkey-script-enabled"}),i=new m.Setting(o).setName("").addToggle(d=>d.setValue(n.enabled).onChange(async y=>{y?this.plugin.scriptManager.enableScript(n.id):this.plugin.scriptManager.disableScript(n.id),await this.plugin.saveSettings()})),s=r.createDiv({cls:"tampermonkey-script-name"}),a=s.createEl("div",{text:n.name,cls:"tampermonkey-script-name-text"});a.addEventListener("dblclick",()=>{let d=document.createElement("input");d.type="text",d.value=n.name,d.className="tampermonkey-script-name-edit",d.style.width="100%",a.replaceWith(d),d.focus(),d.select();let y=async()=>{let p=d.value.trim();if(p&&p!==n.name)try{let f=n.source,v=f.replace(/\/\/ @name\s+.*/,`// @name ${p}`);v!==f&&(this.plugin.scriptManager.updateScript(n.id,v),await this.plugin.saveSettings(),new m.Notice(`\u811A\u672C\u540D\u79F0\u5DF2\u66F4\u65B0\u4E3A "${p}"`),this.display())}catch(f){new m.Notice(`\u66F4\u65B0\u811A\u672C\u540D\u79F0\u5931\u8D25: ${f.message}`),d.replaceWith(a)}else d.replaceWith(a)};d.addEventListener("blur",y),d.addEventListener("keydown",p=>{p.key==="Enter"?y():p.key==="Escape"&&d.replaceWith(a)})}),n.description&&s.createEl("div",{text:n.description,cls:"tampermonkey-script-description"});let l=r.createDiv({cls:"tampermonkey-script-actions"}),c=new m.ButtonComponent(l).setIcon("pencil").setTooltip("\u7F16\u8F91").onClick(()=>{this.editScript(n)}),h=new m.ButtonComponent(l).setIcon("trash").setTooltip("\u5220\u9664").onClick(()=>{this.deleteScript(n)})}async importScript(){new I(this.app,async n=>{try{let r=this.plugin.scriptManager.addScript(n);await this.plugin.saveSettings(),new m.Notice(`\u811A\u672C "${r.name}" \u5DF2\u5BFC\u5165`),this.display()}catch(r){new m.Notice(`\u5BFC\u5165\u811A\u672C\u5931\u8D25: ${r.message}`)}}).open()}async createScript(){let e=`// ==UserScript==
// @name        \u65B0\u811A\u672C
// @namespace   obsidian-tampermonkey
// @version     0.1
// @description \u5728\u6B64\u5904\u586B\u5199\u811A\u672C\u63CF\u8FF0
// @author      \u4F60\u7684\u540D\u5B57
// @match       *://*/*
// @grant       none
// ==/UserScript==

(function() {
    'use strict';
    
    // \u4F60\u7684\u4EE3\u7801\u5728\u8FD9\u91CC...
    console.log('Hello from Tampermonkey script!');
})();`;new E(this.app,e,async r=>{try{let o=this.plugin.scriptManager.addScript(r);await this.plugin.saveSettings(),new m.Notice(`\u811A\u672C "${o.name}" \u5DF2\u521B\u5EFA`),this.display()}catch(o){new m.Notice(`\u521B\u5EFA\u811A\u672C\u5931\u8D25: ${o.message}`)}}).open()}async editScript(e){new E(this.app,e.source,async r=>{try{this.plugin.scriptManager.updateScript(e.id,r),await this.plugin.saveSettings(),new m.Notice(`\u811A\u672C "${e.name}" \u5DF2\u66F4\u65B0`),this.display()}catch(o){new m.Notice(`\u66F4\u65B0\u811A\u672C\u5931\u8D25: ${o.message}`)}}).open()}async deleteScript(e){if(await new Promise(r=>{new C(this.app,`\u786E\u5B9A\u8981\u5220\u9664\u811A\u672C "${e.name}" \u5417\uFF1F`,r).open()}))try{this.plugin.scriptManager.removeScript(e.id),await this.plugin.saveSettings(),new m.Notice(`\u811A\u672C "${e.name}" \u5DF2\u5220\u9664`),this.display()}catch(r){new m.Notice(`\u5220\u9664\u811A\u672C\u5931\u8D25: ${r.message}`)}}},I=class extends m.Modal{constructor(e,n){super(e);this.content="";this.onSubmit=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("tampermonkey-dialog"),e.createEl("h2",{text:"\u5BFC\u5165\u7528\u6237\u811A\u672C"}),e.createEl("p",{text:"\u7C98\u8D34\u7528\u6237\u811A\u672C\u5185\u5BB9:"}),e.createEl("textarea",{cls:"tampermonkey-editor"}).addEventListener("input",s=>{this.content=s.target.value});let r=e.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u5BFC\u5165",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.content){new m.Notice("\u8BF7\u8F93\u5165\u811A\u672C\u5185\u5BB9");return}this.onSubmit(this.content),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},E=class extends m.Modal{constructor(e,n,r){super(e);this.content=n,this.onSubmit=r}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("tampermonkey-dialog"),e.createEl("h2",{text:"\u7F16\u8F91\u7528\u6237\u811A\u672C"});let n=e.createEl("textarea",{cls:"tampermonkey-editor"});n.value=this.content,n.addEventListener("input",s=>{this.content=s.target.value});let r=e.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.content){new m.Notice("\u811A\u672C\u5185\u5BB9\u4E0D\u80FD\u4E3A\u7A7A");return}this.onSubmit(this.content),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},C=class extends m.Modal{constructor(e,n,r){super(e);this.message=n,this.onConfirm=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\u786E\u8BA4"}),e.createEl("p",{text:this.message});let n=e.createDiv({cls:"modal-button-container"});n.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.onConfirm(!1),this.close()}),n.createEl("button",{text:"\u786E\u8BA4",cls:"mod-cta"}).addEventListener("click",()=>{this.onConfirm(!0),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var x=class{constructor(){this.id="",this.name="",this.namespace="",this.version="",this.description="",this.includes=[],this.matches=[],this.excludes=[],this.resources=[],this.requires=[],this.author="",this.homepage="",this.icon="",this.runAt="document-idle",this.enabled=!0,this.source="",this.lastUpdated=Date.now(),this.position=0}};var $=class{static getScriptId(t){var i;let e=Date.now().toString(36),n="",o=encodeURI(t).match(/[a-zA-Z0-9]/g);return o&&o.length>0?n=o.join(""):n=((i=btoa(t).match(/[a-zA-Z0-9]/g))==null?void 0:i.join(""))||"script",`${n}_${e}`}static parseScript(t){let e=new x;e.source=t;let n=t.indexOf(this.HEADER_START),r=t.indexOf(this.HEADER_END);if(n===-1||r===-1||r<=n)throw new Error("Invalid userscript: metadata block not found");let i=t.substring(n+this.HEADER_START.length,r).split(`
`),s=!1;for(let a of i){let l=a.trim();if(!l||!l.startsWith("//"))continue;let c=l.replace(/^\/\/\s*/,"").trim();if(!c.startsWith("@"))continue;let h=c.match(/@([a-zA-Z0-9_\-]+)\s+(.*)/);if(!h)continue;let[,d,y]=h,p=y.trim();switch(d){case"name":e.name=p,s=!0;break;case"namespace":e.namespace=p;break;case"version":e.version=p;break;case"description":e.description=p;break;case"author":e.author=p;break;case"homepage":case"website":case"source":e.homepage=p;break;case"icon":case"iconURL":case"defaulticon":e.icon=p;break;case"include":e.includes.push(p);break;case"match":e.matches.push(p);break;case"exclude":e.excludes.push(p);break;case"require":e.requires.push(p);break;case"resource":let f=p.match(/(\S+)\s+(.*)/);if(f){let[,v,D]=f;e.resources.push({name:v.trim(),url:D.trim()})}break;case"run-at":["document-start","document-end","document-idle"].includes(p)&&(e.runAt=p);break}}return(!s||!e.name)&&(e.name="\u672A\u547D\u540D\u811A\u672C",console.warn("\u811A\u672C\u6CA1\u6709\u540D\u79F0\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u540D\u79F0")),e.id=$.getScriptId(e.name),e}},S=$;S.HEADER_START="==UserScript==",S.HEADER_END="==/UserScript==";var b=class{constructor(){this.scripts=new Map;this.eventListeners={}}on(t,e){this.eventListeners[t]=e}getAllScripts(){return Array.from(this.scripts.values()).sort((t,e)=>t.position-e.position)}getScript(t){return this.scripts.get(t)}addScript(t){try{let e=S.parseScript(t);if(this.scripts.has(e.id))throw new Error(`Script with name '${e.name}' already exists`);return e.position=this.scripts.size,this.scripts.set(e.id,e),this.eventListeners.onScriptAdded&&this.eventListeners.onScriptAdded(e),e}catch(e){throw new Error(`Failed to add script: ${e.message}`)}}updateScript(t,e){if(!this.scripts.has(t))throw new Error(`Script with ID '${t}' not found`);try{let n=this.scripts.get(t),r=S.parseScript(e);return r.id=t,r.position=(n==null?void 0:n.position)||0,r.enabled=(n==null?void 0:n.enabled)||!0,r.lastUpdated=Date.now(),this.scripts.set(t,r),this.eventListeners.onScriptUpdated&&this.eventListeners.onScriptUpdated(r),r}catch(n){throw new Error(`Failed to update script: ${n.message}`)}}removeScript(t){if(!this.scripts.has(t))throw new Error(`Script with ID '${t}' not found`);this.scripts.delete(t),this.getAllScripts().forEach((n,r)=>{n.position=r}),this.eventListeners.onScriptRemoved&&this.eventListeners.onScriptRemoved(t)}enableScript(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);e.enabled=!0,this.eventListeners.onScriptEnabled&&this.eventListeners.onScriptEnabled(t)}disableScript(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);e.enabled=!1,this.eventListeners.onScriptDisabled&&this.eventListeners.onScriptDisabled(t)}findScriptsForUrl(t){let e=[];for(let n of this.getAllScripts()){if(!n.enabled)continue;let r=n.includes.length===0||n.includes.some(s=>this.matchUrlPattern(t,s)),o=n.excludes.some(s=>this.matchUrlPattern(t,s)),i=n.matches.length===0||n.matches.some(s=>this.matchUrlPattern(t,s));r&&!o&&i&&e.push(n)}return e.sort((n,r)=>n.position-r.position)}matchUrlPattern(t,e){if(e==="*")return!0;try{let n=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");return n="^"+n+"$",new RegExp(n).test(t)}catch(n){return console.error(`Invalid pattern: ${e}`,n),!1}}loadScripts(t){this.scripts.clear(),t.forEach(e=>{this.scripts.set(e.id,e)})}moveScriptUp(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);if(e.position===0)return;let n=this.getAllScripts().find(r=>r.position===e.position-1);n&&(n.position++,e.position--,this.eventListeners.onScriptUpdated&&(this.eventListeners.onScriptUpdated(e),this.eventListeners.onScriptUpdated(n)))}moveScriptDown(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);let n=this.getAllScripts();if(e.position===n.length-1)return;let r=n.find(o=>o.position===e.position+1);r&&(r.position--,e.position++,this.eventListeners.onScriptUpdated&&(this.eventListeners.onScriptUpdated(e),this.eventListeners.onScriptUpdated(r)))}};var T=class{constructor(t){this.cache=new Map;this.plugin=t}async getValue(t,e){if(this.cache.has(t))return this.cache.get(t);let n=await this.plugin.loadData()||{},r=t in n?n[t]:e;return this.cache.set(t,r),r}async setValue(t,e){this.cache.set(t,e);let n=await this.plugin.loadData()||{};n[t]=e,await this.plugin.saveData(n)}async deleteValue(t){this.cache.delete(t);let e=await this.plugin.loadData()||{};t in e&&(delete e[t],await this.plugin.saveData(e))}async listValues(){let t=await this.plugin.loadData()||{};return Object.keys(t)}clearCache(){this.cache.clear()}};var w=class{constructor(t){this.scriptStorage=t}async injectScripts(t,e,n){if(!t)return;let r=n.filter(s=>s.runAt==="document-start"),o=n.filter(s=>s.runAt==="document-end"),i=n.filter(s=>s.runAt==="document-idle"||!s.runAt);for(let s of r)await this.injectScript(t,e,s);this.injectContentLoadedListener(t,e,o),this.injectLoadListener(t,e,i)}async injectScript(t,e,n){try{console.log(`Tampermonkey: \u5F00\u59CB\u6CE8\u5165\u811A\u672C "${n.name}"`);let r=await this.createGmApi(n,e),o=this.createScriptWrapper(n,r);switch(n.runAt){case"document-start":await this.injectScriptImmediately(t,o);break;case"document-end":await this.injectScriptOnContentLoaded(t,o);break;case"document-idle":default:await this.injectScriptOnLoad(t,o)}console.log(`Tampermonkey: \u811A\u672C "${n.name}" \u6CE8\u5165\u6210\u529F`)}catch(r){console.error(`Tampermonkey: \u6CE8\u5165\u811A\u672C "${n.name}" \u5931\u8D25:`,r)}}async injectScriptImmediately(t,e){try{t instanceof HTMLIFrameElement?await this.executeScriptInIframe(t,e):await this.executeScriptInWebView(t,e)}catch(n){throw console.error("Tampermonkey: \u7ACB\u5373\u6CE8\u5165\u811A\u672C\u5931\u8D25:",n),n}}async injectScriptOnContentLoaded(t,e){return new Promise((n,r)=>{let o=async i=>{try{t instanceof HTMLIFrameElement?await this.executeScriptInIframe(t,e):await this.executeScriptInWebView(t,e),n()}catch(s){r(s)}finally{t.removeEventListener("DOMContentLoaded",o)}};t.addEventListener("DOMContentLoaded",o)})}async injectScriptOnLoad(t,e){return new Promise((n,r)=>{let o=async i=>{try{t instanceof HTMLIFrameElement?await this.executeScriptInIframe(t,e):await this.executeScriptInWebView(t,e),n()}catch(s){r(s)}finally{t.removeEventListener("load",o)}};t.addEventListener("load",o)})}async createGmApi(t,e){let n={script:{name:t.name,namespace:t.namespace,description:t.description,version:t.version,includes:t.includes,excludes:t.excludes,matches:t.matches,resources:t.resources,requires:t.requires},version:"0.1.0",scriptHandler:"Obsidian Tampermonkey",scriptMetaStr:this.getScriptMetaStr(t)},r={getValue:async(o,i)=>{let s=`${t.id}:${o}`;return await this.scriptStorage.getValue(s,i)},setValue:async(o,i)=>{let s=`${t.id}:${o}`;await this.scriptStorage.setValue(s,i)},deleteValue:async o=>{let i=`${t.id}:${o}`;await this.scriptStorage.deleteValue(i)},listValues:async()=>{let o=await this.scriptStorage.listValues(),i=`${t.id}:`;return o.filter(s=>s.startsWith(i)).map(s=>s.substring(i.length))}};return{GM_info:n,GM_getValue:(o,i)=>localStorage.getItem(`tampermonkey:${t.id}:${o}`)||i,GM_setValue:(o,i)=>{localStorage.setItem(`tampermonkey:${t.id}:${o}`,i),r.setValue(o,i)},GM_deleteValue:o=>{localStorage.removeItem(`tampermonkey:${t.id}:${o}`),r.deleteValue(o)},GM_listValues:()=>{let o=[],i=`tampermonkey:${t.id}:`;for(let s=0;s<localStorage.length;s++){let a=localStorage.key(s);a&&a.startsWith(i)&&o.push(a.substring(i.length))}return o},GM_getResourceText:o=>{console.log(`Tampermonkey: \u83B7\u53D6\u8D44\u6E90\u6587\u672C ${o}`);try{let s=t.resources.reduce((c,h)=>(c[h.name]=h.url,c),{})[o];if(!s)return console.warn(`Tampermonkey: \u8D44\u6E90 ${o} \u672A\u627E\u5230`),"";let a=`tampermonkey_resource:${t.id}:${o}`,l=localStorage.getItem(a);return l?(console.log(`Tampermonkey: \u4F7F\u7528\u7F13\u5B58\u7684\u8D44\u6E90 ${o}`),l):(console.log(`Tampermonkey: \u8D44\u6E90${o}\u672A\u7F13\u5B58\uFF0C\u542F\u52A8\u540E\u53F0\u52A0\u8F7D`),setTimeout(()=>{fetch(s).then(c=>{if(!c.ok)throw new Error(`\u83B7\u53D6\u8D44\u6E90\u5931\u8D25: ${c.status} ${c.statusText}`);return c.text()}).then(c=>{try{localStorage.setItem(a,c),console.log(`Tampermonkey: \u5DF2\u7F13\u5B58\u8D44\u6E90 ${o} \u4F9B\u4E0B\u6B21\u4F7F\u7528`)}catch(h){console.warn("Tampermonkey: \u65E0\u6CD5\u7F13\u5B58\u8D44\u6E90\uFF0C\u53EF\u80FD\u8D85\u51FA\u5B58\u50A8\u9650\u5236",h)}}).catch(c=>{console.error(`Tampermonkey: \u540E\u53F0\u83B7\u53D6\u8D44\u6E90 ${o} \u5931\u8D25:`,c)})},0),"")}catch(i){return console.error(`Tampermonkey: \u83B7\u53D6\u8D44\u6E90 ${o} \u5931\u8D25:`,i),""}},GM_getResourceURL:o=>{try{let s=t.resources.reduce((a,l)=>(a[l.name]=l.url,a),{})[o];return s||(console.warn(`Tampermonkey: \u8D44\u6E90 ${o} \u672A\u627E\u5230`),"")}catch(i){return console.error(`Tampermonkey: \u83B7\u53D6\u8D44\u6E90URL ${o} \u5931\u8D25:`,i),""}},GM_addStyle:o=>{try{let i=document.createElement("style");i.textContent=o,i.setAttribute("data-tampermonkey-style",t.id),document.head.appendChild(i)}catch(i){console.error("Tampermonkey: \u6DFB\u52A0\u6837\u5F0F\u5931\u8D25:",i)}},GM_registerMenuCommand:(o,i,s)=>{try{let a=Date.now()+Math.floor(Math.random()*1e3),l=`tampermonkey_commands:${t.id}`,c=[];try{let d=localStorage.getItem(l);d&&(c=JSON.parse(d))}catch(d){console.error("\u89E3\u6790\u4FDD\u5B58\u7684\u547D\u4EE4\u5931\u8D25:",d)}c.push({id:a,name:o,accessKey:s||""}),localStorage.setItem(l,JSON.stringify(c)),document.addEventListener(`tampermonkey-run-command-${a}`,()=>{try{i()}catch(d){console.error(`Tampermonkey: \u6267\u884C\u547D\u4EE4 "${o}" \u5931\u8D25:`,d)}});let h=new CustomEvent("tampermonkey-command-registered",{detail:{scriptId:t.id,commandId:a,name:o}});return document.dispatchEvent(h),console.log(`Tampermonkey: \u5DF2\u6CE8\u518C\u83DC\u5355\u547D\u4EE4 "${o}"`),a}catch(a){return console.error(`Tampermonkey: \u6CE8\u518C\u83DC\u5355\u547D\u4EE4 "${o}" \u5931\u8D25:`,a),-1}},GM_unregisterMenuCommand:o=>{try{let i=`tampermonkey_commands:${t.id}`,s=[];try{let l=localStorage.getItem(i);l&&(s=JSON.parse(l),s=s.filter(c=>c.id!==o),localStorage.setItem(i,JSON.stringify(s)))}catch(l){console.error("\u89E3\u6790\u4FDD\u5B58\u7684\u547D\u4EE4\u5931\u8D25:",l)}document.removeEventListener(`tampermonkey-run-command-${o}`,()=>{});let a=new CustomEvent("tampermonkey-command-unregistered",{detail:{scriptId:t.id,commandId:o}});document.dispatchEvent(a),console.log(`Tampermonkey: \u5DF2\u6CE8\u9500\u83DC\u5355\u547D\u4EE4 ID ${o}`)}catch(i){console.error(`Tampermonkey: \u6CE8\u9500\u83DC\u5355\u547D\u4EE4 ID ${o} \u5931\u8D25:`,i)}},GM_xmlhttpRequest:o=>{console.log(`Tampermonkey: \u6267\u884CxmlhttpRequest ${o.url}`);try{let i=new AbortController,s=i.signal,a={method:o.method||"GET",signal:s,credentials:o.withCredentials?"include":"same-origin"};o.headers&&(a.headers=o.headers),o.data&&(a.body=o.data);let l={abort:()=>{i.abort()}};return fetch(o.url,a).then(async c=>{let h="";if(c.headers)if(typeof c.headers.forEach=="function"){let y=[];c.headers.forEach((p,f)=>{y.push(`${f}: ${p}`)}),h=y.join(`
`)}else h=c.headers.toString();let d=await c.text();o.onload&&typeof o.onload=="function"&&o.onload({finalUrl:c.url,readyState:4,status:c.status,statusText:c.statusText,responseHeaders:h,responseText:d,response:d})}).catch(c=>{if(c.name==="AbortError"&&o.onabort){o.onabort();return}o.onerror&&typeof o.onerror=="function"&&o.onerror(c)}),l}catch(i){return console.error("Tampermonkey: XMLHttpRequest\u6267\u884C\u5931\u8D25:",i),o.onerror&&typeof o.onerror=="function"&&o.onerror(i),null}},GM_openInTab:(o,i)=>(console.warn("GM_openInTab not fully implemented"),window.open(o,"_blank"),null),GM_setClipboard:(o,i)=>{navigator.clipboard.writeText(o).catch(s=>console.error("Failed to copy text: ",s))},GM_notification:(o,i)=>{console.warn("GM_notification not fully implemented"),alert(typeof o=="string"?o:o.text)},unsafeWindow:window}}createScriptWrapper(t,e){let n=t.resources&&t.resources.some(r=>r.name==="swalStyle");return`
            (function() {
                try {
                    // \u5B9A\u4E49\u57FA\u672C\u7684GM\u4FE1\u606F\u5BF9\u8C61
                    const GM_info = ${JSON.stringify(e.GM_info)};
                    console.log('Tampermonkey: \u51C6\u5907\u6267\u884C\u811A\u672C "${t.name}"', GM_info);
                    
                    // \u5B9A\u4E49GM API\u51FD\u6570
                    const GM_getValue = function(name, defaultValue) {
                        return localStorage.getItem('tampermonkey:${t.id}:' + name) || defaultValue;
                    };
                    
                    const GM_setValue = function(name, value) {
                        localStorage.setItem('tampermonkey:${t.id}:' + name, value);
                    };
                    
                    const GM_deleteValue = function(name) {
                        localStorage.removeItem('tampermonkey:${t.id}:' + name);
                    };
                    
                    const GM_listValues = function() {
                        const keys = [];
                        const prefix = 'tampermonkey:${t.id}:';
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith(prefix)) {
                                keys.push(key.substring(prefix.length));
                            }
                        }
                        return keys;
                    };
                    
                    const GM_addStyle = function(css) {
                        try {
                            const style = document.createElement('style');
                            style.textContent = css;
                            document.head.appendChild(style);
                            return style;
                        } catch(e) {
                            console.error('Tampermonkey: GM_addStyle\u9519\u8BEF', e);
                        }
                    };
                    
                    // \u7B80\u5316\u7248\u7684GM_getResourceText\u51FD\u6570
                    const GM_getResourceText = function(name) {
                        // \u4ECE\u7F13\u5B58\u4E2D\u83B7\u53D6\u8D44\u6E90
                        const cacheKey = 'tampermonkey_resource:${t.id}:' + name;
                        const cachedResource = localStorage.getItem(cacheKey);
                        
                        // \u5982\u679C\u662F\u591C\u95F4\u6A21\u5F0F\u52A9\u624B\u811A\u672C\u8BF7\u6C42swalStyle\uFF0C\u4E14\u662F\u7B2C\u4E00\u6B21\u52A0\u8F7D
                        if (name === 'swalStyle' && !cachedResource && '${t.name}'.includes('\u591C\u95F4\u6A21\u5F0F')) {
                            // \u63D0\u4F9B\u9ED8\u8BA4\u7684SweetAlert\u6837\u5F0F\u4EE5\u907F\u514D\u62A5\u9519
                            return \`
                                .swal2-popup { background: #fff; color: #333; border-radius: 5px; padding: 20px; }
                                .swal2-title { color: #595959; font-size: 1.8em; margin: 0; }
                                .swal2-content { color: #545454; }
                                .swal2-actions { margin-top: 15px; }
                                .swal2-confirm { background: #3085d6; color: #fff; border: 0; border-radius: 3px; padding: 8px 20px; }
                                .swal2-cancel { background: #aaa; color: #fff; border: 0; border-radius: 3px; padding: 8px 20px; margin-left: 10px; }
                                .darkmode-popup { font-size: 14px !important; }
                                .darkmode-center { display: flex; align-items: center; }
                                .darkmode-setting-label { display: flex; align-items: center; justify-content: space-between; padding-top: 15px; }
                                .darkmode-setting-label-col { display: flex; align-items: flex-start; padding-top: 15px; flex-direction: column; }
                                .darkmode-setting-radio { width: 16px; height: 16px; }
                                .darkmode-setting-textarea { width: 100%; margin: 14px 0 0; height: 100px; resize: none; border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; color: #666; line-height: 1.2; }
                                .darkmode-setting-input { border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; width: 100px; }
                            \`;
                        }
                        
                        return cachedResource || '';
                    };
                    
                    // \u63D0\u4F9B\u5176\u4ED6\u5FC5\u8981\u7684GM API\u51FD\u6570
                    const GM_registerMenuCommand = function(name, fn, accessKey) {
                        console.log('Tampermonkey: \u811A\u672C\u6CE8\u518C\u83DC\u5355\u547D\u4EE4:', name);
                        // \u5B58\u50A8\u547D\u4EE4\u5230\u672C\u5730\u5B58\u50A8
                        const commandId = Date.now() + Math.floor(Math.random() * 1000);
                        const commandsKey = 'tampermonkey_commands:${t.id}';
                        let commands = [];
                        try {
                            const savedCommands = localStorage.getItem(commandsKey);
                            if (savedCommands) {
                                commands = JSON.parse(savedCommands);
                            }
                        } catch (e) {}
                        
                        commands.push({
                            id: commandId,
                            name: name,
                            accessKey: accessKey || ''
                        });
                        
                        localStorage.setItem(commandsKey, JSON.stringify(commands));
                        
                        // \u5728\u9875\u9762\u4E2D\u521B\u5EFA\u6309\u94AE
                        setTimeout(function() {
                            try {
                                // \u68C0\u67E5\u662F\u5426\u5DF2\u7ECF\u6709\u83DC\u5355\u5BB9\u5668
                                let menuContainer = document.getElementById('tampermonkey-menu-container');
                                if (!menuContainer) {
                                    // \u521B\u5EFA\u83DC\u5355\u5BB9\u5668
                                    menuContainer = document.createElement('div');
                                    menuContainer.id = 'tampermonkey-menu-container';
                                    menuContainer.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; display: none; background: white; border: 1px solid #ccc; border-radius: 5px; padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
                                    document.body.appendChild(menuContainer);
                                    
                                    // \u521B\u5EFA\u83DC\u5355\u56FE\u6807
                                    const menuIcon = document.createElement('div');
                                    menuIcon.id = 'tampermonkey-menu-icon';
                                    menuIcon.innerHTML = '<svg width="24" height="24" viewBox="0 0 512 512"><path fill="currentColor" d="M108.12 0L0 108.12v295.76L108.12 512h295.76L512 403.88V108.12L403.88 0zm71.84 107.25c9.02 0 16.56 7.54 16.56 16.56v49h58.07c9.02 0 16.56 7.54 16.56 16.56v87.19c0 9.02-7.54 16.56-16.56 16.56h-58.07v52c0 9.02-7.54 16.56-16.56 16.56h-127c-9.02 0-16.56-7.54-16.56-16.56v-52h-58.07c-9.02 0-16.56-7.54-16.56-16.56v-87.19c0-9.02 7.54-16.56 16.56-16.56h58.07v-49c0-9.02 7.54-16.56 16.56-16.56z"/></svg>';
                                    menuIcon.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 10000; cursor: pointer; width: 24px; height: 24px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);';
                                    document.body.appendChild(menuIcon);
                                    
                                    // \u6DFB\u52A0\u70B9\u51FB\u4E8B\u4EF6
                                    menuIcon.addEventListener('click', function() {
                                        if (menuContainer.style.display === 'none') {
                                            menuContainer.style.display = 'block';
                                        } else {
                                            menuContainer.style.display = 'none';
                                        }
                                    });
                                }
                                
                                // \u6DFB\u52A0\u547D\u4EE4\u6309\u94AE
                                const commandButton = document.createElement('button');
                                commandButton.textContent = name;
                                commandButton.style.cssText = 'display: block; width: 100%; margin: 5px 0; padding: 5px 10px; border: none; background: #f0f0f0; border-radius: 3px; cursor: pointer;';
                                commandButton.addEventListener('click', function() {
                                    menuContainer.style.display = 'none';
                                    try {
                                        fn();
                                    } catch(e) {
                                        console.error('Tampermonkey: \u6267\u884C\u547D\u4EE4\u5931\u8D25', e);
                                    }
                                });
                                menuContainer.appendChild(commandButton);
                            } catch(e) {
                                console.error('Tampermonkey: \u521B\u5EFA\u83DC\u5355\u9879\u5931\u8D25', e);
                            }
                        }, 500);
                        
                        return commandId;
                    };
                    
                    const GM_xmlhttpRequest = function(details) {
                        try {
                            if (!details.url) {
                                throw new Error('URL is required for GM_xmlhttpRequest');
                            }
                            
                            // \u4F7F\u7528fetch API\u5B9E\u73B0
                            const fetchInit = {
                                method: details.method || 'GET',
                                headers: details.headers || {},
                                body: details.data || null,
                                credentials: details.withCredentials ? 'include' : 'same-origin'
                            };
                            
                            fetch(details.url, fetchInit)
                                .then(function(response) {
                                    if (!response.ok && details.onerror) {
                                        details.onerror(response);
                                        return;
                                    }
                                    
                                    return response.text().then(function(responseText) {
                                        if (details.onload) {
                                            details.onload({
                                                responseText: responseText,
                                                status: response.status,
                                                statusText: response.statusText,
                                                readyState: 4,
                                                finalUrl: response.url,
                                                responseHeaders: Array.from(response.headers).map(pair => pair.join(': ')).join('\\n')
                                            });
                                        }
                                    });
                                })
                                .catch(function(error) {
                                    if (details.onerror) {
                                        details.onerror(error);
                                    }
                                });
                            
                            // \u8FD4\u56DE\u4E00\u4E2A\u6A21\u62DF\u7684XMLHttpRequest\u5BF9\u8C61\uFF0C\u5E26\u6709abort\u65B9\u6CD5
                            return { abort: function() { console.log('Request aborted'); } };
                        } catch(e) {
                            console.error('Tampermonkey: GM_xmlhttpRequest\u9519\u8BEF', e);
                            if (details.onerror) {
                                details.onerror(e);
                            }
                        }
                    };
                    
                    // \u6DFB\u52A0\u5176\u4ED6GM\u51FD\u6570
                    const unsafeWindow = window;
                    
                    // \u5B9E\u73B0\u591C\u95F4\u6A21\u5F0F\u52A9\u624B\u811A\u672C\u9700\u8981\u7684\u7279\u6B8A\u5904\u7406
                    if ('${t.name}'.includes('\u591C\u95F4\u6A21\u5F0F')) {
                        // \u9884\u5148\u6DFB\u52A0\u591C\u95F4\u6A21\u5F0F\u6240\u9700\u8D44\u6E90
                        window.Swal = window.Swal || {
                            fire: function(options) {
                                alert(options.title || 'Message');
                                return Promise.resolve({isConfirmed: true});
                            }
                        };
                    }
                    
                    // \u6267\u884C\u5B9E\u9645\u811A\u672C
${t.source}
                } catch(e) {
                    console.error('Tampermonkey: \u811A\u672C\u6267\u884C\u9519\u8BEF', e);
                }
            })();
        `}getScriptMetaStr(t){let e=[];return e.push("// ==UserScript=="),t.name&&e.push(`// @name ${t.name}`),t.namespace&&e.push(`// @namespace ${t.namespace}`),t.version&&e.push(`// @version ${t.version}`),t.description&&e.push(`// @description ${t.description}`),t.author&&e.push(`// @author ${t.author}`),t.homepage&&e.push(`// @homepage ${t.homepage}`),t.icon&&e.push(`// @icon ${t.icon}`),t.includes.forEach(n=>{e.push(`// @include ${n}`)}),t.matches.forEach(n=>{e.push(`// @match ${n}`)}),t.excludes.forEach(n=>{e.push(`// @exclude ${n}`)}),t.requires.forEach(n=>{e.push(`// @require ${n}`)}),t.resources.forEach(n=>{e.push(`// @resource ${n.name} ${n.url}`)}),t.runAt&&e.push(`// @run-at ${t.runAt}`),e.push("// ==/UserScript=="),e.join(`
`)}injectContentLoadedListener(t,e,n){n.length!==0&&(t instanceof HTMLIFrameElement?this.injectContentLoadedListenerForIframe(t,e,n):t.tagName==="WEBVIEW"&&this.injectContentLoadedListenerForWebView(t,e,n))}injectContentLoadedListenerForIframe(t,e,n){try{if(!t.contentWindow||!t.contentDocument){console.warn("\u65E0\u6CD5\u8BBF\u95EEiframe\u5185\u5BB9\u6765\u8BBE\u7F6EDOMContentLoaded\u76D1\u542C\u5668");let r=setInterval(()=>{try{t.contentDocument&&t.contentDocument.readyState==="interactive"&&(clearInterval(r),n.forEach(o=>this.injectScript(t,e,o)))}catch(o){clearInterval(r)}},100);setTimeout(()=>clearInterval(r),1e4);return}t.contentDocument.readyState==="loading"?t.contentDocument.addEventListener("DOMContentLoaded",async()=>{for(let r of n)await this.injectScript(t,e,r)}):n.forEach(r=>this.injectScript(t,e,r))}catch(r){console.error("\u8BBE\u7F6Eiframe\u7684DOMContentLoaded\u76D1\u542C\u5668\u5931\u8D25:",r),n.forEach(o=>this.injectScript(t,e,o))}}injectContentLoadedListenerForWebView(t,e,n){let r=`
            if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                    window.dispatchEvent(new CustomEvent('obsidian-tampermonkey-domcontentloaded'));
                });
            } else {
                // \u6587\u6863\u5DF2\u52A0\u8F7D\uFF0C\u7ACB\u5373\u89E6\u53D1\u4E8B\u4EF6
                window.dispatchEvent(new CustomEvent('obsidian-tampermonkey-domcontentloaded'));
            }
        `;this.executeScript(t,r);let o=i=>{n.forEach(s=>this.injectScript(t,e,s))};t.addEventListener("obsidian-tampermonkey-domcontentloaded",o),setTimeout(()=>{t.removeEventListener("obsidian-tampermonkey-domcontentloaded",o)},1e4)}injectLoadListener(t,e,n){n.length!==0&&(t instanceof HTMLIFrameElement?this.injectLoadListenerForIframe(t,e,n):t.tagName==="WEBVIEW"&&this.injectLoadListenerForWebView(t,e,n))}injectLoadListenerForIframe(t,e,n){try{t.addEventListener("load",async()=>{for(let r of n)await this.injectScript(t,e,r)}),t.contentDocument&&t.contentDocument.readyState==="complete"&&n.forEach(r=>this.injectScript(t,e,r))}catch(r){console.error("\u8BBE\u7F6Eiframe\u7684load\u76D1\u542C\u5668\u5931\u8D25:",r),setTimeout(()=>{n.forEach(o=>this.injectScript(t,e,o))},1e3)}}injectLoadListenerForWebView(t,e,n){let r=`
            if (document.readyState === 'complete') {
                // \u9875\u9762\u5DF2\u5B8C\u5168\u52A0\u8F7D\uFF0C\u7ACB\u5373\u89E6\u53D1\u4E8B\u4EF6
                window.dispatchEvent(new CustomEvent('obsidian-tampermonkey-load'));
            } else {
                // \u7B49\u5F85\u9875\u9762\u52A0\u8F7D\u5B8C\u6210
            window.addEventListener('load', function() {
                window.dispatchEvent(new CustomEvent('obsidian-tampermonkey-load'));
            });
            }
        `;this.executeScript(t,r);let o=i=>{n.forEach(s=>this.injectScript(t,e,s))};t.addEventListener("obsidian-tampermonkey-load",o),setTimeout(()=>{t.removeEventListener("obsidian-tampermonkey-load",o)},1e4)}executeScript(t,e){try{t instanceof HTMLIFrameElement?this.executeScriptInIframe(t,e):t.tagName==="WEBVIEW"?this.executeScriptInWebView(t,e):console.warn("\u4E0D\u652F\u6301\u7684webview\u7C7B\u578B:",t.tagName)}catch(n){console.error("\u6267\u884C\u811A\u672C\u65F6\u51FA\u9519:",n)}}executeScriptInIframe(t,e){var n;try{if(!t.contentWindow||!t.contentDocument){console.warn("Tampermonkey: \u65E0\u6CD5\u8BBF\u95EEiframe\u5185\u5BB9\uFF0C\u53EF\u80FD\u662F\u8DE8\u57DF\u9650\u5236"),this.tryExecuteViaURL(t,e);return}try{let r=t.contentDocument.createElement("script");r.textContent=e,r.setAttribute("data-tampermonkey","true"),r.setAttribute("type","text/javascript"),console.log("Tampermonkey: \u6B63\u5728\u6CE8\u5165\u811A\u672C\u5230iframe"),t.contentDocument.head?(t.contentDocument.head.appendChild(r),console.log("Tampermonkey: \u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe head")):t.contentDocument.documentElement?(t.contentDocument.documentElement.appendChild(r),console.log("Tampermonkey: \u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe documentElement")):((n=t.contentDocument.body)==null||n.appendChild(r),console.log("Tampermonkey: \u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe body"))}catch(r){console.error("Tampermonkey: \u901A\u8FC7DOM\u65B9\u5F0F\u6CE8\u5165\u811A\u672C\u5931\u8D25:",r),this.tryExecuteViaEval(t,e)}}catch(r){console.error("Tampermonkey: \u65E0\u6CD5\u5728iframe\u4E2D\u6267\u884C\u811A\u672C\uFF0C\u53EF\u80FD\u662F\u8DE8\u57DF\u9650\u5236:",r),this.tryExecuteViaURL(t,e)}}tryExecuteViaEval(t,e){try{if(t.contentWindow){console.log("Tampermonkey: \u5C1D\u8BD5\u901A\u8FC7eval\u65B9\u5F0F\u6267\u884C\u811A\u672C");try{let r=new Function(`
                        try {
                            if (window.frames[0] && window.frames[0].document) {
                                var script = window.frames[0].document.createElement("script");
                                script.textContent = ${JSON.stringify(e)};
                                window.frames[0].document.head.appendChild(script);
                                return true;
                            }
                        } catch(e) {
                            console.error("Injection error:", e);
                            return false;
                        }
                    `)();console.log("Tampermonkey: \u901A\u8FC7Function\u6784\u9020\u5668\u6CE8\u5165\u811A\u672C"+(r?"\u6210\u529F":"\u5931\u8D25"))}catch(n){console.error("Tampermonkey: Function\u6784\u9020\u5668\u6267\u884C\u5931\u8D25",n)}}}catch(n){console.error("Tampermonkey: \u901A\u8FC7eval\u6267\u884C\u811A\u672C\u5931\u8D25:",n)}}tryExecuteViaURL(t,e){try{console.log("Tampermonkey: \u5C1D\u8BD5\u901A\u8FC7URL\u65B9\u5F0F\u6CE8\u5165\u811A\u672C");let n=new Blob([e],{type:"text/javascript"}),r=URL.createObjectURL(n),o;try{t.contentDocument?o=t.contentDocument.createElement("script"):o=document.createElement("script")}catch(i){o=document.createElement("script")}o.src=r,o.type="text/javascript",o.setAttribute("data-tampermonkey","true");try{if(t.contentDocument&&t.contentDocument.head)t.contentDocument.head.appendChild(o),console.log("Tampermonkey: \u901A\u8FC7Blob URL\u6CE8\u5165\u811A\u672C\u5230head\u6210\u529F");else if(t.contentDocument&&t.contentDocument.body)t.contentDocument.body.appendChild(o),console.log("Tampermonkey: \u901A\u8FC7Blob URL\u6CE8\u5165\u811A\u672C\u5230body\u6210\u529F");else{let i=`<script src="${r}" type="text/javascript" data-tampermonkey="true"><\/script>`,s=document.createElement("iframe");s.style.display="none",s.onload=function(){var a;try{let l=s.contentDocument||((a=s.contentWindow)==null?void 0:a.document);l&&(l.open(),l.write(i),l.close(),console.log("Tampermonkey: \u901A\u8FC7\u6CE8\u5165iframe\u6267\u884C\u811A\u672C\u6210\u529F"))}catch(l){console.error("Tampermonkey: iframe\u6CE8\u5165\u5931\u8D25:",l)}},document.body.appendChild(s),console.log("Tampermonkey: \u521B\u5EFA\u6CE8\u5165\u7528iframe\u6210\u529F")}}catch(i){console.error("Tampermonkey: \u65E0\u6CD5\u901A\u8FC7Blob URL\u65B9\u5F0F\u6CE8\u5165:",i)}setTimeout(()=>URL.revokeObjectURL(r),5e3)}catch(n){console.error("Tampermonkey: \u901A\u8FC7URL\u6CE8\u5165\u5C1D\u8BD5\u5931\u8D25:",n)}}executeScriptInWebView(t,e){console.log("Tampermonkey: \u5C1D\u8BD5\u5728webview\u4E2D\u6267\u884C\u811A\u672C");try{let n=t;if(typeof n.executeJavaScript=="function"){console.log("Tampermonkey: \u4F7F\u7528executeJavaScript\u6CE8\u5165\u811A\u672C"),n.executeJavaScript(e).then(()=>console.log("Tampermonkey: \u811A\u672C\u5DF2\u901A\u8FC7executeJavaScript\u6CE8\u5165")).catch(r=>console.error("Tampermonkey: executeJavaScript\u6267\u884C\u5931\u8D25:",r));return}}catch(n){console.warn("Tampermonkey: \u4E0D\u652F\u6301executeJavaScript:",n)}try{if(t.contentWindow){let r=t.contentWindow.document;console.log("Tampermonkey: \u5C1D\u8BD5\u901A\u8FC7contentWindow\u6CE8\u5165\u811A\u672C");let o=r.createElement("script");o.textContent=e,o.setAttribute("data-tampermonkey","true"),r.head.appendChild(o),console.log("Tampermonkey: \u901A\u8FC7contentWindow\u6CE8\u5165\u6210\u529F");return}}catch(n){console.warn("Tampermonkey: \u65E0\u6CD5\u901A\u8FC7contentWindow\u6CE8\u5165:",n)}try{if(t.contentDocument){let n=t.contentDocument;console.log("Tampermonkey: \u5C1D\u8BD5\u901A\u8FC7contentDocument\u6CE8\u5165\u811A\u672C");let r=n.createElement("script");r.textContent=e,r.setAttribute("data-tampermonkey","true"),n.head.appendChild(r),console.log("Tampermonkey: \u901A\u8FC7contentDocument\u6CE8\u5165\u6210\u529F");return}}catch(n){console.warn("Tampermonkey: \u65E0\u6CD5\u901A\u8FC7contentDocument\u6CE8\u5165:",n)}console.warn("Tampermonkey: \u5C1D\u8BD5\u66FF\u4EE3\u65B9\u6CD5\u6CE8\u5165\u811A\u672C");try{let n=new CustomEvent("obsidian-tampermonkey-inject",{detail:{script:e}});t.dispatchEvent(n),console.log("Tampermonkey: \u5DF2\u53D1\u9001\u811A\u672C\u6CE8\u5165\u4E8B\u4EF6\u5230webview")}catch(n){console.error("Tampermonkey: \u4E8B\u4EF6\u6D3E\u53D1\u5931\u8D25:",n)}}};var L=class extends g.Plugin{async onload(){console.log("Loading Tampermonkey plugin"),this.scriptStorage=new T(this),this.scriptManager=new b,this.scriptInjector=new w(this.scriptStorage),await this.loadSettings(),this.settingTab=new k(this.app,this),this.addSettingTab(this.settingTab),this.scriptManager.loadScripts(this.settings.scripts),this.registerScriptManagerEvents(),this.registerWebviewHandlers(),(0,g.addIcon)("tampermonkey",`<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
            <path fill="currentColor" d="M 108.11719 0 L 0 108.11914 L 0 403.88086 L 108.11719 512 L 403.88281 512 L 512 403.88086 L 512 108.11914 L 403.88281 0 L 108.11719 0 z M 196.56055 128 L 315.43945 128 C 324.4555 128 332 135.5445 332 144.56055 L 332 196.56055 L 384 196.56055 C 393.0161 196.56055 400.56055 204.10499 400.56055 213.12109 L 400.56055 298.87891 C 400.56055 307.89501 393.0161 315.43945 384 315.43945 L 332 315.43945 L 332 367.43945 C 332 376.4555 324.4555 384 315.43945 384 L 196.56055 384 C 187.5445 384 180 376.4555 180 367.43945 L 180 315.43945 L 128 315.43945 C 118.98389 315.43945 111.43945 307.89501 111.43945 298.87891 L 111.43945 213.12109 C 111.43945 204.10499 118.98389 196.56055 128 196.56055 L 180 196.56055 L 180 144.56055 C 180 135.5445 187.5445 128 196.56055 128 z"/>
        </svg>`);let e=this.addRibbonIcon("tampermonkey","Tampermonkey",n=>{let r=this.scriptManager.getAllScripts().filter(o=>o.enabled);if(r.length>0){let o=r.map(i=>`- ${i.name}`).join(`
`);new g.Notice(`\u5F53\u524D\u542F\u7528\u7684\u811A\u672C (${r.length}):
${o}`)}else new g.Notice("\u5F53\u524D\u6CA1\u6709\u542F\u7528\u7684\u811A\u672C");this.openSettings()});this.editScriptHandler=n=>{var i;let o=(i=n.detail)==null?void 0:i.scriptId;o&&this.openScriptEditor(o)},this.createScriptHandler=n=>{var i;let o=(i=n.detail)==null?void 0:i.url;o&&this.createScriptForUrl(o)},document.addEventListener("tampermonkey-edit-script",this.editScriptHandler),document.addEventListener("tampermonkey-create-script",this.createScriptHandler)}onunload(){console.log("Unloading Tampermonkey plugin"),document.removeEventListener("tampermonkey-edit-script",this.editScriptHandler),document.removeEventListener("tampermonkey-create-script",this.createScriptHandler)}async loadSettings(){this.settings=Object.assign({},U,await this.loadData())}async saveSettings(){this.settings.scripts=this.scriptManager.getAllScripts(),await this.saveData(this.settings)}openSettings(){if(this.app.setting){this.app.setting.open();try{this.app.setting.openTabById("obsidian-tampermonkey")}catch(e){console.warn("\u65E0\u6CD5\u76F4\u63A5\u6253\u5F00Tampermonkey\u8BBE\u7F6E\u6807\u7B7E\uFF0C\u5C06\u6253\u5F00\u901A\u7528\u8BBE\u7F6E\u9875\u9762")}}else new g.Notice("\u65E0\u6CD5\u6253\u5F00\u8BBE\u7F6E\uFF0C\u8BF7\u4ECEObsidian\u8BBE\u7F6E\u4E2D\u627E\u5230Tampermonkey\u6807\u7B7E")}openScriptEditor(e){let n=this.scriptManager.getScript(e);n&&(this.openSettings(),new g.Notice(`\u6B63\u5728\u6253\u5F00\u811A\u672C "${n.name}" \u8FDB\u884C\u7F16\u8F91`))}createScriptForUrl(e){if(!e)return;let n=new URL(e).hostname,r=`// ==UserScript==
// @name         \u9488\u5BF9 ${n} \u7684\u811A\u672C
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  \u4E3A ${n} \u6DFB\u52A0\u529F\u80FD
// @author       You
// @match        ${e}
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    
    // \u5728\u6B64\u5904\u6DFB\u52A0\u60A8\u7684\u4EE3\u7801...
    console.log('Tampermonkey\u811A\u672C\u5DF2\u542F\u52A8!');
})();`;try{let o=this.scriptManager.addScript(r);new g.Notice(`\u5DF2\u4E3A ${n} \u521B\u5EFA\u65B0\u811A\u672C`),this.openScriptEditor(o.id)}catch(o){console.error("\u521B\u5EFA\u811A\u672C\u5931\u8D25:",o),new g.Notice("\u521B\u5EFA\u811A\u672C\u5931\u8D25\uFF0C\u8BF7\u67E5\u770B\u63A7\u5236\u53F0")}}registerScriptManagerEvents(){this.scriptManager.on("onScriptAdded",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptRemoved",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptUpdated",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptEnabled",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptDisabled",async()=>{await this.saveSettings()})}registerWebviewHandlers(){this.registerEvent(this.app.workspace.on("layout-change",()=>{this.checkForWebViews()})),this.checkForWebViews(),this.registerEvent(this.app.workspace.on("active-leaf-change",e=>{e&&this.handlePotentialWebViewLeaf(e)}))}checkForWebViews(){this.app.workspace.iterateAllLeaves(e=>{this.handlePotentialWebViewLeaf(e)})}handlePotentialWebViewLeaf(e){!e||!e.view||setTimeout(()=>{let n=e.view.containerEl;if(!n)return;n.querySelectorAll("iframe, webview").forEach(o=>{(o instanceof HTMLIFrameElement||o instanceof HTMLElement)&&this.setupWebViewListeners(o)})},500)}setupWebViewListeners(e){if(!e.hasAttribute("data-tampermonkey-processed"))if(e.setAttribute("data-tampermonkey-processed","true"),console.log("Tampermonkey: Webview detected",e.tagName),e instanceof HTMLIFrameElement){console.log("Tampermonkey: \u5904\u7406iframe\u5143\u7D20");let n="";try{n=e.src}catch(r){console.warn("Tampermonkey: \u65E0\u6CD5\u8BFB\u53D6iframe\u7684src\u5C5E\u6027",r),n=e.getAttribute("src")||""}e.addEventListener("load",()=>{try{let r="";try{r=e.src}catch(o){r=e.getAttribute("src")||""}r&&(console.log("Tampermonkey: iframe\u52A0\u8F7D\u5B8C\u6210\uFF0C\u6CE8\u5165\u811A\u672C\u5230",r),this.injectScriptsForUrl(e,r))}catch(r){console.error("Tampermonkey: \u5904\u7406iframe load\u4E8B\u4EF6\u51FA\u9519",r)}}),n&&(console.log("Tampermonkey: \u7ACB\u5373\u6CE8\u5165\u811A\u672C\u5230iframe:",n),this.injectScriptsForUrl(e,n))}else if(e.tagName==="WEBVIEW"||e.tagName==="IFRAME"){console.log("Tampermonkey: \u5904\u7406webview\u5143\u7D20");let n=e.getAttribute("src")||"";try{e.addEventListener("did-navigate",r=>{try{let o=r.url||e.getAttribute("src")||"";o&&(console.log("Tampermonkey: webview\u5BFC\u822A\u5230",o),this.injectScriptsForUrl(e,o))}catch(o){console.error("Tampermonkey: \u5904\u7406webview\u5BFC\u822A\u4E8B\u4EF6\u51FA\u9519",o)}}),e.addEventListener("load",()=>{try{let r=e.getAttribute("src")||"";r&&(console.log("Tampermonkey: webview\u52A0\u8F7D\u5B8C\u6210",r),this.injectScriptsForUrl(e,r))}catch(r){console.error("Tampermonkey: \u5904\u7406webview load\u4E8B\u4EF6\u51FA\u9519",r)}})}catch(r){console.warn("Tampermonkey: \u6DFB\u52A0webview\u4E8B\u4EF6\u76D1\u542C\u5668\u5931\u8D25",r)}n&&(console.log("Tampermonkey: \u7ACB\u5373\u6CE8\u5165\u811A\u672C\u5230webview:",n),setTimeout(()=>{this.injectScriptsForUrl(e,n)},500))}else console.log("Tampermonkey: \u5904\u7406\u672A\u77E5\u5143\u7D20\uFF0C\u67E5\u627E\u5185\u90E8iframe"),e.querySelectorAll("iframe, webview").forEach(r=>{r instanceof HTMLElement&&(console.log("Tampermonkey: \u627E\u5230\u5185\u90E8webview\u5143\u7D20"),this.setupWebViewListeners(r))})}injectScriptsForUrl(e,n){let r=this.scriptManager.findScriptsForUrl(n);r.length>0&&(console.log(`Tampermonkey: Found ${r.length} scripts for ${n}`),this.scriptInjector.injectScripts(e,n,r))}loadStyles(){document.body.classList.add("tampermonkey-enabled");let e=document.createElement("style");e.id="tampermonkey-ui-styles",e.textContent=`
            .tampermonkey-browser-ui {
                z-index: 9;
                opacity: 0.7;
                transition: opacity 0.3s ease;
            }
            
            .tampermonkey-browser-ui:hover {
                opacity: 1;
            }
            
            .tampermonkey-icon {
                opacity: 0.8;
                transition: all 0.2s ease;
                box-shadow: 0 0 5px rgba(0,0,0,0.1);
            }
            
            .tampermonkey-icon:hover {
                background-color: var(--interactive-hover) !important;
                transform: scale(1.1);
                opacity: 1;
            }
            
            .tampermonkey-menu {
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }
        `,document.head.appendChild(e)}};
