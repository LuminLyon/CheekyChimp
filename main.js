/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository
*/

var $=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var q=(y,t)=>{for(var e in t)$(y,e,{get:t[e],enumerable:!0})},z=(y,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of O(t))!N.call(y,r)&&r!==e&&$(y,r,{get:()=>t[r],enumerable:!(n=W(t,r))||n.enumerable});return y};var K=y=>z($({},"__esModule",{value:!0}),y);var J={};q(J,{default:()=>I});module.exports=K(J);var C=require("obsidian");var p=require("obsidian"),B={scripts:[],automaticallyCheckForUpdates:!0,updateInterval:24,debug:!1},k=class extends p.PluginSettingTab{constructor(e,n){super(e,n);this.plugin=n}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"CheekyChimp \u8BBE\u7F6E"}),e.createEl("p",{text:"\u8FD9\u4E2A\u63D2\u4EF6\u5141\u8BB8\u4F60\u5728Obsidian\u7684\u5185\u90E8\u6D4F\u89C8\u5668\u4E2D\u4F7F\u7528\u7528\u6237\u811A\u672C\u3002"}),e.createEl("h3",{text:"\u5E38\u89C4\u8BBE\u7F6E"}),new p.Setting(e).setName("\u81EA\u52A8\u68C0\u67E5\u66F4\u65B0").setDesc("\u5B9A\u671F\u68C0\u67E5\u7528\u6237\u811A\u672C\u7684\u66F4\u65B0").addToggle(r=>r.setValue(this.plugin.settings.automaticallyCheckForUpdates).onChange(async i=>{this.plugin.settings.automaticallyCheckForUpdates=i,await this.plugin.saveSettings()})),new p.Setting(e).setName("\u66F4\u65B0\u68C0\u67E5\u95F4\u9694").setDesc("\u68C0\u67E5\u811A\u672C\u66F4\u65B0\u7684\u95F4\u9694(\u5C0F\u65F6)").addSlider(r=>r.setLimits(1,168,1).setValue(this.plugin.settings.updateInterval).setDynamicTooltip().onChange(async i=>{this.plugin.settings.updateInterval=i,await this.plugin.saveSettings()})),new p.Setting(e).setName("\u8C03\u8BD5\u6A21\u5F0F").setDesc("\u542F\u7528\u8C03\u8BD5\u65E5\u5FD7").addToggle(r=>r.setValue(this.plugin.settings.debug).onChange(async i=>{this.plugin.settings.debug=i,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u811A\u672C\u7BA1\u7406"}),new p.Setting(e).setName("\u5BFC\u5165\u811A\u672C").setDesc("\u4ECE\u6587\u4EF6\u5BFC\u5165\u7528\u6237\u811A\u672C").addButton(r=>r.setButtonText("\u5BFC\u5165").setCta().onClick(i=>{this.importScript(i)})),new p.Setting(e).setName("\u521B\u5EFA\u65B0\u811A\u672C").setDesc("\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u7528\u6237\u811A\u672C").addButton(r=>r.setButtonText("\u521B\u5EFA").setCta().onClick(()=>{this.createScript()})),e.createEl("h3",{text:"\u5DF2\u5B89\u88C5\u7684\u811A\u672C"});let n=e.createDiv({cls:"cheekychimp-script-list"});this.plugin.settings.scripts.length===0?n.createEl("p",{text:'\u6CA1\u6709\u5DF2\u5B89\u88C5\u7684\u7528\u6237\u811A\u672C\u3002\u70B9\u51FB\u4E0A\u65B9\u7684"\u5BFC\u5165"\u6216"\u521B\u5EFA"\u6309\u94AE\u6765\u6DFB\u52A0\u811A\u672C\u3002'}):this.plugin.settings.scripts.forEach(r=>{this.createScriptItem(n,r)})}createScriptItem(e,n){let r=e.createDiv({cls:"cheekychimp-script-item"}),i=r.createDiv({cls:"cheekychimp-script-enabled"}),a=new p.Setting(i).setName("").addToggle(s=>s.setValue(n.enabled).onChange(async l=>{l?this.plugin.scriptManager.enableScript(n.id):this.plugin.scriptManager.disableScript(n.id),await this.plugin.saveSettings()})),c=r.createDiv({cls:"cheekychimp-script-name"}),u=c.createEl("div",{text:n.name,cls:"cheekychimp-script-name-text"});u.addEventListener("dblclick",()=>{let s=document.createElement("input");s.type="text",s.value=n.name,s.className="cheekychimp-script-name-edit",s.style.width="100%",u.replaceWith(s),s.focus(),s.select();let l=async()=>{let d=s.value.trim();if(d&&d!==n.name)try{let m=n.source,g=m.replace(/\/\/ @name\s+.*/,`// @name ${d}`);g!==m&&(this.plugin.scriptManager.updateScript(n.id,g),await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C\u540D\u79F0\u5DF2\u66F4\u65B0\u4E3A "${d}"`),this.display())}catch(m){new p.Notice(`\u66F4\u65B0\u811A\u672C\u540D\u79F0\u5931\u8D25: ${m.message}`),s.replaceWith(u)}else s.replaceWith(u)};s.addEventListener("blur",l),s.addEventListener("keydown",d=>{d.key==="Enter"?l():d.key==="Escape"&&s.replaceWith(u)})}),n.description&&c.createEl("div",{text:n.description,cls:"cheekychimp-script-description"});let h=r.createDiv({cls:"cheekychimp-script-actions"}),f=new p.ButtonComponent(h).setIcon("pencil").setTooltip("\u7F16\u8F91").onClick(()=>{this.editScript(n)}),o=new p.ButtonComponent(h).setIcon("trash").setTooltip("\u5220\u9664").onClick(()=>{this.deleteScript(n)})}async importScript(e){let n=new p.Menu;n.addItem(r=>{r.setTitle("\u4ECE\u6587\u4EF6\u5BFC\u5165").setIcon("folder").onClick(()=>{this.importFromFile()})}),n.addItem(r=>{r.setTitle("\u4ECEURL\u5BFC\u5165").setIcon("link").onClick(()=>{this.importFromUrl()})}),n.addItem(r=>{r.setTitle("\u4ECE\u7C98\u8D34\u677F\u5BFC\u5165").setIcon("clipboard").onClick(()=>{this.importFromClipboard()})}),n.showAtMouseEvent(e)}async importFromFile(){let e=document.createElement("input");e.type="file",e.accept=".js,.user.js",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",async n=>{let i=n.target.files;if(!i||i.length===0){document.body.removeChild(e);return}let a=i[0];try{let c=await this.readFileAsText(a);if(!c.includes("// ==UserScript==")||!c.includes("// ==/UserScript==")){new p.Notice("\u5BFC\u5165\u5931\u8D25\uFF1A\u65E0\u6548\u7684\u7528\u6237\u811A\u672C\u683C\u5F0F"),document.body.removeChild(e);return}let u=this.plugin.scriptManager.addScript(c);await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${u.name}" \u5DF2\u5BFC\u5165`),this.display()}catch(c){new p.Notice(`\u5BFC\u5165\u811A\u672C\u5931\u8D25: ${c.message}`)}finally{document.body.removeChild(e)}}),e.click()}async importFromUrl(){new P(this.app,async n=>{try{new p.Notice(`\u6B63\u5728\u4ECE ${n} \u4E0B\u8F7D\u811A\u672C...`);let r=await fetch(n);if(!r.ok)throw new Error(`\u8BF7\u6C42\u5931\u8D25: ${r.status} ${r.statusText}`);let i=await r.text();if(!i.includes("// ==UserScript==")||!i.includes("// ==/UserScript=="))throw new Error("\u4E0D\u662F\u6709\u6548\u7684\u7528\u6237\u811A\u672C\u683C\u5F0F");let a=this.plugin.scriptManager.addScript(i);await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${a.name}" \u5DF2\u5BFC\u5165`),this.display()}catch(r){new p.Notice(`\u5BFC\u5165\u811A\u672C\u5931\u8D25: ${r.message}`)}}).open()}async importFromClipboard(){new U(this.app,async n=>{try{if(!n.includes("// ==UserScript==")||!n.includes("// ==/UserScript=="))throw new Error("\u4E0D\u662F\u6709\u6548\u7684\u7528\u6237\u811A\u672C\u683C\u5F0F");let r=this.plugin.scriptManager.addScript(n);await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${r.name}" \u5DF2\u5BFC\u5165`),this.display()}catch(r){new p.Notice(`\u5BFC\u5165\u811A\u672C\u5931\u8D25: ${r.message}`)}}).open()}readFileAsText(e){return new Promise((n,r)=>{let i=new FileReader;i.onload=a=>{a.target?n(a.target.result):r(new Error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25"))},i.onerror=()=>{r(new Error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25"))},i.readAsText(e)})}async createScript(){let e=`// ==UserScript==
// @name        \u65B0\u811A\u672C
// @namespace   obsidian-cheekychimp
// @version     0.1
// @description \u5728\u6B64\u5904\u586B\u5199\u811A\u672C\u63CF\u8FF0
// @author      \u4F60\u7684\u540D\u5B57
// @match       *://*/*
// @grant       none
// ==/UserScript==

(function() {
    'use strict';
    
    // \u4F60\u7684\u4EE3\u7801\u5728\u8FD9\u91CC...
    console.log('Hello from Javascript!');
})();`;new x(this.app,e,async r=>{try{let i=this.plugin.scriptManager.addScript(r);await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${i.name}" \u5DF2\u521B\u5EFA`),this.display()}catch(i){new p.Notice(`\u521B\u5EFA\u811A\u672C\u5931\u8D25: ${i.message}`)}}).open()}async editScript(e){new x(this.app,e.source,async r=>{try{this.plugin.scriptManager.updateScript(e.id,r),await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${e.name}" \u5DF2\u66F4\u65B0`),this.display()}catch(i){new p.Notice(`\u66F4\u65B0\u811A\u672C\u5931\u8D25: ${i.message}`)}}).open()}async deleteScript(e){if(await new Promise(r=>{new V(this.app,`\u786E\u5B9A\u8981\u5220\u9664\u811A\u672C "${e.name}" \u5417\uFF1F`,r).open()}))try{this.plugin.scriptManager.removeScript(e.id),await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${e.name}" \u5DF2\u5220\u9664`),this.display()}catch(r){new p.Notice(`\u5220\u9664\u811A\u672C\u5931\u8D25: ${r.message}`)}}},U=class extends p.Modal{constructor(e,n){super(e);this.content="";this.onSubmit=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cheekychimp-dialog"),e.createEl("h2",{text:"\u5BFC\u5165\u7528\u6237\u811A\u672C"}),e.createEl("p",{text:"\u7C98\u8D34\u7528\u6237\u811A\u672C\u5185\u5BB9:"}),e.createEl("textarea",{cls:"cheekychimp-editor"}).addEventListener("input",c=>{this.content=c.target.value});let r=e.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u5BFC\u5165",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.content){new p.Notice("\u8BF7\u8F93\u5165\u811A\u672C\u5185\u5BB9");return}this.onSubmit(this.content),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},x=class extends p.Modal{constructor(e,n,r){super(e);this.content=n,this.onSubmit=r}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cheekychimp-dialog"),e.style.width="500px",e.style.maxWidth="80vw",e.createEl("h2",{text:"\u7F16\u8F91\u7528\u6237\u811A\u672C"});let n=e.createEl("textarea",{cls:"cheekychimp-editor"});n.value=this.content,n.style.width="100%",n.style.height="500px",n.style.minHeight="400px",n.style.fontSize="14px",n.style.fontFamily="monospace",n.style.padding="10px",n.style.boxSizing="border-box",n.addEventListener("input",c=>{this.content=c.target.value});let r=e.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.content){new p.Notice("\u811A\u672C\u5185\u5BB9\u4E0D\u80FD\u4E3A\u7A7A");return}this.onSubmit(this.content),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},V=class extends p.Modal{constructor(e,n,r){super(e);this.message=n,this.onConfirm=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\u786E\u8BA4"}),e.createEl("p",{text:this.message});let n=e.createDiv({cls:"modal-button-container"});n.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.onConfirm(!1),this.close()}),n.createEl("button",{text:"\u786E\u8BA4",cls:"mod-cta"}).addEventListener("click",()=>{this.onConfirm(!0),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},P=class extends p.Modal{constructor(e,n){super(e);this.url="";this.onSubmit=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cheekychimp-dialog"),e.createEl("h2",{text:"\u4ECEURL\u5BFC\u5165\u7528\u6237\u811A\u672C"}),e.createEl("p",{text:"\u8F93\u5165\u7528\u6237\u811A\u672C\u7684URL:"});let n=new p.TextComponent(e);n.setPlaceholder("https://example.com/userscript.user.js"),n.inputEl.addClass("cheekychimp-url-input"),n.inputEl.style.width="100%",n.onChange(c=>{this.url=c});let r=e.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u5BFC\u5165",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.url){new p.Notice("\u8BF7\u8F93\u5165\u6709\u6548\u7684URL");return}try{this.url.match(/^https?:\/\//)||(this.url="https://"+this.url),new URL(this.url)}catch(c){new p.Notice("\u8BF7\u8F93\u5165\u6709\u6548\u7684URL");return}this.onSubmit(this.url),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var E=class{constructor(){this.id="",this.name="",this.namespace="",this.version="",this.description="",this.includes=[],this.matches=[],this.excludes=[],this.resources=[],this.requires=[],this.author="",this.homepage="",this.icon="",this.runAt="document-idle",this.enabled=!0,this.source="",this.lastUpdated=Date.now(),this.position=0}};var A=class{static getScriptId(t){var a;let e=Date.now().toString(36),n="",i=encodeURI(t).match(/[a-zA-Z0-9]/g);return i&&i.length>0?n=i.join(""):n=((a=btoa(t).match(/[a-zA-Z0-9]/g))==null?void 0:a.join(""))||"script",`${n}_${e}`}static parseScript(t){let e=new E;e.source=t;let n=t.indexOf(this.HEADER_START),r=t.indexOf(this.HEADER_END);if(n===-1||r===-1||r<=n)throw new Error("Invalid userscript: metadata block not found");let a=t.substring(n+this.HEADER_START.length,r).split(`
`),c=!1;for(let u of a){let h=u.trim();if(!h||!h.startsWith("//"))continue;let f=h.replace(/^\/\/\s*/,"").trim();if(!f.startsWith("@"))continue;let o=f.match(/@([a-zA-Z0-9_\-]+)\s+(.*)/);if(!o)continue;let[,s,l]=o,d=l.trim();switch(s){case"name":e.name=d,c=!0;break;case"namespace":e.namespace=d;break;case"version":e.version=d;break;case"description":e.description=d;break;case"author":e.author=d;break;case"homepage":case"website":case"source":e.homepage=d;break;case"icon":case"iconURL":case"defaulticon":e.icon=d;break;case"include":e.includes.push(d);break;case"match":e.matches.push(d);break;case"exclude":e.excludes.push(d);break;case"require":e.requires.push(d);break;case"resource":let m=d.match(/(\S+)\s+(.*)/);if(m){let[,g,S]=m;e.resources.push({name:g.trim(),url:S.trim()})}break;case"run-at":["document-start","document-end","document-idle"].includes(d)&&(e.runAt=d);break}}return(!c||!e.name)&&(e.name="\u672A\u547D\u540D\u811A\u672C",console.warn("\u811A\u672C\u6CA1\u6709\u540D\u79F0\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u540D\u79F0")),e.id=A.getScriptId(e.name),e}},w=A;w.HEADER_START="==UserScript==",w.HEADER_END="==/UserScript==";var M=class{constructor(){this.scripts=new Map;this.eventListeners={}}on(t,e){this.eventListeners[t]=e}getAllScripts(){return Array.from(this.scripts.values()).sort((t,e)=>t.position-e.position)}getScript(t){return this.scripts.get(t)}addScript(t){try{let e=w.parseScript(t);if(this.scripts.has(e.id))throw new Error(`Script with name '${e.name}' already exists`);return e.position=this.scripts.size,this.scripts.set(e.id,e),this.eventListeners.onScriptAdded&&this.eventListeners.onScriptAdded(e),e}catch(e){throw new Error(`Failed to add script: ${e.message}`)}}updateScript(t,e){if(!this.scripts.has(t))throw new Error(`Script with ID '${t}' not found`);try{let n=this.scripts.get(t),r=w.parseScript(e);return r.id=t,r.position=(n==null?void 0:n.position)||0,r.enabled=(n==null?void 0:n.enabled)||!0,r.lastUpdated=Date.now(),this.scripts.set(t,r),this.eventListeners.onScriptUpdated&&this.eventListeners.onScriptUpdated(r),r}catch(n){throw new Error(`Failed to update script: ${n.message}`)}}removeScript(t){if(!this.scripts.has(t))throw new Error(`Script with ID '${t}' not found`);this.scripts.delete(t),this.getAllScripts().forEach((n,r)=>{n.position=r}),this.eventListeners.onScriptRemoved&&this.eventListeners.onScriptRemoved(t)}enableScript(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);e.enabled=!0,this.eventListeners.onScriptEnabled&&this.eventListeners.onScriptEnabled(t)}disableScript(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);e.enabled=!1,this.eventListeners.onScriptDisabled&&this.eventListeners.onScriptDisabled(t)}findScriptsForUrl(t){let e=[];for(let n of this.getAllScripts()){if(!n.enabled)continue;let r=n.includes.length===0||n.includes.some(c=>this.matchUrlPattern(t,c)),i=n.excludes.some(c=>this.matchUrlPattern(t,c)),a=n.matches.length===0||n.matches.some(c=>this.matchUrlPattern(t,c));r&&!i&&a&&e.push(n)}return e.sort((n,r)=>n.position-r.position)}matchUrlPattern(t,e){if(e==="*")return!0;try{let n=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");return n="^"+n+"$",new RegExp(n).test(t)}catch(n){return console.error(`Invalid pattern: ${e}`,n),!1}}loadScripts(t){this.scripts.clear(),t.forEach(e=>{this.scripts.set(e.id,e)})}moveScriptUp(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);if(e.position===0)return;let n=this.getAllScripts().find(r=>r.position===e.position-1);n&&(n.position++,e.position--,this.eventListeners.onScriptUpdated&&(this.eventListeners.onScriptUpdated(e),this.eventListeners.onScriptUpdated(n)))}moveScriptDown(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);let n=this.getAllScripts();if(e.position===n.length-1)return;let r=n.find(i=>i.position===e.position+1);r&&(r.position--,e.position++,this.eventListeners.onScriptUpdated&&(this.eventListeners.onScriptUpdated(e),this.eventListeners.onScriptUpdated(r)))}};var L=class{constructor(t){this.cache=new Map;this.plugin=t}async getValue(t,e){if(this.cache.has(t))return this.cache.get(t);let n=await this.plugin.loadData()||{},r=t in n?n[t]:e;return this.cache.set(t,r),r}async setValue(t,e){this.cache.set(t,e);let n=await this.plugin.loadData()||{};n[t]=e,await this.plugin.saveData(n)}async deleteValue(t){this.cache.delete(t);let e=await this.plugin.loadData()||{};t in e&&(delete e[t],await this.plugin.saveData(e))}async listValues(){let t=await this.plugin.loadData()||{};return Object.keys(t)}clearCache(){this.cache.clear()}};var _=class{constructor(t,e){this.resourceCache={};this.scriptStorage=t,this.scriptManager=e}async injectScripts(t,e,n){if(!t||!e||!n||n.length===0){console.log("CheekyChimp: \u6CA1\u6709\u53EF\u6CE8\u5165\u7684\u811A\u672C\u6216\u65E0\u6548\u7684\u53C2\u6570");return}console.log(`CheekyChimp: \u51C6\u5907\u5411 ${e} \u6CE8\u5165 ${n.length} \u4E2A\u811A\u672C`);try{let r=n.filter(c=>c.runAt==="document-start"),i=n.filter(c=>c.runAt==="document-end"),a=n.filter(c=>c.runAt==="document-idle"||!c.runAt);if(t instanceof HTMLIFrameElement)try{e.includes("bilibili.com")&&(console.log("CheekyChimp: \u68C0\u6D4B\u5230B\u7AD9\u9875\u9762\uFF0C\u8BBE\u7F6E\u7279\u6B8A\u5904\u7406"),this.setupBilibiliSupport(t));for(let c of r)await this.injectScript(t,e,c);this.injectContentLoadedListener(t,e,i),this.injectLoadListener(t,e,a)}catch(c){console.error("CheekyChimp: \u6CE8\u5165\u811A\u672C\u8FC7\u7A0B\u51FA\u9519:",c)}else if(t.tagName==="WEBVIEW")try{let c=t;if(typeof c.executeJavaScript=="function"){let h=this.generateSimpleGMAPIs();await c.executeJavaScript(h);for(let f of n)try{let o=await this.preprocessScript(f);await c.executeJavaScript(o),console.log(`CheekyChimp: \u6210\u529F\u6CE8\u5165\u811A\u672C "${f.name}"`)}catch(o){console.error(`CheekyChimp: \u6CE8\u5165\u811A\u672C "${f.name}" \u5931\u8D25:`,o)}}else{console.log("CheekyChimp: \u4F7F\u7528DOM\u65B9\u5F0F\u6CE8\u5165\u811A\u672C");for(let h of n)try{let f=await this.preprocessScript(h);await this.executeScriptInWebView(t,f),console.log(`CheekyChimp: \u6210\u529F\u6CE8\u5165\u811A\u672C "${h.name}"`)}catch(f){console.error(`CheekyChimp: \u6CE8\u5165\u811A\u672C "${h.name}" \u5931\u8D25:`,f)}}}catch(c){console.error("CheekyChimp: \u6CE8\u5165WebView\u811A\u672C\u5931\u8D25:",c)}}catch(r){console.error("CheekyChimp: \u6CE8\u5165\u811A\u672C\u8FC7\u7A0B\u4E2D\u53D1\u751F\u672A\u9884\u671F\u7684\u9519\u8BEF:",r)}}async injectScript(t,e,n){try{console.log(`CheekyChimp: \u5F00\u59CB\u6CE8\u5165\u811A\u672C "${n.name}"`);let r=await this.preprocessScript(n),i=await this.createGmApi(n,e),a=this.createScriptWrapper(n,i,r);switch(n.runAt){case"document-start":await this.injectScriptImmediately(t,a);break;case"document-end":await this.injectScriptOnContentLoaded(t,a);break;case"document-idle":default:await this.injectScriptOnLoad(t,a)}console.log(`CheekyChimp: \u811A\u672C "${n.name}" \u6CE8\u5165\u6210\u529F`)}catch(r){console.error(`CheekyChimp: \u6CE8\u5165\u811A\u672C "${n.name}" \u5931\u8D25:`,r)}}async injectScriptImmediately(t,e){try{t instanceof HTMLIFrameElement?await this.executeScriptInIframe(t,e):await this.executeScriptInWebView(t,e)}catch(n){throw console.error("CheekyChimp: \u7ACB\u5373\u6CE8\u5165\u811A\u672C\u5931\u8D25:",n),n}}async injectScriptOnContentLoaded(t,e){return new Promise((n,r)=>{let i=async a=>{try{t instanceof HTMLIFrameElement?await this.executeScriptInIframe(t,e):await this.executeScriptInWebView(t,e),n()}catch(c){r(c)}finally{t.removeEventListener("DOMContentLoaded",i)}};t.addEventListener("DOMContentLoaded",i)})}async injectScriptOnLoad(t,e){return new Promise((n,r)=>{let i=async a=>{try{t instanceof HTMLIFrameElement?await this.executeScriptInIframe(t,e):await this.executeScriptInWebView(t,e),n()}catch(c){r(c)}finally{t.removeEventListener("load",i)}};t.addEventListener("load",i)})}async createGmApi(t,e){let n={script:{name:t.name,namespace:t.namespace,description:t.description,version:t.version,includes:t.includes,excludes:t.excludes,matches:t.matches,resources:t.resources,requires:t.requires},version:"0.1.0",scriptHandler:"Obsidian CheekyChimp",scriptMetaStr:this.getScriptMetaStr(t)},r=this.extractConnectDomains(t.source),i={getValue:async(o,s)=>{let l=`${t.id}:${o}`;return await this.scriptStorage.getValue(l,s)},setValue:async(o,s)=>{let l=`${t.id}:${o}`;await this.scriptStorage.setValue(l,s)},deleteValue:async o=>{let s=`${t.id}:${o}`;await this.scriptStorage.deleteValue(s)},listValues:async()=>{let o=await this.scriptStorage.listValues(),s=`${t.id}:`;return o.filter(l=>l.startsWith(s)).map(l=>l.substring(s.length))}},a=o=>{console.log(`CheekyChimp: \u6267\u884CxmlhttpRequest ${o.url}`);try{let s=new AbortController,l=s.signal,d={method:o.method||"GET",signal:l,credentials:o.withCredentials?"include":"same-origin"};o.headers&&(d.headers=o.headers),o.data&&(d.body=o.data);let g=new URL(o.url).hostname;this.isConnectAllowed(g,r)||console.warn(`CheekyChimp: \u8BF7\u6C42 ${g} \u4E0D\u5728@connect\u5217\u8868\u4E2D\uFF0C\u53EF\u80FD\u88AB\u963B\u6B62`);let H={abort:()=>{s.abort()}};return fetch(o.url,d).then(async v=>{let T="";if(v.headers)if(typeof v.headers.forEach=="function"){let D=[];v.headers.forEach((j,F)=>{D.push(`${F}: ${j}`)}),T=D.join(`
`)}else T=v.headers.toString();let R=await v.text();o.onload&&typeof o.onload=="function"&&o.onload({finalUrl:v.url,readyState:4,status:v.status,statusText:v.statusText,responseHeaders:T,responseText:R,response:R})}).catch(v=>{if(v.name==="AbortError"&&o.onabort){o.onabort();return}o.onerror&&typeof o.onerror=="function"&&o.onerror(v)}),H}catch(s){return console.error("CheekyChimp: XMLHttpRequest\u6267\u884C\u5931\u8D25:",s),o.onerror&&typeof o.onerror=="function"&&o.onerror(s),null}};return{GM_info:n,GM_getValue:(o,s)=>localStorage.getItem(`cheekychimp:${t.id}:${o}`)||s,GM_setValue:(o,s)=>{localStorage.setItem(`cheekychimp:${t.id}:${o}`,s),i.setValue(o,s)},GM_deleteValue:o=>{localStorage.removeItem(`cheekychimp:${t.id}:${o}`),i.deleteValue(o)},GM_listValues:()=>{let o=[],s=`cheekychimp:${t.id}:`;for(let l=0;l<localStorage.length;l++){let d=localStorage.key(l);d&&d.startsWith(s)&&o.push(d.substring(s.length))}return o},GM:{getValue:async(o,s)=>{let l=`cheekychimp:${t.id}:${o}`,d=localStorage.getItem(l);return d!==null?d:s},setValue:async(o,s)=>{let l=`cheekychimp:${t.id}:${o}`;localStorage.setItem(l,s),await i.setValue(o,s)},deleteValue:async o=>{let s=`cheekychimp:${t.id}:${o}`;localStorage.removeItem(s),await i.deleteValue(o)},listValues:async()=>{let o=[],s=`cheekychimp:${t.id}:`;for(let l=0;l<localStorage.length;l++){let d=localStorage.key(l);d&&d.startsWith(s)&&o.push(d.substring(s.length))}return o},xmlHttpRequest:a,addStyle:async o=>{let s=document.createElement("style");return s.textContent=o,s.setAttribute("data-cheekychimp-style",t.id),document.head.appendChild(s),s},registerMenuCommand:async(o,s,l)=>this.registerMenuCommand(t,o,s,l),addElement:async(o,s)=>{let l=document.createElement(o);for(let[d,m]of Object.entries(s))l.setAttribute(d,String(m));return document.body.appendChild(l),l}},GM_getResourceText:o=>{console.log(`CheekyChimp: \u83B7\u53D6\u8D44\u6E90\u6587\u672C ${o}`);try{let l=t.resources.reduce((g,S)=>(g[S.name]=S.url,g),{})[o];if(!l)return console.warn(`CheekyChimp: \u8D44\u6E90 ${o} \u672A\u627E\u5230`),"";let d=`cheekychimp_resource:${t.id}:${o}`,m=localStorage.getItem(d);return m?(console.log(`CheekyChimp: \u4F7F\u7528\u7F13\u5B58\u7684\u8D44\u6E90 ${o}`),m):(console.log(`CheekyChimp: \u8D44\u6E90${o}\u672A\u7F13\u5B58\uFF0C\u542F\u52A8\u540E\u53F0\u52A0\u8F7D`),setTimeout(()=>{fetch(l).then(g=>{if(!g.ok)throw new Error(`\u83B7\u53D6\u8D44\u6E90\u5931\u8D25: ${g.status} ${g.statusText}`);return g.text()}).then(g=>{try{localStorage.setItem(d,g),console.log(`CheekyChimp: \u5DF2\u7F13\u5B58\u8D44\u6E90 ${o} \u4F9B\u4E0B\u6B21\u4F7F\u7528`)}catch(S){console.warn("CheekyChimp: \u65E0\u6CD5\u7F13\u5B58\u8D44\u6E90\uFF0C\u53EF\u80FD\u8D85\u51FA\u5B58\u50A8\u9650\u5236",S)}}).catch(g=>{console.error(`CheekyChimp: \u540E\u53F0\u83B7\u53D6\u8D44\u6E90 ${o} \u5931\u8D25:`,g)})},0),"")}catch(s){return console.error(`CheekyChimp: \u83B7\u53D6\u8D44\u6E90 ${o} \u5931\u8D25:`,s),""}},GM_getResourceURL:o=>{try{let l=t.resources.reduce((d,m)=>(d[m.name]=m.url,d),{})[o];return l||(console.warn(`CheekyChimp: \u8D44\u6E90 ${o} \u672A\u627E\u5230`),"")}catch(s){return console.error(`CheekyChimp: \u83B7\u53D6\u8D44\u6E90URL ${o} \u5931\u8D25:`,s),""}},GM_addStyle:o=>{try{let s=document.createElement("style");s.textContent=o,s.setAttribute("data-cheekychimp-style",t.id),document.head.appendChild(s)}catch(s){console.error("CheekyChimp: \u6DFB\u52A0\u6837\u5F0F\u5931\u8D25:",s)}},GM_addElement:(o,s)=>{let l=document.createElement(o);for(let[d,m]of Object.entries(s))l.setAttribute(d,String(m));return document.body.appendChild(l),l},GM_registerMenuCommand:(o,s,l)=>this.registerMenuCommand(t,o,s,l),GM_unregisterMenuCommand:o=>{try{let s=`tampermonkey_commands:${t.id}`,l=[];try{let m=localStorage.getItem(s);m&&(l=JSON.parse(m),l=l.filter(g=>g.id!==o),localStorage.setItem(s,JSON.stringify(l)))}catch(m){console.error("\u89E3\u6790\u4FDD\u5B58\u7684\u547D\u4EE4\u5931\u8D25:",m)}document.removeEventListener(`cheekychimp-run-command-${o}`,()=>{});let d=new CustomEvent("cheekychimp-command-unregistered",{detail:{scriptId:t.id,commandId:o}});document.dispatchEvent(d),console.log(`CheekyChimp: \u5DF2\u6CE8\u9500\u83DC\u5355\u547D\u4EE4 ID ${o}`)}catch(s){console.error(`CheekyChimp: \u6CE8\u9500\u83DC\u5355\u547D\u4EE4 ID ${o} \u5931\u8D25:`,s)}},GM_xmlhttpRequest:a,GM_openInTab:(o,s)=>(console.warn("GM_openInTab not fully implemented"),window.open(o,"_blank"),null),GM_setClipboard:(o,s)=>{navigator.clipboard.writeText(o).catch(l=>console.error("Failed to copy text: ",l))},GM_notification:(o,s)=>{console.warn("GM_notification not fully implemented"),alert(typeof o=="string"?o:o.text)},unsafeWindow:window}}createScriptWrapper(t,e,n){let r=t.resources&&t.resources.some(a=>a.name==="swalStyle"),i=t.name.includes("Immersive Translate");return`
            (function() {
                try {
                    // \u5B9A\u4E49\u57FA\u672C\u7684GM\u4FE1\u606F\u5BF9\u8C61
                    const GM_info = ${JSON.stringify(e.GM_info)};
                    console.log('CheekyChimp: \u51C6\u5907\u6267\u884C\u811A\u672C "${t.name}"', GM_info);
                    
                    // \u5B9A\u4E49GM API\u51FD\u6570
                    const GM_getValue = function(name, defaultValue) {
                        return localStorage.getItem('cheekychimp:${t.id}:' + name) || defaultValue;
                    };
                    
                    const GM_setValue = function(name, value) {
                        localStorage.setItem('cheekychimp:${t.id}:' + name, value);
                    };
                    
                    const GM_deleteValue = function(name) {
                        localStorage.removeItem('cheekychimp:${t.id}:' + name);
                    };
                    
                    const GM_listValues = function() {
                        const keys = [];
                        const prefix = 'cheekychimp:${t.id}:';
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith(prefix)) {
                                keys.push(key.substring(prefix.length));
                            }
                        }
                        return keys;
                    };
                    
                    const GM_addStyle = function(css) {
                        try {
                            const style = document.createElement('style');
                            style.textContent = css;
                            document.head.appendChild(style);
                            return style;
                        } catch(e) {
                            console.error('CheekyChimp: GM_addStyle\u9519\u8BEF', e);
                        }
                    };
                    
                    // \u7B80\u5316\u7248\u7684GM_getResourceText\u51FD\u6570
                    const GM_getResourceText = function(name) {
                        // \u4ECE\u7F13\u5B58\u4E2D\u83B7\u53D6\u8D44\u6E90
                        const cacheKey = 'cheekychimp_resource:${t.id}:' + name;
                        const cachedResource = localStorage.getItem(cacheKey);
                        
                        // \u5982\u679C\u662F\u591C\u95F4\u6A21\u5F0F\u52A9\u624B\u811A\u672C\u8BF7\u6C42swalStyle\uFF0C\u4E14\u662F\u7B2C\u4E00\u6B21\u52A0\u8F7D
                        if (name === 'swalStyle' && !cachedResource && '${t.name}'.includes('\u591C\u95F4\u6A21\u5F0F')) {
                            // \u63D0\u4F9B\u9ED8\u8BA4\u7684SweetAlert\u6837\u5F0F\u4EE5\u907F\u514D\u62A5\u9519
                            return \`
                                .swal2-popup { background: #fff; color: #333; border-radius: 5px; padding: 20px; }
                                .swal2-title { color: #595959; font-size: 1.8em; margin: 0; }
                                .swal2-content { color: #545454; }
                                .swal2-actions { margin-top: 15px; }
                                .swal2-confirm { background: #3085d6; color: #fff; border: 0; border-radius: 3px; padding: 8px 20px; }
                                .swal2-cancel { background: #aaa; color: #fff; border: 0; border-radius: 3px; padding: 8px 20px; margin-left: 10px; }
                                .darkmode-popup { font-size: 14px !important; }
                                .darkmode-center { display: flex; align-items: center; }
                                .darkmode-setting-label { display: flex; align-items: center; justify-content: space-between; padding-top: 15px; }
                                .darkmode-setting-label-col { display: flex; align-items: flex-start; padding-top: 15px; flex-direction: column; }
                                .darkmode-setting-radio { width: 16px; height: 16px; }
                                .darkmode-setting-textarea { width: 100%; margin: 14px 0 0; height: 100px; resize: none; border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; color: #666; line-height: 1.2; }
                                .darkmode-setting-input { border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; width: 100px; }
                            \`;
                        }
                        
                        return cachedResource || '';
                    };
                    
                    // \u63D0\u4F9B\u5176\u4ED6\u5FC5\u8981\u7684GM API\u51FD\u6570
                    const GM_registerMenuCommand = function(name, fn, accessKey) {
                        console.log('CheekyChimp: \u811A\u672C\u6CE8\u518C\u83DC\u5355\u547D\u4EE4:', name);
                        // \u5B58\u50A8\u547D\u4EE4\u5230\u672C\u5730\u5B58\u50A8
                        const commandId = Date.now() + Math.floor(Math.random() * 1000);
                        const commandsKey = 'cheekychimp_commands:${t.id}';
                        let commands = [];
                        try {
                            const savedCommands = localStorage.getItem(commandsKey);
                            if (savedCommands) {
                                commands = JSON.parse(savedCommands);
                            }
                        } catch (e) {}
                        
                        commands.push({
                            id: commandId,
                            name: name,
                            accessKey: accessKey || ''
                        });
                        
                        localStorage.setItem(commandsKey, JSON.stringify(commands));
                        
                        // \u5728\u9875\u9762\u4E2D\u521B\u5EFA\u6309\u94AE
                        setTimeout(function() {
                            try {
                                // \u68C0\u67E5\u662F\u5426\u5DF2\u7ECF\u6709\u83DC\u5355\u5BB9\u5668
                                let menuContainer = document.getElementById('cheekychimp-menu-container');
                                if (!menuContainer) {
                                    // \u521B\u5EFA\u83DC\u5355\u5BB9\u5668
                                    menuContainer = document.createElement('div');
                                    menuContainer.id = 'cheekychimp-menu-container';
                                    menuContainer.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; display: none; background: white; border: 1px solid #ccc; border-radius: 5px; padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
                                    document.body.appendChild(menuContainer);
                                    
                                    // \u521B\u5EFA\u83DC\u5355\u56FE\u6807
                                    const menuIcon = document.createElement('div');
                                    menuIcon.id = 'cheekychimp-menu-icon';
                                    menuIcon.innerHTML = '<svg width="24" height="24" viewBox="0 0 512 512"><path fill="currentColor" d="M108.12 0L0 108.12v295.76L108.12 512h295.76L512 403.88V108.12L403.88 0zm71.84 107.25c9.02 0 16.56 7.54 16.56 16.56v49h58.07c9.02 0 16.56 7.54 16.56 16.56v87.19c0 9.02-7.54 16.56-16.56 16.56h-58.07v52c0 9.02-7.54 16.56-16.56 16.56h-127c-9.02 0-16.56-7.54-16.56-16.56v-52h-58.07c-9.02 0-16.56-7.54-16.56-16.56v-87.19c0-9.02 7.54-16.56 16.56-16.56h58.07v-49c0-9.02 7.54-16.56 16.56-16.56z"/></svg>';
                                    menuIcon.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 10000; cursor: pointer; width: 24px; height: 24px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);';
                                    document.body.appendChild(menuIcon);
                                    
                                    // \u6DFB\u52A0\u70B9\u51FB\u4E8B\u4EF6
                                    menuIcon.addEventListener('click', function() {
                                        if (menuContainer.style.display === 'none') {
                                            menuContainer.style.display = 'block';
                                        } else {
                                            menuContainer.style.display = 'none';
                                        }
                                    });
                                }
                                
                                // \u6DFB\u52A0\u547D\u4EE4\u6309\u94AE
                                const commandButton = document.createElement('button');
                                commandButton.textContent = name;
                                commandButton.style.cssText = 'display: block; width: 100%; margin: 5px 0; padding: 5px 10px; border: none; background: #f0f0f0; border-radius: 3px; cursor: pointer;';
                                commandButton.addEventListener('click', function() {
                                    menuContainer.style.display = 'none';
                                    try {
                                        fn();
                                    } catch(e) {
                                        console.error('CheekyChimp: \u6267\u884C\u547D\u4EE4\u5931\u8D25', e);
                                    }
                                });
                                menuContainer.appendChild(commandButton);
                            } catch(e) {
                                console.error('CheekyChimp: \u521B\u5EFA\u83DC\u5355\u9879\u5931\u8D25', e);
                            }
                        }, 500);
                        
                        return commandId;
                    };
                    
                    const GM_xmlhttpRequest = function(details) {
                        try {
                            if (!details.url) {
                                throw new Error('URL is required for GM_xmlhttpRequest');
                            }
                            
                            // \u4F7F\u7528fetch API\u5B9E\u73B0
                            const fetchInit = {
                                method: details.method || 'GET',
                                headers: details.headers || {},
                                body: details.data || null,
                                credentials: details.withCredentials ? 'include' : 'same-origin'
                            };
                            
                            fetch(details.url, fetchInit)
                                .then(function(response) {
                                    if (!response.ok && details.onerror) {
                                        details.onerror(response);
                                        return;
                                    }
                                    
                                    return response.text().then(function(responseText) {
                            if (details.onload) {
                                            // \u5C1D\u8BD5\u6784\u5EFA\u4E00\u4E2Aheaders\u5BF9\u8C61
                                            let responseHeaders = '';
                                            try {
                                                const headerPairs = [];
                                                response.headers.forEach((value, key) => {
                                                    headerPairs.push(\`\${key}: \${value}\`);
                                                });
                                                responseHeaders = headerPairs.join('\\n');
                                            } catch (e) {
                                                // \u5982\u679C\u4E0D\u652F\u6301forEach\uFF0C\u5C1D\u8BD5\u4F7F\u7528toString
                                                responseHeaders = response.headers.toString();
                                            }
                                            
                                        details.onload({
                                                responseText: responseText,
                                            status: response.status,
                                            statusText: response.statusText,
                                                readyState: 4,
                                                finalUrl: response.url,
                                                responseHeaders: responseHeaders
                                        });
                                        }
                                    });
                                })
                                .catch(function(error) {
                                    if (details.onerror) {
                                        details.onerror(error);
                                    }
                                });
                            
                            // \u8FD4\u56DE\u4E00\u4E2A\u6A21\u62DF\u7684XMLHttpRequest\u5BF9\u8C61\uFF0C\u5E26\u6709abort\u65B9\u6CD5
                            return { abort: function() { console.log('Request aborted'); } };
                        } catch(e) {
                            console.error('CheekyChimp: GM_xmlhttpRequest\u9519\u8BEF', e);
                            if (details.onerror) {
                                details.onerror(e);
                            }
                        }
                    };
                    
                    // \u65B0\u7248GM API\u652F\u6301
                    const GM = {
                        getValue: function(name, defaultValue) {
                            return Promise.resolve(GM_getValue(name, defaultValue));
                        },
                        setValue: function(name, value) {
                            GM_setValue(name, value);
                            return Promise.resolve();
                        },
                        deleteValue: function(name) {
                            GM_deleteValue(name);
                            return Promise.resolve();
                        },
                        listValues: function() {
                            return Promise.resolve(GM_listValues());
                        },
                        xmlHttpRequest: GM_xmlhttpRequest,
                        addStyle: function(css) {
                            return Promise.resolve(GM_addStyle(css));
                        },
                        registerMenuCommand: function(name, fn, accessKey) {
                            return Promise.resolve(GM_registerMenuCommand(name, fn, accessKey));
                        },
                        addElement: function(tagName, attributes) {
                            return Promise.resolve(GM_addElement(tagName, attributes));
                        }
                    };
                    
                    // \u6DFB\u52A0\u5176\u4ED6GM\u51FD\u6570
                    const unsafeWindow = window;
                    
                    // \u5B9E\u73B0\u591C\u95F4\u6A21\u5F0F\u52A9\u624B\u811A\u672C\u9700\u8981\u7684\u7279\u6B8A\u5904\u7406
                    if ('${t.name}'.includes('\u591C\u95F4\u6A21\u5F0F')) {
                        // \u9884\u5148\u6DFB\u52A0\u591C\u95F4\u6A21\u5F0F\u6240\u9700\u8D44\u6E90
                        window.Swal = window.Swal || {
                            fire: function(options) {
                                alert(options.title || 'Message');
                                return Promise.resolve({isConfirmed: true});
                            }
                        };
                    }
                    
                    // \u9488\u5BF9\u6C89\u6D78\u5F0F\u7FFB\u8BD1\u7684\u7279\u6B8A\u5904\u7406
                    if (${i}) {
                        // \u786E\u4FDD\u4E0D\u4F1A\u7531\u4E8E\u8DE8\u57DFXHR\u8BF7\u6C42\u5931\u8D25
                        console.log('CheekyChimp: \u68C0\u6D4B\u5230\u6C89\u6D78\u5F0F\u7FFB\u8BD1\u811A\u672C\uFF0C\u6DFB\u52A0\u7279\u6B8A\u5904\u7406');
                        
                        // \u4FEE\u590D\u53EF\u80FD\u9700\u8981\u7684\u5168\u5C40\u5BF9\u8C61
                        window.browser = window.browser || {};
                        window.chrome = window.chrome || {
                            runtime: {
                                sendMessage: () => Promise.resolve(),
                                onMessage: { addListener: () => {} }
                            },
                            i18n: {
                                getMessage: (key) => key
                            }
                        };
                        
                        // \u9884\u5148\u6DFB\u52A0\u5FC5\u8981\u7684CSS
                        try {
                            if (document.head) {
                                const immersiveStyles = document.createElement('style');
                                immersiveStyles.id = 'immersive-translate-styles';
                                immersiveStyles.textContent = \`
                                    /* \u7FFB\u8BD1\u6309\u94AE\u6837\u5F0F */
                                    #immersive-translate-button {
                                        position: fixed;
                                        right: 16px;
                                        top: 16px;
                                        background-color: rgba(127, 127, 127, 0.3);
                                        color: currentColor;
                                        border-radius: 50%;
                                        width: 40px;
                                        height: 40px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        cursor: pointer;
                                        z-index: 9999;
                                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                                        transition: all 0.3s ease;
                                    }
                                    #immersive-translate-button:hover {
                                        background-color: rgba(127, 127, 127, 0.5);
                                        transform: scale(1.1);
                                    }
                                    /* \u7FFB\u8BD1\u9762\u677F\u57FA\u7840\u6837\u5F0F */
                                    .immersive-translate-popup {
                                        position: fixed;
                                        background: white;
                                        border-radius: 8px;
                                        box-shadow: 0 4px 23px 0 rgba(0, 0, 0, 0.2);
                                        z-index: 9999;
                                    }
                                \`;
                                document.head.appendChild(immersiveStyles);
                                console.log('CheekyChimp: \u5DF2\u6DFB\u52A0\u6C89\u6D78\u5F0F\u7FFB\u8BD1\u57FA\u7840\u6837\u5F0F');
                            }
                        } catch (e) {
                            console.error('CheekyChimp: \u6DFB\u52A0\u6C89\u6D78\u5F0F\u7FFB\u8BD1\u6837\u5F0F\u5931\u8D25:', e);
                        }
                        
                        // \u6DFB\u52A0DOM\u89C2\u5BDF\u5668\uFF0C\u786E\u4FDDbody\u5B58\u5728\u65F6\u6DFB\u52A0\u6309\u94AE
                        const addTranslationButton = () => {
                            try {
                                console.log('CheekyChimp: \u5C1D\u8BD5\u5F3A\u5236\u663E\u793A\u6C89\u6D78\u5F0F\u7FFB\u8BD1UI');
                                
                                // \u68C0\u67E5\u662F\u5426\u5DF2\u5B58\u5728\u6309\u94AE
                                if (document.getElementById('immersive-translate-button')) {
                                    console.log('CheekyChimp: \u6C89\u6D78\u5F0F\u7FFB\u8BD1\u6309\u94AE\u5DF2\u5B58\u5728');
                                    return;
                                }
                                
                                // \u624B\u52A8\u6CE8\u5165\u7FFB\u8BD1\u6309\u94AE\u5230\u9875\u9762\u4E0A
                                const translationButton = document.createElement('div');
                                translationButton.id = 'immersive-translate-button';
                                translationButton.title = '\u6C89\u6D78\u5F0F\u7FFB\u8BD1';
                                translationButton.innerHTML = '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><path d="M211.2 883.2A64 64 0 0 1 147.2 819.2V204.8A64 64 0 0 1 211.2 140.8h249.6v61.44H512v7.68l-0.64 3.84A64 64 0 0 1 448.64 256l-0.64 3.2h-232.96A63.36 63.36 0 0 0 192 256v558.08A61.44 61.44 0 0 0 221.44 856.32A64 64 0 0 0 256 864h232.32c33.28-4.48 59.52-30.08 64-61.44V768h-64v-64h126.08A64 64 0 0 1 678.4 768v34.56A128 128 0 0 1 551.04 928H211.2z" fill="currentColor"></path><path d="M812.8 752.64h-60.8v-128c0-32-30.08-62.08-62.08-62.08h-159.36v-62.08h159.36c65.28 0 125.44 60.16 125.44 125.44v126.72zM448 266.24v-64h126.08A64 64 0 0 1 640 266.24z" fill="currentColor"></path><path d="M787.2 659.2l-96-166.4h64l64 115.2 64-115.2h64l-96 166.4z" fill="currentColor"></path></svg>';
                                document.body.appendChild(translationButton);
                                
                                // \u6DFB\u52A0\u70B9\u51FB\u4E8B\u4EF6
                                translationButton.addEventListener('click', () => {
                                    // \u5C1D\u8BD5\u89E6\u53D1\u5185\u90E8\u7FFB\u8BD1\u51FD\u6570
                                    try {
                                        // \u65B9\u6CD51: \u5C1D\u8BD5\u6FC0\u6D3B\u754C\u9762
                                        const event = new CustomEvent('immersive-translate-toggle');
                                        window.dispatchEvent(event);
                                        
                                        // \u65B9\u6CD52: \u5C1D\u8BD5\u67E5\u627E\u5E76\u8C03\u7528\u5168\u5C40\u51FD\u6570
                                        if (typeof window.immersiveTranslate === 'object' && typeof window.immersiveTranslate.toggleTranslate === 'function') {
                                            window.immersiveTranslate.toggleTranslate();
                                        }
                                        
                                        // \u65B9\u6CD53: \u5C1D\u8BD5\u6267\u884C\u7279\u6B8A\u547D\u4EE4
                                        if (typeof GM !== 'undefined' && typeof GM.registerMenuCommand === 'function') {
                                            // \u5C1D\u8BD5\u67E5\u627E\u548C\u6267\u884C\u83DC\u5355\u547D\u4EE4
                                            const menuCommands = localStorage.getItem('cheekychimp_commands:' + script.id);
                                            if (menuCommands) {
                                                try {
                                                    const commands = JSON.parse(menuCommands);
                                                    // \u67E5\u627E\u7FFB\u8BD1\u547D\u4EE4
                                                    for (const cmd of commands) {
                                                        if (cmd.name.includes('\u7FFB\u8BD1') || cmd.name.includes('Translate')) {
                                                            // \u89E6\u53D1\u547D\u4EE4\u6267\u884C
                                                            const cmdId = cmd.id;
                                                            const cmdEvent = new CustomEvent('cheekychimp-run-command-' + cmdId);
                                                            document.dispatchEvent(cmdEvent);
                                                            console.log('CheekyChimp: \u6267\u884C\u6C89\u6D78\u5F0F\u7FFB\u8BD1\u547D\u4EE4:', cmd.name);
                                                            break;
                                                        }
                                                    }
                                                } catch (e) {
                                                    console.error('\u89E3\u6790\u7FFB\u8BD1\u83DC\u5355\u547D\u4EE4\u5931\u8D25:', e);
                                                }
                                            }
                                        }
                                    } catch (e) {
                                        console.error('CheekyChimp: \u89E6\u53D1\u7FFB\u8BD1\u5931\u8D25:', e);
                                        // \u56DE\u9000\uFF1A\u5982\u679C\u65E0\u6CD5\u89E6\u53D1\u5185\u90E8\u7FFB\u8BD1\uFF0C\u663E\u793A\u6D88\u606F
                                        alert('\u6C89\u6D78\u5F0F\u7FFB\u8BD1\u521D\u59CB\u5316\u4E2D\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u6216\u5237\u65B0\u9875\u9762');
                                    }
                                });
                                
                                console.log('CheekyChimp: \u5DF2\u6DFB\u52A0\u6C89\u6D78\u5F0F\u7FFB\u8BD1UI');
                            } catch (e) {
                                console.error('CheekyChimp: \u6DFB\u52A0\u6C89\u6D78\u5F0F\u7FFB\u8BD1UI\u5931\u8D25:', e);
                            }
                        };
                        
                        // \u521B\u5EFA\u76D1\u542C\u5668\u51FD\u6570\uFF0C\u7528\u4E8E\u786E\u4FDD\u811A\u672C\u80FD\u5728\u9875\u9762\u7684\u5404\u4E2A\u9636\u6BB5\u6B63\u786E\u6267\u884C
                        const setupTranslationEnvironment = () => {
                            // \u7ACB\u5373\u68C0\u67E5body\u662F\u5426\u5B58\u5728
                            if (document.body) {
                                // \u6DFB\u52A0\u521D\u59CB\u6309\u94AE
                                setTimeout(addTranslationButton, 500);
                            }
                            
                            // \u76D1\u542CDOMContentLoaded\u4E8B\u4EF6
                            window.addEventListener('DOMContentLoaded', () => {
                                console.log('CheekyChimp: DOMContentLoaded \u89E6\u53D1');
                                setTimeout(addTranslationButton, 500);
                            });
                            
                            // \u76D1\u542Cload\u4E8B\u4EF6
                            window.addEventListener('load', () => {
                                console.log('CheekyChimp: window.load \u89E6\u53D1');
                                setTimeout(addTranslationButton, 1000);
                            });
                            
                            // \u8BBE\u7F6EDOM\u89C2\u5BDF\u5668\u4EE5\u9632\u4E0A\u8FF0\u4E8B\u4EF6\u90FD\u4E0D\u89E6\u53D1
                            if (!document.body) {
                                console.log('CheekyChimp: \u8BBE\u7F6Ebody\u89C2\u5BDF\u5668');
                                const bodyObserver = new MutationObserver(() => {
                                    if (document.body) {
                                        bodyObserver.disconnect();
                                        setTimeout(addTranslationButton, 100);
                                    }
                                });
                                
                                bodyObserver.observe(document.documentElement || document, { childList: true, subtree: true });
                            }
                            
                            // \u8BBE\u7F6E\u8D85\u65F6\u68C0\u67E5
                            setTimeout(() => {
                                if (document.body && !document.getElementById('immersive-translate-button')) {
                                    console.log('CheekyChimp: \u8D85\u65F6\u68C0\u67E5\uFF0C\u5C1D\u8BD5\u6DFB\u52A0\u6309\u94AE');
                                    addTranslationButton();
                                }
                            }, 2000);
                            
                            // \u6DFB\u52A0\u6309\u94AE\u81EA\u52A8\u68C0\u67E5\u903B\u8F91\uFF0C\u786E\u4FDD\u6309\u94AE\u5B58\u5728
                            const checkButtonInterval = setInterval(() => {
                                if (document.body && !document.getElementById('immersive-translate-button')) {
                                    console.log('CheekyChimp: \u6C89\u6D78\u5F0F\u7FFB\u8BD1\u6309\u94AE\u4E0D\u5B58\u5728\uFF0C\u91CD\u65B0\u6DFB\u52A0');
                                    addTranslationButton();
                                }
                            }, 5000);
                            
                            // \u8BBE\u7F6E30\u79D2\u540E\u6E05\u9664\u68C0\u67E5\uFF0C\u907F\u514D\u65E0\u9650\u91CD\u8BD5
                            setTimeout(() => {
                                clearInterval(checkButtonInterval);
                            }, 30000);
                        };
                        
                        // \u542F\u52A8\u7FFB\u8BD1\u73AF\u5883
                        setupTranslationEnvironment();
                    }
                    
                    // \u6267\u884C\u5B9E\u9645\u811A\u672C
                    ${n}
                } catch(e) {
                    console.error('CheekyChimp: \u811A\u672C\u6267\u884C\u9519\u8BEF', e);
                }
            })();
        `}getScriptMetaStr(t){let e=[];return e.push("// ==UserScript=="),t.name&&e.push(`// @name ${t.name}`),t.namespace&&e.push(`// @namespace ${t.namespace}`),t.version&&e.push(`// @version ${t.version}`),t.description&&e.push(`// @description ${t.description}`),t.author&&e.push(`// @author ${t.author}`),t.homepage&&e.push(`// @homepage ${t.homepage}`),t.icon&&e.push(`// @icon ${t.icon}`),t.includes.forEach(n=>{e.push(`// @include ${n}`)}),t.matches.forEach(n=>{e.push(`// @match ${n}`)}),t.excludes.forEach(n=>{e.push(`// @exclude ${n}`)}),t.requires.forEach(n=>{e.push(`// @require ${n}`)}),t.resources.forEach(n=>{e.push(`// @resource ${n.name} ${n.url}`)}),t.runAt&&e.push(`// @run-at ${t.runAt}`),e.push("// ==/UserScript=="),e.join(`
`)}injectContentLoadedListener(t,e,n){n.length!==0&&(t instanceof HTMLIFrameElement?this.injectContentLoadedListenerForIframe(t,e,n):t.tagName==="WEBVIEW"&&this.injectContentLoadedListenerForWebView(t,e,n))}injectContentLoadedListenerForIframe(t,e,n){try{if(!t.contentWindow||!t.contentDocument){console.warn("\u65E0\u6CD5\u8BBF\u95EEiframe\u5185\u5BB9\u6765\u8BBE\u7F6EDOMContentLoaded\u76D1\u542C\u5668");let r=setInterval(()=>{try{t.contentDocument&&t.contentDocument.readyState==="interactive"&&(clearInterval(r),n.forEach(i=>this.injectScript(t,e,i)))}catch(i){clearInterval(r)}},100);setTimeout(()=>clearInterval(r),1e4);return}t.contentDocument.readyState==="loading"?t.contentDocument.addEventListener("DOMContentLoaded",async()=>{for(let r of n)await this.injectScript(t,e,r)}):n.forEach(r=>this.injectScript(t,e,r))}catch(r){console.error("\u8BBE\u7F6Eiframe\u7684DOMContentLoaded\u76D1\u542C\u5668\u5931\u8D25:",r),n.forEach(i=>this.injectScript(t,e,i))}}injectContentLoadedListenerForWebView(t,e,n){let r=`
            if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                    window.dispatchEvent(new CustomEvent('obsidian-cheekychimp-domcontentloaded'));
                });
            } else {
                // \u6587\u6863\u5DF2\u52A0\u8F7D\uFF0C\u7ACB\u5373\u89E6\u53D1\u4E8B\u4EF6
                window.dispatchEvent(new CustomEvent('obsidian-cheekychimp-domcontentloaded'));
            }
        `;this.executeScript(t,r);let i=a=>{n.forEach(c=>this.injectScript(t,e,c))};t.addEventListener("obsidian-cheekychimp-domcontentloaded",i),setTimeout(()=>{t.removeEventListener("obsidian-cheekychimp-domcontentloaded",i)},1e4)}injectLoadListener(t,e,n){n.length!==0&&(t instanceof HTMLIFrameElement?this.injectLoadListenerForIframe(t,e,n):t.tagName==="WEBVIEW"&&this.injectLoadListenerForWebView(t,e,n))}injectLoadListenerForIframe(t,e,n){try{t.addEventListener("load",async()=>{for(let r of n)await this.injectScript(t,e,r)}),t.contentDocument&&t.contentDocument.readyState==="complete"&&n.forEach(r=>this.injectScript(t,e,r))}catch(r){console.error("\u8BBE\u7F6Eiframe\u7684load\u76D1\u542C\u5668\u5931\u8D25:",r),setTimeout(()=>{n.forEach(i=>this.injectScript(t,e,i))},1e3)}}injectLoadListenerForWebView(t,e,n){let r=`
            if (document.readyState === 'complete') {
                // \u9875\u9762\u5DF2\u5B8C\u5168\u52A0\u8F7D\uFF0C\u7ACB\u5373\u89E6\u53D1\u4E8B\u4EF6
                window.dispatchEvent(new CustomEvent('obsidian-cheekychimp-load'));
            } else {
                // \u7B49\u5F85\u9875\u9762\u52A0\u8F7D\u5B8C\u6210
            window.addEventListener('load', function() {
                window.dispatchEvent(new CustomEvent('obsidian-cheekychimp-load'));
            });
            }
        `;this.executeScript(t,r);let i=a=>{n.forEach(c=>this.injectScript(t,e,c))};t.addEventListener("obsidian-cheekychimp-load",i),setTimeout(()=>{t.removeEventListener("obsidian-cheekychimp-load",i)},1e4)}executeScript(t,e){return new Promise((n,r)=>{try{t instanceof HTMLIFrameElement?this.executeScriptInIframe(t,e).then(n).catch(r):t.tagName==="WEBVIEW"?this.executeScriptInWebView(t,e).then(n).catch(r):(console.warn("\u4E0D\u652F\u6301\u7684webview\u7C7B\u578B:",t.tagName),r(new Error("\u4E0D\u652F\u6301\u7684webview\u7C7B\u578B")))}catch(i){console.error("\u6267\u884C\u811A\u672C\u65F6\u51FA\u9519:",i),r(i)}})}executeScriptInIframe(t,e){return new Promise((n,r)=>{var i;try{if(!t.contentWindow||!t.contentDocument){console.warn("CheekyChimp: \u65E0\u6CD5\u8BBF\u95EEiframe\u5185\u5BB9\uFF0C\u53EF\u80FD\u662F\u8DE8\u57DF\u9650\u5236"),this.tryExecuteViaURL(t,e).then(n).catch(r);return}try{let a=t.contentDocument.createElement("script");a.textContent=e,a.setAttribute("data-cheekychimp","true"),a.setAttribute("type","text/javascript"),console.log("CheekyChimp: \u6B63\u5728\u6CE8\u5165\u811A\u672C\u5230iframe"),t.contentDocument.head?(t.contentDocument.head.appendChild(a),console.log("CheekyChimp: \u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe head"),t.src.includes("bilibili.com")&&(console.log("CheekyChimp: \u68C0\u6D4B\u5230B\u7AD9\u9875\u9762\uFF0C\u8BBE\u7F6EDOM\u53D8\u5316\u76D1\u542C\u5668"),this.setupBilibiliSupport(t))):t.contentDocument.documentElement?(t.contentDocument.documentElement.appendChild(a),console.log("CheekyChimp: \u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe documentElement")):((i=t.contentDocument.body)==null||i.appendChild(a),console.log("CheekyChimp: \u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe body"))}catch(a){console.error("CheekyChimp: \u901A\u8FC7DOM\u65B9\u5F0F\u6CE8\u5165\u811A\u672C\u5931\u8D25:",a),this.tryExecuteViaEval(t,e).then(n).catch(r)}}catch(a){console.error("CheekyChimp: \u65E0\u6CD5\u5728iframe\u4E2D\u6267\u884C\u811A\u672C\uFF0C\u53EF\u80FD\u662F\u8DE8\u57DF\u9650\u5236:",a),this.tryExecuteViaURL(t,e).then(n).catch(r)}})}setupBilibiliSupport(t){try{if(!t.contentDocument)return;let e=new MutationObserver(n=>{var i;if((i=t.contentDocument)==null?void 0:i.querySelector(".bpx-player-ctrl-playbackrate")){console.log("CheekyChimp: B\u7AD9\u64AD\u653E\u5668\u5DF2\u52A0\u8F7D\uFF0C\u91CD\u65B0\u6267\u884C\u76F8\u5173\u811A\u672C");let a=t.src,c=this.scriptManager.findScriptsForUrl(a).filter(u=>u.matches.some(h=>h.includes("bilibili.com")));for(let u of c)this.injectScript(t,a,u);e.disconnect()}});e.observe(t.contentDocument.body,{childList:!0,subtree:!0}),console.log("CheekyChimp: \u5DF2\u8BBE\u7F6EB\u7AD9\u9875\u9762\u7684DOM\u76D1\u542C\u5668")}catch(e){console.error("CheekyChimp: \u8BBE\u7F6EB\u7AD9\u7279\u6B8A\u652F\u6301\u5931\u8D25:",e)}}tryExecuteViaEval(t,e){return new Promise((n,r)=>{try{if(t.contentWindow){console.log("CheekyChimp: \u5C1D\u8BD5\u901A\u8FC7eval\u65B9\u5F0F\u6267\u884C\u811A\u672C");try{let a=new Function(`
                            try {
                                if (window.frames[0] && window.frames[0].document) {
                                    var script = window.frames[0].document.createElement("script");
                                    script.textContent = ${JSON.stringify(e)};
                                    window.frames[0].document.head.appendChild(script);
                                    return true;
                                }
                            } catch(e) {
                                console.error("Injection error:", e);
                                return false;
                            }
                        `)();console.log("CheekyChimp: \u901A\u8FC7Function\u6784\u9020\u5668\u6CE8\u5165\u811A\u672C"+(a?"\u6210\u529F":"\u5931\u8D25")),n()}catch(i){console.error("CheekyChimp: Function\u6784\u9020\u5668\u6267\u884C\u5931\u8D25",i),r(i)}}}catch(i){console.error("CheekyChimp: \u901A\u8FC7eval\u6267\u884C\u811A\u672C\u5931\u8D25:",i),r(i)}})}tryExecuteViaURL(t,e){return new Promise((n,r)=>{try{console.log("CheekyChimp: \u5C1D\u8BD5\u901A\u8FC7URL\u65B9\u5F0F\u6CE8\u5165\u811A\u672C");let i=new Blob([e],{type:"text/javascript"}),a=URL.createObjectURL(i),c;try{t.contentDocument?c=t.contentDocument.createElement("script"):c=document.createElement("script")}catch(u){c=document.createElement("script")}c.src=a,c.type="text/javascript",c.setAttribute("data-cheekychimp","true");try{if(t.contentDocument&&t.contentDocument.head)t.contentDocument.head.appendChild(c),console.log("CheekyChimp: \u901A\u8FC7Blob URL\u6CE8\u5165\u811A\u672C\u5230head\u6210\u529F");else if(t.contentDocument&&t.contentDocument.body)t.contentDocument.body.appendChild(c),console.log("CheekyChimp: \u901A\u8FC7Blob URL\u6CE8\u5165\u811A\u672C\u5230body\u6210\u529F");else{let u=`<script src="${a}" type="text/javascript" data-cheekychimp="true"><\/script>`,h=document.createElement("iframe");h.style.display="none",h.onload=function(){var f;try{let o=h.contentDocument||((f=h.contentWindow)==null?void 0:f.document);o&&(o.open(),o.write(u),o.close(),console.log("CheekyChimp: \u901A\u8FC7\u6CE8\u5165iframe\u6267\u884C\u811A\u672C\u6210\u529F"))}catch(o){console.error("CheekyChimp: iframe\u6CE8\u5165\u5931\u8D25:",o),r(o)}},document.body.appendChild(h),console.log("CheekyChimp: \u521B\u5EFA\u6CE8\u5165\u7528iframe\u6210\u529F")}}catch(u){console.error("CheekyChimp: \u65E0\u6CD5\u901A\u8FC7Blob URL\u65B9\u5F0F\u6CE8\u5165:",u),r(u)}setTimeout(()=>URL.revokeObjectURL(a),5e3)}catch(i){console.error("CheekyChimp: \u901A\u8FC7URL\u6CE8\u5165\u5C1D\u8BD5\u5931\u8D25:",i),r(i)}})}executeScriptInWebView(t,e){return new Promise((n,r)=>{try{let i=t;typeof i.executeJavaScript=="function"?i.executeJavaScript(e).then(()=>n()).catch(a=>{console.warn("CheekyChimp: \u901A\u8FC7executeJavaScript\u6CE8\u5165\u5931\u8D25\uFF0C\u5C1D\u8BD5\u5907\u7528\u65B9\u6CD5",a),this.fallbackScriptInjection(t,e).then(n).catch(r)}):this.fallbackScriptInjection(t,e).then(n).catch(r)}catch(i){console.error("CheekyChimp: \u6267\u884C\u811A\u672C\u5931\u8D25:",i),r(i)}})}fallbackScriptInjection(t,e){return new Promise(async(n,r)=>{try{let i=t;if(typeof i.insertCSS=="function")try{await i.executeJavaScript(e),n();return}catch(a){console.warn("CheekyChimp: \u4F7F\u7528Electron webview\u65B9\u6CD5\u6CE8\u5165\u5931\u8D25",a)}try{if(i.contentWindow){let a=document.createElement("script");a.textContent=e,i.contentWindow.document.head.appendChild(a),n();return}}catch(a){console.warn("CheekyChimp: \u4F7F\u7528contentWindow\u6CE8\u5165\u5931\u8D25",a)}if(typeof i.send=="function")try{i.send("obsidian-cheekychimp-inject",{script:e,id:Math.random().toString(36).substr(2,9)}),n();return}catch(a){console.warn("CheekyChimp: \u4F7F\u7528\u4E8B\u4EF6\u4F20\u9012\u6CE8\u5165\u5931\u8D25",a)}r(new Error("CheekyChimp: \u6240\u6709\u6CE8\u5165\u65B9\u6CD5\u90FD\u5931\u8D25\u4E86"))}catch(i){console.error("CheekyChimp: \u5907\u7528\u6CE8\u5165\u65B9\u6CD5\u5931\u8D25:",i),r(i)}})}registerMenuCommand(t,e,n,r){try{let i=Date.now()+Math.floor(Math.random()*1e3),a=`tampermonkey_commands:${t.id}`,c=[];try{let h=localStorage.getItem(a);h&&(c=JSON.parse(h))}catch(h){console.error("\u89E3\u6790\u4FDD\u5B58\u7684\u547D\u4EE4\u5931\u8D25:",h)}c.push({id:i,name:e,accessKey:r||""}),localStorage.setItem(a,JSON.stringify(c)),document.addEventListener(`cheekychimp-run-command-${i}`,()=>{try{n()}catch(h){console.error(`CheekyChimp: \u6267\u884C\u547D\u4EE4 "${e}" \u5931\u8D25:`,h)}});let u=new CustomEvent("cheekychimp-command-registered",{detail:{scriptId:t.id,commandId:i,name:e}});return document.dispatchEvent(u),console.log(`CheekyChimp: \u5DF2\u6CE8\u518C\u83DC\u5355\u547D\u4EE4 "${e}"`),i}catch(i){return console.error(`CheekyChimp: \u6CE8\u518C\u83DC\u5355\u547D\u4EE4 "${e}" \u5931\u8D25:`,i),-1}}extractConnectDomains(t){let e=/\/\/\s*@connect\s+([^\s]+)/g,n=[],r;for(;(r=e.exec(t))!==null;)r[1]&&n.push(r[1].trim());n.push("localhost"),n.push("127.0.0.1");try{let i=window.location.hostname;i&&n.push(i)}catch(i){console.warn("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u57DF\u540D:",i)}return[...new Set(n)]}isConnectAllowed(t,e){if(e.length===0||e.includes(t))return!0;for(let n of e)if(n.startsWith("*.")&&t.endsWith(n.substring(1)))return!0;return!1}generateSimpleGMAPIs(){return`
        // GM \u5B58\u50A8 API
        window.GM_getValue = function(key, defaultValue) {
            try {
                const storedValue = localStorage.getItem('GM_' + key);
                return storedValue === null ? defaultValue : JSON.parse(storedValue);
            } catch (e) {
                console.error('GM_getValue error:', e);
                return defaultValue;
            }
        };
        
        window.GM_setValue = function(key, value) {
            try {
                localStorage.setItem('GM_' + key, JSON.stringify(value));
            } catch (e) {
                console.error('GM_setValue error:', e);
            }
        };
        
        window.GM_deleteValue = function(key) {
            try {
                localStorage.removeItem('GM_' + key);
            } catch (e) {
                console.error('GM_deleteValue error:', e);
            }
        };
        
        window.GM_listValues = function() {
            try {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('GM_')) {
                        keys.push(key.substring(3));
                    }
                }
                return keys;
            } catch (e) {
                console.error('GM_listValues error:', e);
                return [];
            }
        };
        
        // GM_getResourceText API
        window.GM_getResourceText = function(resourceName) {
            if (window._gmResourceCache && window._gmResourceCache[resourceName]) {
                return window._gmResourceCache[resourceName];
            }
            console.warn('Resource not found:', resourceName);
            return '';
        };
        
        // GM_registerMenuCommand API
        window._gmMenuCommands = [];
        window.GM_registerMenuCommand = function(name, callback, accessKey) {
            const id = Date.now() + Math.random();
            window._gmMenuCommands.push({
                id: id,
                name: name,
                callback: callback,
                accessKey: accessKey
            });
            
            // \u68C0\u67E5\u662F\u5426\u9700\u8981\u521B\u5EFA\u83DC\u5355UI
            if (window._gmMenuCommands.length === 1) {
                // \u5728\u9875\u9762\u4E0A\u521B\u5EFA\u4E00\u4E2A\u7B80\u5355\u7684\u83DC\u5355\u6309\u94AE
                setTimeout(function() {
                    try {
                        // \u53EA\u5728\u9876\u7EA7\u7A97\u53E3\u521B\u5EFAUI
                        if (window.self !== window.top) return;
                        
                        // \u521B\u5EFA\u83DC\u5355\u5BB9\u5668
                        const menuContainer = document.createElement('div');
                        menuContainer.id = 'gm-menu-container';
                        menuContainer.style.cssText = 'position:fixed;top:10px;right:10px;z-index:9999;display:none;background:#fff;border-radius:5px;box-shadow:0 0 10px rgba(0,0,0,0.2);padding:5px 0;';
                        
                        // \u521B\u5EFA\u83DC\u5355\u6309\u94AE - \u6539\u4E3A\u534A\u9690\u85CF\u5F0F\u8BBE\u8BA1
                        const menuButton = document.createElement('div');
                        menuButton.id = 'gm-menu-button';
                        menuButton.innerHTML = '\u2699\uFE0F';
                        menuButton.title = 'UserScript Menu';
                        menuButton.style.cssText = 'position:fixed;top:10px;right:-20px;z-index:10000;cursor:pointer;background:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 5px rgba(0,0,0,0.2);transition:right 0.3s ease;opacity:0.85;';
                        
                        // \u521B\u5EFA\u4E00\u4E2A\u89E6\u53D1\u533A\u57DF
                        const triggerZone = document.createElement('div');
                        triggerZone.id = 'gm-trigger-zone';
                        triggerZone.style.cssText = 'position:fixed;top:0;right:0;width:30px;height:50px;z-index:9999;';
                        
                        // \u6DFB\u52A0\u5230\u6587\u6863
                        document.body.appendChild(menuContainer);
                        document.body.appendChild(menuButton);
                        document.body.appendChild(triggerZone);
                        
                        // \u9F20\u6807\u79FB\u5165\u89E6\u53D1\u533A\u57DF\u6216\u6309\u94AE\u65F6\u663E\u793A\u5B8C\u6574\u6309\u94AE
                        const showFullButton = function() {
                            menuButton.style.right = '10px';
                        };
                        
                        // \u9F20\u6807\u79FB\u51FA\u533A\u57DF\u65F6\u534A\u9690\u85CF\u6309\u94AE\uFF08\u9664\u975E\u83DC\u5355\u5DF2\u6253\u5F00\uFF09
                        const hidePartialButton = function() {
                            if (menuContainer.style.display !== 'block') {
                                menuButton.style.right = '-20px';
                            }
                        };
                        
                        triggerZone.addEventListener('mouseenter', showFullButton);
                        triggerZone.addEventListener('mouseleave', hidePartialButton);
                        menuButton.addEventListener('mouseenter', showFullButton);
                        menuButton.addEventListener('mouseleave', hidePartialButton);
                        
                        // \u70B9\u51FB\u6309\u94AE\u663E\u793A/\u9690\u85CF\u83DC\u5355
                        menuButton.addEventListener('click', function() {
                            const isVisible = menuContainer.style.display === 'block';
                            menuContainer.style.display = isVisible ? 'none' : 'block';
                            
                            // \u5982\u679C\u83DC\u5355\u5173\u95ED\u4E14\u9F20\u6807\u4E0D\u5728\u89E6\u53D1\u533A\u57DF\u6216\u6309\u94AE\u4E0A\uFF0C\u5219\u518D\u6B21\u534A\u9690\u85CF\u6309\u94AE
                            if (isVisible) {
                                // \u68C0\u67E5\u9F20\u6807\u662F\u5426\u5728\u89E6\u53D1\u533A\u57DF\u6216\u6309\u94AE\u4E0A
                                const checkMousePos = function(e) {
                                    const triggerRect = triggerZone.getBoundingClientRect();
                                    const buttonRect = menuButton.getBoundingClientRect();
                                    
                                    const mouseInTrigger = (
                                        e.clientX >= triggerRect.left && 
                                        e.clientX <= triggerRect.right && 
                                        e.clientY >= triggerRect.top && 
                                        e.clientY <= triggerRect.bottom
                                    );
                                    
                                    const mouseInButton = (
                                        e.clientX >= buttonRect.left && 
                                        e.clientX <= buttonRect.right && 
                                        e.clientY >= buttonRect.top && 
                                        e.clientY <= buttonRect.bottom
                                    );
                                    
                                    if (!mouseInTrigger && !mouseInButton) {
                                        hidePartialButton();
                                        document.removeEventListener('mousemove', checkMousePos);
                                    }
                                };
                                
                                // \u6DFB\u52A0\u4E00\u6B21\u6027\u68C0\u67E5
                                setTimeout(() => {
                                    document.addEventListener('mousemove', checkMousePos, { once: true });
                                }, 100);
                            }
                            
                            if (!isVisible) {
                                // \u6E05\u9664\u65E7\u83DC\u5355\u9879
                                menuContainer.innerHTML = '';
                                
                                // \u6DFB\u52A0\u83DC\u5355\u9879
                                window._gmMenuCommands.forEach(function(command) {
                                    const menuItem = document.createElement('div');
                                    menuItem.className = 'gm-menu-item';
                                    menuItem.textContent = command.name;
                                    menuItem.style.cssText = 'padding:8px 15px;cursor:pointer;white-space:nowrap;';
                                    menuItem.addEventListener('click', function() {
                                        menuContainer.style.display = 'none';
                                        command.callback();
                                    });
                                    menuItem.addEventListener('mouseenter', function() {
                                        this.style.backgroundColor = '#f0f0f0';
                                    });
                                    menuItem.addEventListener('mouseleave', function() {
                                        this.style.backgroundColor = '';
                                    });
                                    menuContainer.appendChild(menuItem);
                                });
                            }
                        });
                        
                        // \u70B9\u51FB\u9875\u9762\u5176\u4ED6\u5730\u65B9\u5173\u95ED\u83DC\u5355
                        document.addEventListener('click', function(e) {
                            if (e.target !== menuButton && !menuContainer.contains(e.target)) {
                                menuContainer.style.display = 'none';
                            }
                        });
                    } catch(e) {
                        console.error('\u521B\u5EFAGM\u83DC\u5355\u5931\u8D25:', e);
                    }
                }, 1000);
            }
            
            return id;
        };
        
        // GM_xmlhttpRequest API - \u7B80\u5316\u7248
        window.GM_xmlhttpRequest = function(details) {
            return new Promise((resolve, reject) => {
                try {
                    const xhr = new XMLHttpRequest();
                    
                    xhr.open(details.method || 'GET', details.url, true);
                    
                    if (details.responseType) {
                        xhr.responseType = details.responseType;
                    }
                    
                    if (details.timeout) {
                        xhr.timeout = details.timeout;
                    }
                    
                    if (details.headers) {
                        for (const [key, value] of Object.entries(details.headers)) {
                            xhr.setRequestHeader(key, String(value));
                        }
                    }
                    
                    if (details.overrideMimeType) {
                        xhr.overrideMimeType(details.overrideMimeType);
                    }
                    
                    xhr.onload = function() {
                        const response = {
                            responseText: xhr.responseText,
                            response: xhr.response,
                            status: xhr.status,
                            statusText: xhr.statusText,
                            readyState: xhr.readyState,
                            responseHeaders: xhr.getAllResponseHeaders(),
                            finalUrl: details.url
                        };
                        
                        if (typeof details.onload === 'function') {
                            details.onload(response);
                        }
                        
                        resolve(response);
                    };
                    
                    xhr.onerror = function(error) {
                        if (typeof details.onerror === 'function') {
                            details.onerror(error);
                        }
                        reject(error);
                    };
                    
                    xhr.send(details.data);
                } catch (error) {
                    if (typeof details.onerror === 'function') {
                        details.onerror(error);
                    }
                    reject(error);
                }
            });
        };
        
        // \u521B\u5EFA\u65B0\u7684\u5B9E\u4F8B\u65B9\u6CD5\uFF0C\u4E0D\u4F7F\u7528\u539F\u578B\u6269\u5C55
        window.GM = {
            getValue: function(name, defaultValue) {
                return Promise.resolve(GM_getValue(name, defaultValue));
            },
            setValue: function(name, value) {
                GM_setValue(name, value);
                return Promise.resolve();
            },
            deleteValue: function(name) {
                GM_deleteValue(name);
                return Promise.resolve();
            },
            listValues: function() {
                return Promise.resolve(GM_listValues());
            },
            getResourceText: function(name) {
                return Promise.resolve(GM_getResourceText(name));
            },
            xmlHttpRequest: window.GM_xmlhttpRequest,
            registerMenuCommand: window.GM_registerMenuCommand,
            info: {
                scriptHandler: 'Obsidian CheekyChimp',
                version: '0.1.0'
            }
        };

        console.log('[CheekyChimp] GM APIs \u521D\u59CB\u5316\u5B8C\u6210');
        `}extractResources(t){let e={requires:[],resources:[]},n=Array.from(t.source.matchAll(/\/\/ @require\s+(https?:\/\/\S+)/g)),r=Array.from(t.source.matchAll(/\/\/ @resource\s+(\S+)\s+(https?:\/\/\S+)/g));return n.forEach(i=>{i[1]&&e.requires.push(i[1])}),r.forEach(i=>{i[1]&&i[2]&&e.resources.push({name:i[1],url:i[2]})}),t.requires&&Array.isArray(t.requires)&&(e.requires=[...new Set([...e.requires,...t.requires])]),t.resources&&typeof t.resources=="object"&&Object.entries(t.resources).forEach(([i,a])=>{typeof a=="string"&&e.resources.push({name:i,url:a})}),e}async loadExternalResource(t){if(this.resourceCache[t])return this.resourceCache[t];try{console.log(`CheekyChimp: \u52A0\u8F7D\u5916\u90E8\u8D44\u6E90 ${t}`);let e=await fetch(t,{cache:"force-cache",headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);let n=await e.text();return this.resourceCache[t]=n,console.log(`CheekyChimp: \u5DF2\u52A0\u8F7D\u8D44\u6E90 ${t}`),n}catch(e){return console.error(`CheekyChimp: \u52A0\u8F7D\u8D44\u6E90\u5931\u8D25 ${t}:`,e),""}}async preprocessScript(t){let{requires:e,resources:n}=this.extractResources(t),r=t.source,i="";for(let c of n)try{let u=await this.loadExternalResource(c.url);i+=`
                // \u6CE8\u5165\u8D44\u6E90: ${c.name} \u4ECE ${c.url}
                if (!window._gmResourceCache) window._gmResourceCache = {};
                window._gmResourceCache['${c.name}'] = ${JSON.stringify(u)};
                
                // \u6DFB\u52A0GM_getResourceText\u652F\u6301
                if (!window.GM_getResourceText) {
                    window.GM_getResourceText = function(resourceName) {
                        return window._gmResourceCache[resourceName] || '';
                    };
                }
                `}catch(u){console.error(`CheekyChimp: \u5904\u7406\u8D44\u6E90\u5931\u8D25 ${c.name}:`,u)}let a="";for(let c of e)try{let u=await this.loadExternalResource(c);a+=`
                // \u6CE8\u5165\u4F9D\u8D56: ${c}
                try {
                    ${u}
                } catch(e) {
                    console.error('CheekyChimp: \u6267\u884C\u4F9D\u8D56\u811A\u672C\u5931\u8D25:', e);
                }
                `}catch(u){console.error(`CheekyChimp: \u5904\u7406\u4F9D\u8D56\u5931\u8D25 ${c}:`,u)}return`
        // ==UserScript \u9884\u5904\u7406\u4EE3\u7801==
        (function() {
            // \u8D44\u6E90\u548C\u4F9D\u8D56\u521D\u59CB\u5316
            ${i}
            
            // \u5916\u90E8\u4F9D\u8D56
            ${a}
            
            // \u539F\u59CB\u811A\u672C
            ${r}
        })();
        `}};var G=class{constructor(){this.translations={zh:{plugin_name:"CheekyChimp",plugin_description:"Obsidian\u7528\u6237\u811A\u672C\u7BA1\u7406\u5668",settings:"\u8BBE\u7F6E",scripts_manager:"\u811A\u672C\u7BA1\u7406\u5668",add_script:"\u6DFB\u52A0\u811A\u672C",import_script:"\u5BFC\u5165\u811A\u672C",create_script:"\u521B\u5EFA\u811A\u672C",edit_script:"\u7F16\u8F91\u811A\u672C",delete_script:"\u5220\u9664\u811A\u672C",enable_script:"\u542F\u7528\u811A\u672C",disable_script:"\u7981\u7528\u811A\u672C",script_settings:"\u811A\u672C\u8BBE\u7F6E",active_scripts:"\u5DF2\u542F\u7528\u7684\u811A\u672C",no_active_scripts:"\u5F53\u524D\u6CA1\u6709\u542F\u7528\u7684\u811A\u672C",script_added:"\u811A\u672C\u5DF2\u6DFB\u52A0",script_updated:"\u811A\u672C\u5DF2\u66F4\u65B0",script_deleted:"\u811A\u672C\u5DF2\u5220\u9664",script_enabled:"\u811A\u672C\u5DF2\u542F\u7528",script_disabled:"\u811A\u672C\u5DF2\u7981\u7528",script_error:"\u811A\u672C\u9519\u8BEF",script_load_error:"\u52A0\u8F7D\u811A\u672C\u5931\u8D25",script_execute_error:"\u6267\u884C\u811A\u672C\u5931\u8D25",error_script_exists:"\u5DF2\u5B58\u5728\u540C\u540D\u811A\u672C",error_invalid_script:"\u65E0\u6548\u7684\u811A\u672C",error_script_not_found:"\u672A\u627E\u5230\u811A\u672C",error_cross_origin:"\u8DE8\u57DF\u8BF7\u6C42\u5931\u8D25",error_injection_failed:"\u6CE8\u5165\u811A\u672C\u5931\u8D25",confirm_delete:"\u786E\u5B9A\u8981\u5220\u9664\u6B64\u811A\u672C\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002",confirm_yes:"\u662F",confirm_no:"\u5426",confirm_cancel:"\u53D6\u6D88",log_injecting:"\u6B63\u5728\u6CE8\u5165\u811A\u672C",log_injection_success:"\u811A\u672C\u6CE8\u5165\u6210\u529F",log_injection_failure:"\u811A\u672C\u6CE8\u5165\u5931\u8D25"},en:{plugin_name:"CheekyChimp",plugin_description:"UserScript Manager for Obsidian",settings:"Settings",scripts_manager:"Script Manager",add_script:"Add Script",import_script:"Import Script",create_script:"Create Script",edit_script:"Edit Script",delete_script:"Delete Script",enable_script:"Enable Script",disable_script:"Disable Script",script_settings:"Script Settings",active_scripts:"Active Scripts",no_active_scripts:"No active scripts",script_added:"Script added",script_updated:"Script updated",script_deleted:"Script deleted",script_enabled:"Script enabled",script_disabled:"Script disabled",script_error:"Script error",script_load_error:"Failed to load script",script_execute_error:"Failed to execute script",error_script_exists:"Script with the same name already exists",error_invalid_script:"Invalid script",error_script_not_found:"Script not found",error_cross_origin:"Cross-origin request failed",error_injection_failed:"Script injection failed",confirm_delete:"Are you sure you want to delete this script? This cannot be undone.",confirm_yes:"Yes",confirm_no:"No",confirm_cancel:"Cancel",log_injecting:"Injecting script",log_injection_success:"Script injection successful",log_injection_failure:"Script injection failed"}};this.currentLanguage="zh";this.detectLanguage()}detectLanguage(){try{let t=window.navigator.language;t.startsWith("zh")?this.currentLanguage="zh":this.currentLanguage="en",console.log(`CheekyChimp: \u68C0\u6D4B\u5230\u7CFB\u7EDF\u8BED\u8A00: ${t}, \u4F7F\u7528: ${this.currentLanguage}`)}catch(t){console.warn("CheekyChimp: \u65E0\u6CD5\u68C0\u6D4B\u7CFB\u7EDF\u8BED\u8A00\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u8BED\u8A00(zh)"),this.currentLanguage="zh"}}setLanguage(t){this.translations[t]?this.currentLanguage=t:(console.warn(`CheekyChimp: \u4E0D\u652F\u6301\u7684\u8BED\u8A00 ${t}, \u4F7F\u7528\u9ED8\u8BA4\u8BED\u8A00(zh)`),this.currentLanguage="zh")}getLanguage(){return this.currentLanguage}t(t,e){let r=(this.translations[this.currentLanguage]||this.translations.zh)[t]||t;return e&&Object.keys(e).forEach(i=>{r=r.replace(`{${i}}`,e[i])}),r}},b=new G;var I=class extends C.Plugin{async onload(){console.log("Loading CheekyChimp plugin"),this.scriptStorage=new L(this),this.scriptManager=new M,this.scriptInjector=new _(this.scriptStorage,this.scriptManager),await this.loadSettings(),this.settingTab=new k(this.app,this),this.addSettingTab(this.settingTab),this.scriptManager.loadScripts(this.settings.scripts),this.registerScriptManagerEvents(),this.registerWebviewHandlers(),(0,C.addIcon)("cheekychimp",`<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
            <path fill="currentColor" d="M 108.11719 0 L 0 108.11914 L 0 403.88086 L 108.11719 512 L 403.88281 512 L 512 403.88086 L 512 108.11914 L 403.88281 0 L 108.11719 0 z M 196.56055 128 L 315.43945 128 C 324.4555 128 332 135.5445 332 144.56055 L 332 196.56055 L 384 196.56055 C 393.0161 196.56055 400.56055 204.10499 400.56055 213.12109 L 400.56055 298.87891 C 400.56055 307.89501 393.0161 315.43945 384 315.43945 L 332 315.43945 L 332 367.43945 C 332 376.4555 324.4555 384 315.43945 384 L 196.56055 384 C 187.5445 384 180 376.4555 180 367.43945 L 180 315.43945 L 128 315.43945 C 118.98389 315.43945 111.43945 307.89501 111.43945 298.87891 L 111.43945 213.12109 C 111.43945 204.10499 118.98389 196.56055 128 196.56055 L 180 196.56055 L 180 144.56055 C 180 135.5445 187.5445 128 196.56055 128 z"/>
        </svg>`);let e=this.addRibbonIcon("cheekychimp","CheekyChimp",n=>{let r=this.scriptManager.getAllScripts().filter(i=>i.enabled);if(r.length>0){let i=r.map(a=>`- ${a.name}`).join(`
`);new C.Notice(`${b.t("active_scripts")} (${r.length}):
${i}`)}else new C.Notice(b.t("no_active_scripts"));this.openSettings()});this.editScriptHandler=n=>{var a;let i=(a=n.detail)==null?void 0:a.scriptId;i&&this.openScriptEditor(i)},this.createScriptHandler=n=>{var a;let i=(a=n.detail)==null?void 0:a.url;i&&this.createScriptForUrl(i)},document.addEventListener("cheekychimp-edit-script",this.editScriptHandler),document.addEventListener("cheekychimp-create-script",this.createScriptHandler)}onunload(){console.log("Unloading CheekyChimp plugin"),document.removeEventListener("cheekychimp-edit-script",this.editScriptHandler),document.removeEventListener("cheekychimp-create-script",this.createScriptHandler)}async loadSettings(){this.settings=Object.assign({},B,await this.loadData())}async saveSettings(){this.settings.scripts=this.scriptManager.getAllScripts(),await this.saveData(this.settings)}openSettings(){if(this.app.setting){this.app.setting.open();try{this.app.setting.openTabById("obsidian-cheekychimp")}catch(e){console.warn("\u65E0\u6CD5\u76F4\u63A5\u6253\u5F00CheekyChimp\u8BBE\u7F6E\u6807\u7B7E\uFF0C\u5C06\u6253\u5F00\u901A\u7528\u8BBE\u7F6E\u9875\u9762")}}else new C.Notice(b.t("error_open_settings"))}openScriptEditor(e){let n=this.scriptManager.getScript(e);n&&(this.openSettings(),new C.Notice(b.t("opening_script_editor",{name:n.name})))}createScriptForUrl(e){if(!e)return;let n=new URL(e).hostname,r=`// ==UserScript==
// @name         Script for ${n}
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  Add functionality to ${n}
// @author       You
// @match        ${e}
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    
    // Add your code here...
    console.log('CheekyChimp script running!');
})();`;try{let i=this.scriptManager.addScript(r);new C.Notice(b.t("script_created_for_domain",{domain:n})),this.openScriptEditor(i.id)}catch(i){console.error("\u521B\u5EFA\u811A\u672C\u5931\u8D25:",i),new C.Notice(b.t("error_creating_script"))}}registerScriptManagerEvents(){this.scriptManager.on("onScriptAdded",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptRemoved",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptUpdated",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptEnabled",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptDisabled",async()=>{await this.saveSettings()})}registerWebviewHandlers(){this.registerEvent(this.app.workspace.on("layout-change",()=>{this.checkForWebViews()})),this.checkForWebViews(),this.registerEvent(this.app.workspace.on("active-leaf-change",e=>{e&&this.handlePotentialWebViewLeaf(e)}))}checkForWebViews(){this.app.workspace.iterateAllLeaves(e=>{this.handlePotentialWebViewLeaf(e)})}handlePotentialWebViewLeaf(e){!e||!e.view||setTimeout(()=>{let n=e.view.containerEl;if(!n)return;n.querySelectorAll("iframe, webview").forEach(i=>{(i instanceof HTMLIFrameElement||i instanceof HTMLElement)&&this.setupWebViewListeners(i)})},500)}setupWebViewListeners(e){if(!e.hasAttribute("data-tampermonkey-processed"))if(e.setAttribute("data-tampermonkey-processed","true"),console.log("Tampermonkey: Webview detected",e.tagName),e instanceof HTMLIFrameElement){console.log("CheekyChimp: \u5904\u7406iframe\u5143\u7D20");let n="";try{n=e.src}catch(r){console.warn("CheekyChimp: \u65E0\u6CD5\u8BFB\u53D6iframe\u7684src\u5C5E\u6027",r),n=e.getAttribute("src")||""}e.addEventListener("load",()=>{try{let r="";try{r=e.src}catch(i){r=e.getAttribute("src")||""}r&&(console.log("CheekyChimp: iframe\u52A0\u8F7D\u5B8C\u6210\uFF0C\u6CE8\u5165\u811A\u672C\u5230",r),this.injectScriptsForUrl(e,r))}catch(r){console.error("CheekyChimp: \u5904\u7406iframe load\u4E8B\u4EF6\u51FA\u9519",r)}}),n&&(console.log("CheekyChimp: \u7ACB\u5373\u6CE8\u5165\u811A\u672C\u5230iframe:",n),this.injectScriptsForUrl(e,n))}else if(e.tagName==="WEBVIEW"||e.tagName==="IFRAME"){console.log("CheekyChimp: \u5904\u7406webview\u5143\u7D20");let n=e.getAttribute("src")||"";try{e.addEventListener("did-navigate",r=>{try{let i=r.url||e.getAttribute("src")||"";i&&(console.log("CheekyChimp: webview\u5BFC\u822A\u5230",i),this.injectScriptsForUrl(e,i))}catch(i){console.error("CheekyChimp: \u5904\u7406webview\u5BFC\u822A\u4E8B\u4EF6\u51FA\u9519",i)}}),e.addEventListener("load",()=>{try{let r=e.getAttribute("src")||"";r&&(console.log("CheekyChimp: webview\u52A0\u8F7D\u5B8C\u6210",r),this.injectScriptsForUrl(e,r))}catch(r){console.error("CheekyChimp: \u5904\u7406webview load\u4E8B\u4EF6\u51FA\u9519",r)}})}catch(r){console.warn("CheekyChimp: \u6DFB\u52A0webview\u4E8B\u4EF6\u76D1\u542C\u5668\u5931\u8D25",r)}n&&(console.log("CheekyChimp: \u7ACB\u5373\u6CE8\u5165\u811A\u672C\u5230webview:",n),setTimeout(()=>{this.injectScriptsForUrl(e,n)},500))}else console.log("CheekyChimp: \u5904\u7406\u672A\u77E5\u5143\u7D20\uFF0C\u67E5\u627E\u5185\u90E8iframe"),e.querySelectorAll("iframe, webview").forEach(r=>{r instanceof HTMLElement&&(console.log("CheekyChimp: \u627E\u5230\u5185\u90E8webview\u5143\u7D20"),this.setupWebViewListeners(r))})}injectScriptsForUrl(e,n){let r=this.scriptManager.findScriptsForUrl(n);r.length>0&&(console.log(`CheekyChimp: Found ${r.length} scripts for ${n}`),this.scriptInjector.injectScripts(e,n,r))}loadStyles(){document.body.classList.add("cheekychimp-enabled");let e=document.createElement("style");e.id="cheekychimp-ui-styles",e.textContent=`
            .cheekychimp-browser-ui {
                z-index: 9;
                opacity: 0.7;
                transition: opacity 0.3s ease;
            }
            
            .cheekychimp-browser-ui:hover {
                opacity: 1;
            }
            
            .cheekychimp-icon {
                opacity: 0.8;
                transition: all 0.2s ease;
                box-shadow: 0 0 5px rgba(0,0,0,0.1);
            }
            
            .cheekychimp-icon:hover {
                background-color: var(--interactive-hover) !important;
                transform: scale(1.1);
                opacity: 1;
            }
            
            .cheekychimp-menu {
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }
        `,document.head.appendChild(e)}};
