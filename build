/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository
*/

var P=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var Z=(l,t)=>{for(var e in t)P(l,e,{get:t[e],enumerable:!0})},X=(l,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of J(t))!K.call(l,r)&&r!==e&&P(l,r,{get:()=>t[r],enumerable:!(n=q(t,r))||n.enumerable});return l};var Y=l=>X(P({},"__esModule",{value:!0}),l);var Q={};Z(Q,{default:()=>U});module.exports=Y(Q);var b=require("obsidian");var p=require("obsidian");var w=class{constructor(){this.logs=[];this.maxLogEntries=1e3;this.verboseMode=!1;this.injectionLogs=[];this.maxInjectionLogs=100}static getInstance(){return w.instance||(w.instance=new w),w.instance}enableVerboseMode(){this.verboseMode=!0,this.debug("\u8BE6\u7EC6\u65E5\u5FD7\u6A21\u5F0F\u5DF2\u542F\u7528")}disableVerboseMode(){this.debug("\u8BE6\u7EC6\u65E5\u5FD7\u6A21\u5F0F\u5DF2\u7981\u7528"),this.verboseMode=!1}info(t,e){this.addLog("INFO",t,e),console.info(`[CheekyChimp:INFO] ${t}`,e||"")}debug(t,e){this.addLog("DEBUG",t,e),this.verboseMode&&console.debug(`[CheekyChimp:DEBUG] ${t}`,e||"")}warn(t,e){this.addLog("WARN",t,e),console.warn(`[CheekyChimp:WARN] ${t}`,e||"")}error(t,e){this.addLog("ERROR",t,e),console.error(`[CheekyChimp:ERROR] ${t}`,e||"")}logInjection(t,e,n,r){let i=`\u811A\u672C\u6CE8\u5165${n?"\u6210\u529F":"\u5931\u8D25"}: ${t}, URL: ${e}`;this.addLog(n?"INFO":"ERROR",i,r),this.addInjectionLog({timestamp:new Date().toISOString(),target:t,url:e,success:n,details:r}),n?console.info(`[CheekyChimp:INJECT] ${i}`):console.error(`[CheekyChimp:INJECT] ${i}`,r||"")}addInjectionLog(t){this.injectionLogs.length>=this.maxInjectionLogs&&this.injectionLogs.shift(),this.injectionLogs.push(t)}getInjectionLogs(){return[...this.injectionLogs]}clearLogs(){this.logs=[],this.injectionLogs=[],this.info("\u65E5\u5FD7\u5DF2\u6E05\u7A7A")}getLogs(){return[...this.logs]}exportLogsAsText(){let t=`===== CheekyChimp \u8C03\u8BD5\u65E5\u5FD7 =====
`;t+=`\u65F6\u95F4: ${new Date().toISOString()}
`,t+=`\u6D4F\u89C8\u5668\u4FE1\u606F: ${navigator.userAgent}
`,t+=`==============================

`,t+=`==== \u6CE8\u5165\u6458\u8981 ====
`;let e=this.injectionLogs.filter(i=>i.success).length,n=this.injectionLogs.filter(i=>!i.success).length;t+=`\u603B\u6CE8\u5165\u5C1D\u8BD5: ${this.injectionLogs.length}
`,t+=`\u6210\u529F\u6CE8\u5165: ${e}
`,t+=`\u5931\u8D25\u6CE8\u5165: ${n}

`;let r=this.injectionLogs.filter(i=>!i.success).slice(-5);return r.length>0&&(t+=`==== \u6700\u8FD1\u5931\u8D25\u7684\u6CE8\u5165 ====
`,r.forEach(i=>{if(t+=`[${i.timestamp}] \u76EE\u6807: ${i.target}, URL: ${i.url}
`,i.details)try{t+=`  \u8BE6\u60C5: ${typeof i.details=="string"?i.details:JSON.stringify(i.details,this.replacer,2)}
`}catch(c){t+=`  \u8BE6\u60C5: [\u65E0\u6CD5\u5E8F\u5217\u5316\u7684\u5BF9\u8C61]
`}t+=`
`}),t+=`
`),t+=`==== \u8BE6\u7EC6\u65E5\u5FD7 ====
`,this.logs.forEach(i=>{if(t+=`[${i.timestamp}] [${i.level}] ${i.message}
`,i.context)try{t+=`  \u8BE6\u60C5: ${typeof i.context=="string"?i.context:JSON.stringify(i.context,this.replacer,2)}
`}catch(c){t+=`  \u8BE6\u60C5: [\u65E0\u6CD5\u5E8F\u5217\u5316\u7684\u5BF9\u8C61]
`}t+=`
`}),t}exportLogsAsJSON(){return JSON.stringify({timestamp:new Date().toISOString(),userAgent:navigator.userAgent,injectionSummary:{total:this.injectionLogs.length,successful:this.injectionLogs.filter(t=>t.success).length,failed:this.injectionLogs.filter(t=>!t.success).length},recentFailures:this.injectionLogs.filter(t=>!t.success).slice(-5),logs:this.logs,injectionLogs:this.injectionLogs},this.replacer,2)}downloadLogs(t="text"){let e=t==="text"?this.exportLogsAsText():this.exportLogsAsJSON(),n=`cheekychimp-logs-${new Date().toISOString().replace(/:/g,"-")}.${t==="text"?"txt":"json"}`,r=new Blob([e],{type:t==="text"?"text/plain":"application/json"}),i=URL.createObjectURL(r),c=document.createElement("a");c.href=i,c.download=n,c.click(),URL.revokeObjectURL(i),this.info(`\u65E5\u5FD7\u5DF2\u4E0B\u8F7D\u4E3A: ${n}`)}addLog(t,e,n){this.logs.length>=this.maxLogEntries&&this.logs.shift(),this.logs.push({timestamp:new Date().toISOString(),level:t,message:e,context:n||null})}replacer(t,e){return e instanceof HTMLElement?`HTMLElement: ${e.tagName}${e.id?"#"+e.id:""}${e.className?"."+e.className.replace(/ /g,"."):""}`:e instanceof Error?{name:e.name,message:e.message,stack:e.stack}:typeof e=="function"?"[Function]":e instanceof Set||e instanceof Map?Array.from(e):e}},s=w.getInstance();var H={scripts:[],automaticallyCheckForUpdates:!0,updateInterval:24,debug:!1},$=class extends p.PluginSettingTab{constructor(e,n){super(e,n);this.plugin=n}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"CheekyChimp \u8BBE\u7F6E"}),e.createEl("p",{text:"\u8FD9\u4E2A\u63D2\u4EF6\u5141\u8BB8\u4F60\u5728Obsidian\u7684\u5185\u90E8\u6D4F\u89C8\u5668\u4E2D\u4F7F\u7528\u7528\u6237\u811A\u672C\u3002"}),e.createEl("h3",{text:"\u5E38\u89C4\u8BBE\u7F6E"}),new p.Setting(e).setName("\u81EA\u52A8\u68C0\u67E5\u66F4\u65B0").setDesc("\u5B9A\u671F\u68C0\u67E5\u7528\u6237\u811A\u672C\u7684\u66F4\u65B0").addToggle(r=>r.setValue(this.plugin.settings.automaticallyCheckForUpdates).onChange(async i=>{this.plugin.settings.automaticallyCheckForUpdates=i,await this.plugin.saveSettings()})),new p.Setting(e).setName("\u66F4\u65B0\u68C0\u67E5\u95F4\u9694").setDesc("\u68C0\u67E5\u811A\u672C\u66F4\u65B0\u7684\u95F4\u9694(\u5C0F\u65F6)").addSlider(r=>r.setLimits(1,168,1).setValue(this.plugin.settings.updateInterval).setDynamicTooltip().onChange(async i=>{this.plugin.settings.updateInterval=i,await this.plugin.saveSettings()})),new p.Setting(e).setName("\u8C03\u8BD5\u6A21\u5F0F").setDesc("\u542F\u7528\u8C03\u8BD5\u65E5\u5FD7").addToggle(r=>r.setValue(this.plugin.settings.debug).onChange(async i=>{this.plugin.settings.debug=i,i?s.enableVerboseMode():s.disableVerboseMode(),await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u811A\u672C\u7BA1\u7406"}),new p.Setting(e).setName("\u5BFC\u5165\u811A\u672C").setDesc("\u4ECE\u6587\u4EF6\u5BFC\u5165\u7528\u6237\u811A\u672C").addButton(r=>r.setButtonText("\u5BFC\u5165").setCta().onClick(i=>{this.importScript(i)})),new p.Setting(e).setName("\u521B\u5EFA\u65B0\u811A\u672C").setDesc("\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u7528\u6237\u811A\u672C").addButton(r=>r.setButtonText("\u521B\u5EFA").setCta().onClick(()=>{this.createScript()})),e.createEl("h3",{text:"\u5DF2\u5B89\u88C5\u7684\u811A\u672C"});let n=e.createDiv({cls:"cheekychimp-script-list"});this.plugin.settings.scripts.length===0?n.createEl("p",{text:'\u6CA1\u6709\u5DF2\u5B89\u88C5\u7684\u7528\u6237\u811A\u672C\u3002\u70B9\u51FB\u4E0A\u65B9\u7684"\u5BFC\u5165"\u6216"\u521B\u5EFA"\u6309\u94AE\u6765\u6DFB\u52A0\u811A\u672C\u3002'}):this.plugin.settings.scripts.forEach(r=>{this.createScriptItem(n,r)}),this.addDebugSection(e)}createScriptItem(e,n){let r=e.createDiv({cls:"cheekychimp-script-item"}),i=r.createDiv({cls:"cheekychimp-script-enabled"}),c=new p.Setting(i).setName("").addToggle(g=>g.setValue(n.enabled).onChange(async y=>{y?this.plugin.scriptManager.enableScript(n.id):this.plugin.scriptManager.disableScript(n.id),await this.plugin.saveSettings()})),o=r.createDiv({cls:"cheekychimp-script-name"}),a=o.createEl("div",{text:n.name,cls:"cheekychimp-script-name-text"});a.addEventListener("dblclick",()=>{let g=document.createElement("input");g.type="text",g.value=n.name,g.className="cheekychimp-script-name-edit",g.style.width="100%",a.replaceWith(g),g.focus(),g.select();let y=async()=>{let h=g.value.trim();if(h&&h!==n.name)try{let v=n.source,k=v.replace(/\/\/ @name\s+.*/,`// @name ${h}`);k!==v&&(this.plugin.scriptManager.updateScript(n.id,k),await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C\u540D\u79F0\u5DF2\u66F4\u65B0\u4E3A "${h}"`),this.display())}catch(v){new p.Notice(`\u66F4\u65B0\u811A\u672C\u540D\u79F0\u5931\u8D25: ${v.message}`),g.replaceWith(a)}else g.replaceWith(a)};g.addEventListener("blur",y),g.addEventListener("keydown",h=>{h.key==="Enter"?y():h.key==="Escape"&&g.replaceWith(a)})}),n.description&&o.createEl("div",{text:n.description,cls:"cheekychimp-script-description"});let d=r.createDiv({cls:"cheekychimp-script-actions"}),m=new p.ButtonComponent(d).setIcon("pencil").setTooltip("\u7F16\u8F91").onClick(()=>{this.editScript(n)}),f=new p.ButtonComponent(d).setIcon("trash").setTooltip("\u5220\u9664").onClick(()=>{this.deleteScript(n)})}async importScript(e){let n=new p.Menu;n.addItem(r=>{r.setTitle("\u4ECE\u6587\u4EF6\u5BFC\u5165").setIcon("folder").onClick(()=>{this.importFromFile()})}),n.addItem(r=>{r.setTitle("\u4ECEURL\u5BFC\u5165").setIcon("link").onClick(()=>{this.importFromUrl()})}),n.addItem(r=>{r.setTitle("\u4ECE\u7C98\u8D34\u677F\u5BFC\u5165").setIcon("clipboard").onClick(()=>{this.importFromClipboard()})}),n.showAtMouseEvent(e)}async importFromFile(){let e=document.createElement("input");e.type="file",e.accept=".js,.user.js",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",async n=>{let i=n.target.files;if(!i||i.length===0){document.body.removeChild(e);return}let c=i[0];try{let o=await this.readFileAsText(c);if(!o.includes("// ==UserScript==")||!o.includes("// ==/UserScript==")){new p.Notice("\u5BFC\u5165\u5931\u8D25\uFF1A\u65E0\u6548\u7684\u7528\u6237\u811A\u672C\u683C\u5F0F"),document.body.removeChild(e);return}let a=this.plugin.scriptManager.addScript(o);await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${a.name}" \u5DF2\u5BFC\u5165`),this.display()}catch(o){new p.Notice(`\u5BFC\u5165\u811A\u672C\u5931\u8D25: ${o.message}`)}finally{document.body.removeChild(e)}}),e.click()}async importFromUrl(){new F(this.app,async n=>{try{new p.Notice(`\u6B63\u5728\u4ECE ${n} \u4E0B\u8F7D\u811A\u672C...`);let r=await fetch(n);if(!r.ok)throw new Error(`\u8BF7\u6C42\u5931\u8D25: ${r.status} ${r.statusText}`);let i=await r.text();if(!i.includes("// ==UserScript==")||!i.includes("// ==/UserScript=="))throw new Error("\u4E0D\u662F\u6709\u6548\u7684\u7528\u6237\u811A\u672C\u683C\u5F0F");let c=this.plugin.scriptManager.addScript(i);await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${c.name}" \u5DF2\u5BFC\u5165`),this.display()}catch(r){new p.Notice(`\u5BFC\u5165\u811A\u672C\u5931\u8D25: ${r.message}`)}}).open()}async importFromClipboard(){new G(this.app,async n=>{try{if(!n.includes("// ==UserScript==")||!n.includes("// ==/UserScript=="))throw new Error("\u4E0D\u662F\u6709\u6548\u7684\u7528\u6237\u811A\u672C\u683C\u5F0F");let r=this.plugin.scriptManager.addScript(n);await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${r.name}" \u5DF2\u5BFC\u5165`),this.display()}catch(r){new p.Notice(`\u5BFC\u5165\u811A\u672C\u5931\u8D25: ${r.message}`)}}).open()}readFileAsText(e){return new Promise((n,r)=>{let i=new FileReader;i.onload=c=>{c.target?n(c.target.result):r(new Error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25"))},i.onerror=()=>{r(new Error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25"))},i.readAsText(e)})}async createScript(){let e=`// ==UserScript==
// @name        \u65B0\u811A\u672C
// @namespace   obsidian-cheekychimp
// @version     0.1
// @description \u5728\u6B64\u5904\u586B\u5199\u811A\u672C\u63CF\u8FF0
// @author      \u4F60\u7684\u540D\u5B57
// @match       *://*/*
// @grant       none
// ==/UserScript==

(function() {
    'use strict';
    
    // \u4F60\u7684\u4EE3\u7801\u5728\u8FD9\u91CC...
    console.log('Hello from Javascript!');
})();`;new j(this.app,e,async r=>{try{let i=this.plugin.scriptManager.addScript(r);await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${i.name}" \u5DF2\u521B\u5EFA`),this.display()}catch(i){new p.Notice(`\u521B\u5EFA\u811A\u672C\u5931\u8D25: ${i.message}`)}}).open()}async editScript(e){new j(this.app,e.source,async r=>{try{this.plugin.scriptManager.updateScript(e.id,r),await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${e.name}" \u5DF2\u66F4\u65B0`),this.display()}catch(i){new p.Notice(`\u66F4\u65B0\u811A\u672C\u5931\u8D25: ${i.message}`)}}).open()}async deleteScript(e){if(await new Promise(r=>{new N(this.app,`\u786E\u5B9A\u8981\u5220\u9664\u811A\u672C "${e.name}" \u5417\uFF1F`,r).open()}))try{this.plugin.scriptManager.removeScript(e.id),await this.plugin.saveSettings(),new p.Notice(`\u811A\u672C "${e.name}" \u5DF2\u5220\u9664`),this.display()}catch(r){new p.Notice(`\u5220\u9664\u811A\u672C\u5931\u8D25: ${r.message}`)}}addDebugSection(e){let n=e.createEl("div",{cls:"cheekychimp-debug-section"});n.createEl("h2",{text:"\u8C03\u8BD5\u5DE5\u5177"});let r=n.createEl("div",{cls:"cheekychimp-debug-container"}),i=r.createEl("div",{cls:"cheekychimp-export-container"});i.createEl("p",{text:"\u5982\u679C\u9047\u5230\u811A\u672C\u6CE8\u5165\u95EE\u9898\uFF0C\u60A8\u53EF\u4EE5\u5BFC\u51FA\u8C03\u8BD5\u65E5\u5FD7\u8FDB\u884C\u5206\u6790\u3002",cls:"setting-item-description"});let c=i.createEl("div",{cls:"cheekychimp-export-buttons"});c.createEl("button",{text:"\u5BFC\u51FA\u6587\u672C\u65E5\u5FD7",cls:"mod-cta"}).addEventListener("click",()=>{s.downloadLogs("text")}),c.createEl("button",{text:"\u5BFC\u51FAJSON\u65E5\u5FD7"}).addEventListener("click",()=>{s.downloadLogs("json")}),new p.Setting(r).setName("\u542F\u7528\u8BE6\u7EC6\u65E5\u5FD7").setDesc("\u8BB0\u5F55\u66F4\u591A\u8BE6\u7EC6\u7684\u8C03\u8BD5\u4FE1\u606F\uFF0C\u6709\u52A9\u4E8E\u6392\u67E5\u590D\u6742\u95EE\u9898").addToggle(m=>{m.setValue(this.plugin.settings.debug).onChange(async f=>{this.plugin.settings.debug=f,f?s.enableVerboseMode():s.disableVerboseMode(),await this.plugin.saveSettings()})}),r.createEl("button",{text:"\u6E05\u7A7A\u8C03\u8BD5\u65E5\u5FD7",cls:"cheekychimp-clear-logs"}).addEventListener("click",()=>{s.clearLogs(),new p.Notice("\u8C03\u8BD5\u65E5\u5FD7\u5DF2\u6E05\u7A7A")}),this.addDebugStyles()}addDebugStyles(){if(document.getElementById("cheekychimp-debug-styles"))return;let n=document.createElement("style");n.id="cheekychimp-debug-styles",n.textContent=`
            .cheekychimp-debug-section {
                margin-top: 30px;
                border-top: 1px solid var(--background-modifier-border);
                padding-top: 20px;
            }
            
            .cheekychimp-export-container {
                background: var(--background-secondary);
                border-radius: 5px;
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .cheekychimp-export-buttons {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }
            
            .cheekychimp-clear-logs {
                margin-top: 10px;
                color: var(--text-error);
            }
        `,document.head.appendChild(n)}},G=class extends p.Modal{constructor(e,n){super(e);this.content="";this.onSubmit=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cheekychimp-dialog"),e.createEl("h2",{text:"\u5BFC\u5165\u7528\u6237\u811A\u672C"}),e.createEl("p",{text:"\u7C98\u8D34\u7528\u6237\u811A\u672C\u5185\u5BB9:"}),e.createEl("textarea",{cls:"cheekychimp-editor"}).addEventListener("input",o=>{this.content=o.target.value});let r=e.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u5BFC\u5165",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.content){new p.Notice("\u8BF7\u8F93\u5165\u811A\u672C\u5185\u5BB9");return}this.onSubmit(this.content),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},j=class extends p.Modal{constructor(e,n,r){super(e);this.content=n,this.onSubmit=r}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cheekychimp-dialog"),e.style.width="500px",e.style.maxWidth="80vw",e.createEl("h2",{text:"\u7F16\u8F91\u7528\u6237\u811A\u672C"});let n=e.createEl("textarea",{cls:"cheekychimp-editor"});n.value=this.content,n.style.width="100%",n.style.height="500px",n.style.minHeight="400px",n.style.fontSize="14px",n.style.fontFamily="monospace",n.style.padding="10px",n.style.boxSizing="border-box",n.addEventListener("input",o=>{this.content=o.target.value});let r=e.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.content){new p.Notice("\u811A\u672C\u5185\u5BB9\u4E0D\u80FD\u4E3A\u7A7A");return}this.onSubmit(this.content),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},N=class extends p.Modal{constructor(e,n,r){super(e);this.message=n,this.onConfirm=r}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"\u786E\u8BA4"}),e.createEl("p",{text:this.message});let n=e.createDiv({cls:"modal-button-container"});n.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.onConfirm(!1),this.close()}),n.createEl("button",{text:"\u786E\u8BA4",cls:"mod-cta"}).addEventListener("click",()=>{this.onConfirm(!0),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}},F=class extends p.Modal{constructor(e,n){super(e);this.url="";this.onSubmit=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("cheekychimp-dialog"),e.createEl("h2",{text:"\u4ECEURL\u5BFC\u5165\u7528\u6237\u811A\u672C"}),e.createEl("p",{text:"\u8F93\u5165\u7528\u6237\u811A\u672C\u7684URL:"});let n=new p.TextComponent(e);n.setPlaceholder("https://example.com/userscript.user.js"),n.inputEl.addClass("cheekychimp-url-input"),n.inputEl.style.width="100%",n.onChange(o=>{this.url=o});let r=e.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"\u53D6\u6D88",cls:"mod-warning"}).addEventListener("click",()=>{this.close()}),r.createEl("button",{text:"\u5BFC\u5165",cls:"mod-cta"}).addEventListener("click",()=>{if(!this.url){new p.Notice("\u8BF7\u8F93\u5165\u6709\u6548\u7684URL");return}try{this.url.match(/^https?:\/\//)||(this.url="https://"+this.url),new URL(this.url)}catch(o){new p.Notice("\u8BF7\u8F93\u5165\u6709\u6548\u7684URL");return}this.onSubmit(this.url),this.close()})}onClose(){let{contentEl:e}=this;e.empty()}};var A=class{constructor(){this.id="",this.name="",this.namespace="",this.version="",this.description="",this.includes=[],this.matches=[],this.excludes=[],this.resources=[],this.requires=[],this.author="",this.homepage="",this.icon="",this.runAt="document-idle",this.enabled=!0,this.source="",this.lastUpdated=Date.now(),this.position=0}};var V=class{static getScriptId(t){var c;let e=Date.now().toString(36),n="",i=encodeURI(t).match(/[a-zA-Z0-9]/g);return i&&i.length>0?n=i.join(""):n=((c=btoa(t).match(/[a-zA-Z0-9]/g))==null?void 0:c.join(""))||"script",`${n}_${e}`}static parseScript(t){let e=new A;e.source=t;let n=t.indexOf(this.HEADER_START),r=t.indexOf(this.HEADER_END);if(n===-1||r===-1||r<=n)throw new Error("Invalid userscript: metadata block not found");let c=t.substring(n+this.HEADER_START.length,r).split(`
`),o=!1;for(let a of c){let d=a.trim();if(!d||!d.startsWith("//"))continue;let m=d.replace(/^\/\/\s*/,"").trim();if(!m.startsWith("@"))continue;let f=m.match(/@([a-zA-Z0-9_\-]+)\s+(.*)/);if(!f)continue;let[,g,y]=f,h=y.trim();switch(g){case"name":e.name=h,o=!0;break;case"namespace":e.namespace=h;break;case"version":e.version=h;break;case"description":e.description=h;break;case"author":e.author=h;break;case"homepage":case"website":case"source":e.homepage=h;break;case"icon":case"iconURL":case"defaulticon":e.icon=h;break;case"include":e.includes.push(h);break;case"match":e.matches.push(h);break;case"exclude":e.excludes.push(h);break;case"require":e.requires.push(h);break;case"resource":let v=h.match(/(\S+)\s+(.*)/);if(v){let[,k,z]=v;e.resources.push({name:k.trim(),url:z.trim()})}break;case"run-at":["document-start","document-end","document-idle"].includes(h)&&(e.runAt=h);break}}return(!o||!e.name)&&(e.name="\u672A\u547D\u540D\u811A\u672C",console.warn("\u811A\u672C\u6CA1\u6709\u540D\u79F0\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u540D\u79F0")),e.id=V.getScriptId(e.name),e}},S=V;S.HEADER_START="==UserScript==",S.HEADER_END="==/UserScript==";var _=class{constructor(){this.scripts=new Map;this.eventListeners={}}on(t,e){this.eventListeners[t]=e}getAllScripts(){return Array.from(this.scripts.values()).sort((t,e)=>t.position-e.position)}getScript(t){return this.scripts.get(t)}addScript(t){try{let e=S.parseScript(t);if(this.scripts.has(e.id))throw new Error(`Script with name '${e.name}' already exists`);return e.position=this.scripts.size,this.scripts.set(e.id,e),this.eventListeners.onScriptAdded&&this.eventListeners.onScriptAdded(e),e}catch(e){throw new Error(`Failed to add script: ${e.message}`)}}updateScript(t,e){if(!this.scripts.has(t))throw new Error(`Script with ID '${t}' not found`);try{let n=this.scripts.get(t),r=S.parseScript(e);return r.id=t,r.position=(n==null?void 0:n.position)||0,r.enabled=(n==null?void 0:n.enabled)||!0,r.lastUpdated=Date.now(),this.scripts.set(t,r),this.eventListeners.onScriptUpdated&&this.eventListeners.onScriptUpdated(r),r}catch(n){throw new Error(`Failed to update script: ${n.message}`)}}removeScript(t){if(!this.scripts.has(t))throw new Error(`Script with ID '${t}' not found`);this.scripts.delete(t),this.getAllScripts().forEach((n,r)=>{n.position=r}),this.eventListeners.onScriptRemoved&&this.eventListeners.onScriptRemoved(t)}enableScript(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);e.enabled=!0,this.eventListeners.onScriptEnabled&&this.eventListeners.onScriptEnabled(t)}disableScript(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);e.enabled=!1,this.eventListeners.onScriptDisabled&&this.eventListeners.onScriptDisabled(t)}findScriptsForUrl(t){let e=[];for(let n of this.getAllScripts()){if(!n.enabled)continue;let r=n.includes.length===0||n.includes.some(o=>this.matchUrlPattern(t,o)),i=n.excludes.some(o=>this.matchUrlPattern(t,o)),c=n.matches.length===0||n.matches.some(o=>this.matchUrlPattern(t,o));r&&!i&&c&&e.push(n)}return e.sort((n,r)=>n.position-r.position)}matchUrlPattern(t,e){if(e==="*")return!0;try{let n=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*");return n="^"+n+"$",new RegExp(n).test(t)}catch(n){return console.error(`Invalid pattern: ${e}`,n),!1}}loadScripts(t){this.scripts.clear(),t.forEach(e=>{this.scripts.set(e.id,e)})}moveScriptUp(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);if(e.position===0)return;let n=this.getAllScripts().find(r=>r.position===e.position-1);n&&(n.position++,e.position--,this.eventListeners.onScriptUpdated&&(this.eventListeners.onScriptUpdated(e),this.eventListeners.onScriptUpdated(n)))}moveScriptDown(t){let e=this.scripts.get(t);if(!e)throw new Error(`Script with ID '${t}' not found`);let n=this.getAllScripts();if(e.position===n.length-1)return;let r=n.find(i=>i.position===e.position+1);r&&(r.position--,e.position++,this.eventListeners.onScriptUpdated&&(this.eventListeners.onScriptUpdated(e),this.eventListeners.onScriptUpdated(r)))}};var R=class{constructor(t){this.cache=new Map;this.plugin=t}async getValue(t,e){if(this.cache.has(t))return this.cache.get(t);let n=await this.plugin.loadData()||{},r=t in n?n[t]:e;return this.cache.set(t,r),r}async setValue(t,e){this.cache.set(t,e);let n=await this.plugin.loadData()||{};n[t]=e,await this.plugin.saveData(n)}async deleteValue(t){this.cache.delete(t);let e=await this.plugin.loadData()||{};t in e&&(delete e[t],await this.plugin.saveData(e))}async listValues(){let t=await this.plugin.loadData()||{};return Object.keys(t)}clearCache(){this.cache.clear()}};function u(l){return`[CheekyChimp:${l}]`}function T(l){let t=new Set,e=/\/\/\s*@connect\s+([^\s]+)/g,n;for(;(n=e.exec(l))!==null;)t.add(n[1]);return l.includes("// @connect *")&&t.add("*"),Array.from(t)}function W(l,t){if(t.includes("*")||t.includes("localhost")||t.includes(l))return!0;for(let e of t){if(/^\d+\.\d+\.\d+\.\d+$/.test(e)){if(e===l)return!0;continue}if(l.endsWith("."+e))return!0}return!1}function B(l){let t=[];return t.push("// ==UserScript=="),t.push(`// @name ${l.name}`),l.namespace&&t.push(`// @namespace ${l.namespace}`),l.version&&t.push(`// @version ${l.version}`),l.description&&t.push(`// @description ${l.description}`),l.author&&t.push(`// @author ${l.author}`),l.includes.forEach(n=>{t.push(`// @include ${n}`)}),l.matches.forEach(n=>{t.push(`// @match ${n}`)}),l.excludes.forEach(n=>{t.push(`// @exclude ${n}`)}),l.requires.forEach(n=>{t.push(`// @require ${n}`)}),l.resources.forEach(n=>{t.push(`// @resource ${n.name} ${n.url}`)}),l.runAt&&t.push(`// @run-at ${l.runAt}`),T(l.source).forEach(n=>{t.push(`// @connect ${n}`)}),t.push("// @grant unsafeWindow"),t.push("// @grant GM_getValue"),t.push("// @grant GM_setValue"),t.push("// @grant GM_deleteValue"),t.push("// @grant GM_listValues"),t.push("// @grant GM_getResourceText"),t.push("// @grant GM_getResourceURL"),t.push("// @grant GM_addStyle"),t.push("// @grant GM_registerMenuCommand"),t.push("// @grant GM_unregisterMenuCommand"),t.push("// @grant GM_xmlhttpRequest"),t.push("// @grant GM_openInTab"),t.push("// @grant GM_setClipboard"),t.push("// @grant GM_notification"),t.push("// ==/UserScript=="),t.join(`
`)}function x(l,t){return!l.matches||l.matches.length===0||!l.enabled?!1:l.matches.some(e=>O(e,t))}function O(l,t){if(l.startsWith("/")&&l.endsWith("/"))try{return new RegExp(l.slice(1,-1)).test(t)}catch(e){return console.error(`\u65E0\u6548\u7684\u6B63\u5219\u8868\u8FBE\u5F0F: ${l}`,e),!1}try{let e=l.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&").replace(/\\\*/g,".*").replace(/\\\?/g,".");return new RegExp(`^${e}$`).test(t)}catch(e){return console.error(`\u65E0\u6548\u7684\u5339\u914D\u6A21\u5F0F: ${l}`,e),!1}}var E=class{constructor(t,e,n={iframe:{enabled:!0}}){this.scripts=t;this.gmApiFactory=e;this.options=n;this.iframeObserver=null;this.injectedIframes=new Set;this.scriptIds=new Set;s.debug("IframeInjector\u5DF2\u521B\u5EFA",{options:n})}async initialize(){var t;if(!((t=this.options.iframe)!=null&&t.enabled)){s.info("IframeInjector\uFF1Aiframe\u6CE8\u5165\u5DF2\u7981\u7528"),console.log(`${u("IframeInjector")}: iframe\u6CE8\u5165\u5DF2\u7981\u7528`);return}s.info("\u5F00\u59CB\u521D\u59CB\u5316IframeInjector"),await this.injectExistingIframes(),this.createIframeObserver(),s.info("IframeInjector\u521D\u59CB\u5316\u5B8C\u6210\uFF0C\u6B63\u5728\u76D1\u89C6iframe"),console.log(`${u("IframeInjector")}: \u5DF2\u521D\u59CB\u5316\uFF0C\u6B63\u5728\u76D1\u89C6iframe`)}cleanup(){s.debug("\u6E05\u7406IframeInjector\u8D44\u6E90"),this.iframeObserver&&(this.iframeObserver.disconnect(),this.iframeObserver=null),this.injectedIframes.clear(),this.scriptIds.clear(),s.info("IframeInjector\u8D44\u6E90\u5DF2\u6E05\u7406"),console.log(`${u("IframeInjector")}: \u8D44\u6E90\u5DF2\u6E05\u7406`)}async injectScript(t,e,n){if(s.debug(`\u5C1D\u8BD5\u6CE8\u5165\u811A\u672C: ${e.name}`,{targetTag:t.tagName,context:n}),!(t instanceof HTMLIFrameElement)){let r="\u76EE\u6807\u5143\u7D20\u4E0D\u662Fiframe";return s.error(r,{targetType:t.tagName,scriptName:e.name}),{success:!1,scriptIds:[],error:r}}try{let r=this.canAccessIframe(t);if(s.debug(`\u68C0\u67E5iframe\u53EF\u8BBF\u95EE\u6027: ${r?"\u53EF\u8BBF\u95EE":"\u4E0D\u53EF\u8BBF\u95EE"}`,{src:t.src,scriptName:e.name}),!r)return s.debug("iframe\u4E0D\u53EF\u76F4\u63A5\u8BBF\u95EE\uFF0C\u5C1D\u8BD5\u4F7F\u7528\u6D88\u606F\u4F20\u9012\u6CE8\u5165",{src:t.src,scriptName:e.name}),s.warn("\u65E0\u6CD5\u6CE8\u5165\u8DE8\u57DFiframe",{src:t.src,scriptName:e.name}),{success:!1,scriptIds:[],error:"\u65E0\u6CD5\u6CE8\u5165\u8DE8\u57DFiframe"};s.debug(`\u4E3A\u811A\u672C "${e.name}" \u521B\u5EFAGM API`,{url:n.url});let i=await this.gmApiFactory.createGmApi(e,n.url);s.debug("\u751F\u6210\u6CE8\u5165\u4EE3\u7801\u5305\u88C5\u5668");let c=this.gmApiFactory.createScriptWrapper(e,i,e.source);s.debug("\u5F00\u59CB\u6267\u884C\u811A\u672C\u6CE8\u5165",{scriptName:e.name,targetId:t.id||"\u65E0ID",url:n.url});let o=t.contentDocument;if(!o){let d="\u65E0\u6CD5\u8BBF\u95EEiframe\u5185\u5BB9";return s.error(d,{src:t.src,scriptName:e.name}),{success:!1,scriptIds:[],error:d}}let a=o.createElement("script");if(a.textContent=c,a.setAttribute("data-cheekychimp-injected","true"),a.setAttribute("data-script-id",e.id),o.head)o.head.appendChild(a),s.debug("\u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe\u7684head",{scriptName:e.name,iframeSrc:t.src});else if(o.body)o.body.appendChild(a),s.debug("\u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe\u7684body",{scriptName:e.name,iframeSrc:t.src});else{let d="iframe\u6587\u6863\u6CA1\u6709head\u6216body\u5143\u7D20";return s.error(d,{src:t.src,scriptName:e.name}),{success:!1,scriptIds:[],error:d}}return this.scriptIds.add(e.id),s.logInjection("iframe",n.url,!0,{scriptName:e.name,scriptId:e.id,targetId:t.id||"\u65E0ID",iframeSrc:t.src}),{success:!0,scriptIds:[e.id]}}catch(r){return s.error(`\u6CE8\u5165\u811A\u672C\u5931\u8D25: ${r instanceof Error?r.message:r}`,{scriptName:e.name,scriptId:e.id,url:n.url,iframeSrc:t.src,error:r}),console.error(`${u("IframeInjector")}: \u6CE8\u5165\u811A\u672C\u5931\u8D25:`,r),s.logInjection("iframe",n.url,!1,{scriptName:e.name,scriptId:e.id,iframeSrc:t.src,error:r instanceof Error?r.message:"\u672A\u77E5\u9519\u8BEF"}),{success:!1,scriptIds:[],error:r instanceof Error?r.message:"\u672A\u77E5\u9519\u8BEF"}}}async injectExistingIframes(){let t=document.querySelectorAll("iframe");if(s.info(`\u53D1\u73B0${t.length}\u4E2A\u73B0\u6709iframe`),console.log(`${u("IframeInjector")}: \u53D1\u73B0${t.length}\u4E2A\u73B0\u6709iframe`),t.length>0){let n=Array.from(t).map(r=>({id:r.id||"\u65E0ID",src:r.src||"\u65E0src",hasProcessed:r.hasAttribute("data-cheekychimp-processed"),canAccess:this.canAccessIframe(r)}));s.debug("iframe\u5217\u8868",n)}let e=Array.from(t).map(n=>this.injectScriptsIntoIframe(n));await Promise.all(e)}createIframeObserver(){s.debug("\u521B\u5EFAiframe\u89C2\u5BDF\u5668"),this.iframeObserver=new MutationObserver(t=>{let e=t.filter(n=>n.type==="childList"&&n.addedNodes.length>0||n.type==="attributes"&&n.attributeName==="src"&&n.target instanceof HTMLIFrameElement);e.length>0&&s.debug(`\u68C0\u6D4B\u5230${e.length}\u4E2A\u76F8\u5173DOM\u53D8\u5316`,{childListChanges:e.filter(n=>n.type==="childList").length,attributeChanges:e.filter(n=>n.type==="attributes").length});for(let n of t)if(n.type==="childList")n.addedNodes.forEach(r=>{if(r instanceof HTMLIFrameElement)s.debug("\u53D1\u73B0\u65B0\u6DFB\u52A0\u7684iframe\u5143\u7D20",{id:r.id||"\u65E0ID",src:r.src||"\u65E0src"}),this.injectScriptsIntoIframe(r);else if(r instanceof HTMLElement){let i=r.querySelectorAll("iframe");i.length>0&&(s.debug(`\u5728\u65B0\u6DFB\u52A0\u7684\u5143\u7D20\u4E2D\u53D1\u73B0${i.length}\u4E2Aiframe`),i.forEach(c=>{this.injectScriptsIntoIframe(c)}))}});else if(n.type==="attributes"&&n.attributeName==="src"&&n.target instanceof HTMLIFrameElement){let r=n.target,i=r.src;s.debug("\u68C0\u6D4B\u5230iframe src\u53D8\u5316",{newSrc:i,oldSrc:n.oldValue||"\u672A\u77E5",id:r.id||"\u65E0ID"}),console.log(`${u("IframeInjector")}: \u68C0\u6D4B\u5230iframe src\u53D8\u5316:`,r.src),this.injectedIframes.delete(r),this.injectScriptsIntoIframe(r)}}),this.iframeObserver.observe(document,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]}),s.info("iframe\u89C2\u5BDF\u5668\u5DF2\u542F\u52A8\uFF0C\u76D1\u89C6DOM\u53D8\u5316")}async injectScriptsIntoIframe(t){if(s.debug("\u5C1D\u8BD5\u6CE8\u5165\u811A\u672C\u5230iframe",{id:t.id||"\u65E0ID",src:t.src||"\u65E0src",processed:t.hasAttribute("data-cheekychimp-processed"),alreadyInjected:this.injectedIframes.has(t)}),this.injectedIframes.has(t))return s.debug("iframe\u5DF2\u7ECF\u88AB\u6CE8\u5165\u8FC7\uFF0C\u8DF3\u8FC7"),{success:!0,scriptIds:[]};t.setAttribute("data-cheekychimp-processed","true");try{if(!t.src||t.src==="about:blank")return s.debug("iframe\u7684src\u4E3A\u7A7A\u6216about:blank\uFF0C\u8DF3\u8FC7\u6CE8\u5165"),{success:!0,scriptIds:[]};if(!this.canAccessIframe(t))return s.warn("iframe\u8DE8\u57DF\u9650\u5236\uFF0C\u65E0\u6CD5\u76F4\u63A5\u6CE8\u5165",{src:t.src}),{success:!1,scriptIds:[],error:"\u8DE8\u57DFiframe\u65E0\u6CD5\u8BBF\u95EE"};let n=t.src;s.info(`\u51C6\u5907\u5411iframe(${n})\u6CE8\u5165\u811A\u672C`),console.log(`${u("IframeInjector")}: \u51C6\u5907\u5411iframe(${n})\u6CE8\u5165\u811A\u672C`);let r=[],i=0;for(let c of this.scripts)if(x(c,n)){i++,s.debug(`\u811A\u672C "${c.name}" \u5339\u914DURL: ${n}`);try{let a=await this.injectScript(t,c,{url:n,origin:new URL(n).origin,targetType:"iframe",stage:"document-start"});a.success?(r.push(c.id),s.debug(`\u6210\u529F\u6CE8\u5165\u811A\u672C "${c.name}" \u5230 ${n}`),console.log(`${u("IframeInjector")}: \u6210\u529F\u6CE8\u5165\u811A\u672C "${c.name}" \u5230 ${n}`)):(s.warn(`\u6CE8\u5165\u811A\u672C "${c.name}" \u5931\u8D25: ${a.error}`,{url:n,scriptId:c.id}),console.warn(`${u("IframeInjector")}: \u6CE8\u5165\u811A\u672C "${c.name}" \u5931\u8D25: ${a.error}`))}catch(a){s.error(`\u6CE8\u5165\u811A\u672C "${c.name}" \u65F6\u51FA\u9519: ${a instanceof Error?a.message:a}`,{url:n,scriptId:c.id,error:a}),console.error(`${u("IframeInjector")}: \u6CE8\u5165\u811A\u672C "${c.name}" \u65F6\u51FA\u9519:`,a)}}return i===0&&s.debug(`\u6CA1\u6709\u811A\u672C\u5339\u914DURL: ${n}`),this.injectedIframes.add(t),s.info(`\u5411iframe(${n})\u6CE8\u5165\u4E86${r.length}\u4E2A\u811A\u672C`),console.log(`${u("IframeInjector")}: \u5411iframe(${n})\u6CE8\u5165\u4E86${r.length}\u4E2A\u811A\u672C`),r.length>0?s.logInjection("iframe",n,!0,{scriptIds:r,totalMatched:i}):i>0&&s.logInjection("iframe",n,!1,{totalMatched:i,error:"\u6709\u5339\u914D\u7684\u811A\u672C\u4F46\u6CE8\u5165\u5931\u8D25"}),{success:!0,scriptIds:r}}catch(e){return s.error(`\u6CE8\u5165iframe\u5931\u8D25: ${e instanceof Error?e.message:e}`,{iframeSrc:t.src,error:e}),console.error(`${u("IframeInjector")}: \u6CE8\u5165iframe\u5931\u8D25:`,e),{success:!1,scriptIds:[],error:e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"}}}async injectIntoIframe(t){return s.debug("\u624B\u52A8\u6CE8\u5165\u811A\u672C\u5230\u6307\u5B9Aiframe",{src:t.src||"\u65E0src"}),this.injectScriptsIntoIframe(t)}canAccessIframe(t){try{let n=!!t.contentDocument;return s.debug(`\u68C0\u67E5iframe\u53EF\u8BBF\u95EE\u6027: ${n?"\u53EF\u8BBF\u95EE":"\u4E0D\u53EF\u8BBF\u95EE"}`,{src:t.src||"\u65E0src"}),n}catch(e){return s.warn("iframe\u8DE8\u57DF\u5F02\u5E38",{src:t.src,error:e}),!1}}getInjectedScriptIds(){return Array.from(this.scriptIds)}};var M=class{constructor(t,e,n={webview:{enabled:!0}}){this.scripts=t;this.gmApiFactory=e;this.options=n;this.webviewObserver=null;this.injectedWebviews=new Set;this.scriptIds=new Set;s.debug("WebviewInjector\u5DF2\u521B\u5EFA",{options:n})}async initialize(){var t;if(!((t=this.options.webview)!=null&&t.enabled)){s.info("WebviewInjector: webview\u6CE8\u5165\u5DF2\u7981\u7528"),console.log(`${u("WebviewInjector")}: webview\u6CE8\u5165\u5DF2\u7981\u7528`);return}s.info("\u5F00\u59CB\u521D\u59CB\u5316WebviewInjector"),await this.injectExistingWebviews(),this.createWebviewObserver(),s.info("WebviewInjector\u521D\u59CB\u5316\u5B8C\u6210\uFF0C\u6B63\u5728\u76D1\u89C6webview"),console.log(`${u("WebviewInjector")}: \u5DF2\u521D\u59CB\u5316\uFF0C\u6B63\u5728\u76D1\u89C6webview`)}cleanup(){s.debug("\u6E05\u7406WebviewInjector\u8D44\u6E90"),this.webviewObserver&&(this.webviewObserver.disconnect(),this.webviewObserver=null),this.injectedWebviews.clear(),this.scriptIds.clear(),s.info("WebviewInjector\u8D44\u6E90\u5DF2\u6E05\u7406"),console.log(`${u("WebviewInjector")}: \u8D44\u6E90\u5DF2\u6E05\u7406`)}async injectScript(t,e,n){if(s.debug(`\u5C1D\u8BD5\u6CE8\u5165\u811A\u672C: ${e.name}`,{targetTag:t.tagName,context:n}),!this.isWebviewElement(t)){let r="\u76EE\u6807\u5143\u7D20\u4E0D\u662Fwebview";return s.error(r,{targetType:t.tagName,scriptName:e.name}),{success:!1,scriptIds:[],error:r}}try{s.debug(`\u4E3A\u811A\u672C "${e.name}" \u521B\u5EFAGM API`,{url:n.url});let r=await this.gmApiFactory.createGmApi(e,n.url);s.debug("\u751F\u6210\u6CE8\u5165\u4EE3\u7801\u5305\u88C5\u5668");let i=this.gmApiFactory.createScriptWrapper(e,r,e.source);return s.debug("\u5F00\u59CB\u6267\u884C\u811A\u672C\u6CE8\u5165",{scriptName:e.name,targetId:t.id||"\u65E0ID",url:n.url}),await this.executeScriptInWebview(t,i),this.scriptIds.add(e.id),s.logInjection("webview",n.url,!0,{scriptName:e.name,scriptId:e.id,targetId:t.id||"\u65E0ID"}),{success:!0,scriptIds:[e.id]}}catch(r){return s.error(`\u6CE8\u5165\u811A\u672C\u5931\u8D25: ${r instanceof Error?r.message:r}`,{scriptName:e.name,scriptId:e.id,url:n.url,error:r}),console.error(`${u("WebviewInjector")}: \u6CE8\u5165\u811A\u672C\u5931\u8D25:`,r),s.logInjection("webview",n.url,!1,{scriptName:e.name,scriptId:e.id,error:r instanceof Error?r.message:"\u672A\u77E5\u9519\u8BEF"}),{success:!1,scriptIds:[],error:r instanceof Error?r.message:"\u672A\u77E5\u9519\u8BEF"}}}async injectExistingWebviews(){let t='webview, .webview, .obsidian-webview, [data-type="webview"]',e=document.querySelectorAll(t);if(s.info(`\u53D1\u73B0${e.length}\u4E2A\u73B0\u6709webview`),console.log(`${u("WebviewInjector")}: \u53D1\u73B0${e.length}\u4E2A\u73B0\u6709webview`),e.length>0){let r=Array.from(e).map(i=>i instanceof HTMLElement?{id:i.id||"\u65E0ID",tagName:i.tagName,type:i.getAttribute("data-type")||(i.classList.contains("webview")?"webview-class":"unknown"),src:i.getAttribute("src")||"\u65E0src",hasProcessed:i.hasAttribute("data-cheekychimp-processed")}:{tagName:i.nodeName,error:"\u4E0D\u662FHTMLElement"});s.debug("webview\u5217\u8868",r)}let n=Array.from(e).map(r=>r instanceof HTMLElement?this.injectScriptsIntoWebview(r):(s.warn(`\u53D1\u73B0\u65E0\u6548\u7684webview\u5143\u7D20: ${r.nodeName}`),Promise.resolve({success:!1,scriptIds:[],error:"\u65E0\u6548\u7684webview\u5143\u7D20"})));await Promise.all(n)}createWebviewObserver(){s.debug("\u521B\u5EFAwebview\u89C2\u5BDF\u5668"),this.webviewObserver=new MutationObserver(t=>{let e=t.filter(n=>n.type==="childList"&&n.addedNodes.length>0||n.type==="attributes"&&(n.attributeName==="src"||n.attributeName==="data-src")&&n.target instanceof HTMLElement&&this.isWebviewElement(n.target));e.length>0&&s.debug(`\u68C0\u6D4B\u5230${e.length}\u4E2A\u76F8\u5173DOM\u53D8\u5316`,{childListChanges:e.filter(n=>n.type==="childList").length,attributeChanges:e.filter(n=>n.type==="attributes").length});for(let n of t)if(n.type==="childList")n.addedNodes.forEach(r=>{if(r instanceof HTMLElement&&this.isWebviewElement(r))s.debug("\u53D1\u73B0\u65B0\u6DFB\u52A0\u7684webview\u5143\u7D20",{id:r.id||"\u65E0ID",tagName:r.tagName,src:r.getAttribute("src")||"\u65E0src"}),this.injectScriptsIntoWebview(r);else if(r instanceof HTMLElement){let i='webview, .webview, .obsidian-webview, [data-type="webview"]',c=r.querySelectorAll(i);c.length>0&&(s.debug(`\u5728\u65B0\u6DFB\u52A0\u7684\u5143\u7D20\u4E2D\u53D1\u73B0${c.length}\u4E2Awebview`),c.forEach(o=>{o instanceof HTMLElement&&this.injectScriptsIntoWebview(o)}))}});else if(n.type==="attributes"&&(n.attributeName==="src"||n.attributeName==="data-src")&&n.target instanceof HTMLElement&&this.isWebviewElement(n.target)){let r=n.target,i=r.getAttribute(n.attributeName||"");s.debug(`\u68C0\u6D4B\u5230webview ${n.attributeName} \u53D8\u5316`,{newValue:i,oldValue:n.oldValue||"\u672A\u77E5",id:r.id||"\u65E0ID",tagName:r.tagName}),console.log(`${u("WebviewInjector")}: \u68C0\u6D4B\u5230webview src\u53D8\u5316:`,n.target),this.injectedWebviews.delete(r),this.injectScriptsIntoWebview(r)}}),this.webviewObserver.observe(document,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","data-src"]}),s.info("webview\u89C2\u5BDF\u5668\u5DF2\u542F\u52A8\uFF0C\u76D1\u89C6DOM\u53D8\u5316")}isWebviewElement(t){return t.tagName.toLowerCase()==="webview"?(s.debug("\u786E\u8BA4\u5143\u7D20\u662Fwebview(\u6807\u7B7E\u540D)",{id:t.id||"\u65E0ID"}),!0):t.classList.contains("webview")||t.classList.contains("obsidian-webview")||t.getAttribute("data-type")==="webview"?(s.debug("\u786E\u8BA4\u5143\u7D20\u662Fwebview(\u7C7B\u540D\u6216data-type)",{id:t.id||"\u65E0ID",class:t.className,dataType:t.getAttribute("data-type")}),!0):"executeJavaScript"in t||"getURL"in t?(s.debug("\u786E\u8BA4\u5143\u7D20\u662Fwebview(\u7279\u6027\u68C0\u6D4B)",{id:t.id||"\u65E0ID"}),!0):!1}async injectScriptsIntoWebview(t){if(s.debug("\u5C1D\u8BD5\u6CE8\u5165\u811A\u672C\u5230webview",{id:t.id||"\u65E0ID",tagName:t.tagName,processed:t.hasAttribute("data-cheekychimp-processed"),alreadyInjected:this.injectedWebviews.has(t)}),this.injectedWebviews.has(t))return s.debug("webview\u5DF2\u7ECF\u88AB\u6CE8\u5165\u8FC7\uFF0C\u8DF3\u8FC7"),{success:!0,scriptIds:[]};t.setAttribute("data-cheekychimp-processed","true");try{s.debug("\u5C1D\u8BD5\u83B7\u53D6webview URL");let e=await this.getWebviewUrl(t);if(!e||e==="about:blank"){let i="\u65E0\u6CD5\u83B7\u53D6\u6709\u6548\u7684webview URL";return s.warn(i,{id:t.id||"\u65E0ID",tagName:t.tagName}),{success:!1,scriptIds:[],error:i}}s.info(`\u51C6\u5907\u5411webview(${e})\u6CE8\u5165\u811A\u672C`),console.log(`${u("WebviewInjector")}: \u51C6\u5907\u5411webview(${e})\u6CE8\u5165\u811A\u672C`);let n=[],r=0;for(let i of this.scripts)if(x(i,e)){r++,s.debug(`\u811A\u672C "${i.name}" \u5339\u914DURL: ${e}`);try{let o=await this.injectScript(t,i,{url:e,origin:new URL(e).origin,targetType:"webview",stage:"document-start"});o.success?(n.push(i.id),s.debug(`\u6210\u529F\u6CE8\u5165\u811A\u672C "${i.name}" \u5230 ${e}`),console.log(`${u("WebviewInjector")}: \u6210\u529F\u6CE8\u5165\u811A\u672C "${i.name}" \u5230 ${e}`)):(s.warn(`\u6CE8\u5165\u811A\u672C "${i.name}" \u5931\u8D25: ${o.error}`,{url:e,scriptId:i.id}),console.warn(`${u("WebviewInjector")}: \u6CE8\u5165\u811A\u672C "${i.name}" \u5931\u8D25: ${o.error}`))}catch(o){s.error(`\u6CE8\u5165\u811A\u672C "${i.name}" \u65F6\u51FA\u9519: ${o instanceof Error?o.message:o}`,{url:e,scriptId:i.id,error:o}),console.error(`${u("WebviewInjector")}: \u6CE8\u5165\u811A\u672C "${i.name}" \u65F6\u51FA\u9519:`,o)}}return r===0&&s.debug(`\u6CA1\u6709\u811A\u672C\u5339\u914DURL: ${e}`),this.injectedWebviews.add(t),s.info(`\u5411webview(${e})\u6CE8\u5165\u4E86${n.length}\u4E2A\u811A\u672C`),console.log(`${u("WebviewInjector")}: \u5411webview(${e})\u6CE8\u5165\u4E86${n.length}\u4E2A\u811A\u672C`),n.length>0?s.logInjection("webview",e,!0,{scriptIds:n,totalMatched:r}):r>0&&s.logInjection("webview",e,!1,{totalMatched:r,error:"\u6709\u5339\u914D\u7684\u811A\u672C\u4F46\u6CE8\u5165\u5931\u8D25"}),{success:!0,scriptIds:n}}catch(e){return s.error(`\u6CE8\u5165webview\u5931\u8D25: ${e instanceof Error?e.message:e}`,{webviewId:t.id||"\u65E0ID",tagName:t.tagName,error:e}),console.error(`${u("WebviewInjector")}: \u6CE8\u5165webview\u5931\u8D25:`,e),{success:!1,scriptIds:[],error:e instanceof Error?e.message:"\u672A\u77E5\u9519\u8BEF"}}}async getWebviewUrl(t){s.debug("\u83B7\u53D6webview URL",{id:t.id||"\u65E0ID",tagName:t.tagName});let e=t.getAttribute("src");if(e&&e!=="about:blank")return s.debug(`\u83B7\u53D6\u5230webview URL(\u4ECEsrc): ${e}`),e;let n=t.getAttribute("data-src");if(n&&n!=="about:blank")return s.debug(`\u83B7\u53D6\u5230webview URL(\u4ECEdata-src): ${n}`),n;if(t instanceof HTMLIFrameElement)try{if(t.contentWindow&&t.contentWindow.location.href){let r=t.contentWindow.location.href;if(r&&r!=="about:blank")return s.debug(`\u83B7\u53D6\u5230webview URL(\u4ECEcontentWindow.location): ${r}`),r}}catch(r){s.warn("\u65E0\u6CD5\u83B7\u53D6\u8DE8\u57DFiframe\u7684contentWindow.location",{error:r}),console.log(`${u("WebviewInjector")}: \u65E0\u6CD5\u83B7\u53D6\u8DE8\u57DFiframe\u7684contentWindow.location`)}if("getURL"in t&&typeof t.getURL=="function")try{let r=t.getURL();if(r&&r!=="about:blank")return s.debug(`\u83B7\u53D6\u5230webview URL(\u4ECEgetURL): ${r}`),r}catch(r){s.warn("getURL\u8C03\u7528\u5931\u8D25",{error:r}),console.warn(`${u("WebviewInjector")}: getURL\u8C03\u7528\u5931\u8D25:`,r)}return s.debug("\u5C1D\u8BD5\u901A\u8FC7executeJavaScript\u83B7\u53D6URL"),new Promise(r=>{let i=!1,c=setTimeout(()=>{i||(s.warn("executeJavaScript\u83B7\u53D6URL\u8D85\u65F6"),i=!0,r(null))},1e3);try{"executeJavaScript"in t?(s.debug("\u8C03\u7528executeJavaScript\u83B7\u53D6location.href"),t.executeJavaScript("window.location.href",!1,o=>{clearTimeout(c),i||(i=!0,o&&o!=="about:blank"?(s.debug(`\u83B7\u53D6\u5230webview URL(\u4ECEexecuteJavaScript): ${o}`),r(o)):(s.warn("executeJavaScript\u8FD4\u56DE\u65E0\u6548URL",{url:o}),r(null)))})):(clearTimeout(c),i||(s.warn("webview\u4E0D\u652F\u6301executeJavaScript"),i=!0,r(null)))}catch(o){s.error("executeJavaScript\u8C03\u7528\u5931\u8D25",{error:o}),console.warn(`${u("WebviewInjector")}: executeJavaScript\u8C03\u7528\u5931\u8D25:`,o),clearTimeout(c),i||(i=!0,r(null))}})}async executeScriptInWebview(t,e){return s.debug("\u51C6\u5907\u5728webview\u4E2D\u6267\u884C\u811A\u672C",{id:t.id||"\u65E0ID",tagName:t.tagName}),new Promise(async(n,r)=>{let i=[],c=[async()=>{if(i.push("executeJavaScript"),s.debug("\u5C1D\u8BD5\u4F7F\u7528executeJavaScript\u65B9\u6CD5"),"executeJavaScript"in t)return new Promise((a,d)=>{try{t.executeJavaScript(e,!1,()=>{s.debug("executeJavaScript\u6267\u884C\u6210\u529F"),a()})}catch(m){s.warn("executeJavaScript\u6267\u884C\u5931\u8D25",{error:m}),d(m)}});throw new Error("webview\u4E0D\u652F\u6301executeJavaScript")},async()=>{if(i.push("evalInContext"),s.debug("\u5C1D\u8BD5\u4F7F\u7528evalInContext\u65B9\u6CD5"),"evalInContext"in t)return new Promise((a,d)=>{try{t.evalInContext(e,()=>{s.debug("evalInContext\u6267\u884C\u6210\u529F"),a()})}catch(m){s.warn("evalInContext\u6267\u884C\u5931\u8D25",{error:m}),d(m)}});throw new Error("webview\u4E0D\u652F\u6301evalInContext")},async()=>{if(i.push("send"),s.debug("\u5C1D\u8BD5\u4F7F\u7528send\u65B9\u6CD5"),"send"in t)return new Promise(a=>{try{let d=Date.now().toString(36)+Math.random().toString(36).substr(2);t.send("cheekychimp-inject-script",{script:e,id:d}),s.debug("send\u65B9\u6CD5\u6267\u884C\u6210\u529F"),a()}catch(d){s.warn("send\u65B9\u6CD5\u5931\u8D25",{error:d}),console.warn(`${u("WebviewInjector")}: send\u65B9\u6CD5\u5931\u8D25:`,d),a()}});throw new Error("webview\u4E0D\u652F\u6301send")},async()=>{if(i.push("iframe-direct"),s.debug("\u5C1D\u8BD5iframe\u76F4\u63A5\u64CD\u4F5Cdocument\u65B9\u6CD5"),t instanceof HTMLIFrameElement)return new Promise((a,d)=>{try{let m=t.contentDocument;if(!m)throw new Error("\u65E0\u6CD5\u8BBF\u95EEiframe\u5185\u5BB9(\u53EF\u80FD\u662F\u8DE8\u57DF\u9650\u5236)");let f=m.createElement("script");if(f.textContent=e,f.setAttribute("data-cheekychimp-injected","true"),m.head)m.head.appendChild(f),s.debug("\u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe\u7684head");else if(m.body)m.body.appendChild(f),s.debug("\u811A\u672C\u5DF2\u6CE8\u5165\u5230iframe\u7684body");else throw new Error("iframe\u6587\u6863\u6CA1\u6709head\u6216body\u5143\u7D20");a()}catch(m){s.warn("iframe\u76F4\u63A5\u64CD\u4F5Cdocument\u5931\u8D25",{error:m}),d(m)}});throw new Error("\u5143\u7D20\u4E0D\u662Fiframe")}];for(let a of c)try{await a(),s.info("\u6210\u529F\u6267\u884C\u811A\u672C",{method:i[i.length-1]}),console.log(`${u("WebviewInjector")}: \u6210\u529F\u6267\u884C\u811A\u672C`),n();return}catch(d){s.warn(`\u811A\u672C\u6267\u884C\u65B9\u6CD5 ${i[i.length-1]} \u5931\u8D25`,{error:d}),console.warn(`${u("WebviewInjector")}: \u811A\u672C\u6267\u884C\u65B9\u6CD5\u5931\u8D25:`,d)}let o="\u6240\u6709\u811A\u672C\u6267\u884C\u65B9\u6CD5\u90FD\u5931\u8D25";s.error(o,{attemptedMethods:i}),r(new Error(o))})}getInjectedScriptIds(){return Array.from(this.scriptIds)}};var C=class{constructor(t){this.scriptStorage=t}async createGmApi(t,e){let n={script:{name:t.name,namespace:t.namespace,description:t.description,version:t.version,includes:t.includes,excludes:t.excludes,matches:t.matches,resources:t.resources,requires:t.requires},version:"0.1.0",scriptHandler:"Obsidian CheekyChimp",scriptMetaStr:B(t)},r=T(t.source),i=this.createStorageNamespace(t),c=this.createXmlHttpRequestFunction(t,r);return{GM_info:n,GM_getValue:(o,a)=>localStorage.getItem(`cheekychimp:${t.id}:${o}`)||a,GM_setValue:(o,a)=>{localStorage.setItem(`cheekychimp:${t.id}:${o}`,a),i.setValue(o,a)},GM_deleteValue:o=>{localStorage.removeItem(`cheekychimp:${t.id}:${o}`),i.deleteValue(o)},GM_listValues:()=>{let o=[],a=`cheekychimp:${t.id}:`;for(let d=0;d<localStorage.length;d++){let m=localStorage.key(d);m&&m.startsWith(a)&&o.push(m.substring(a.length))}return o},GM:{getValue:async(o,a)=>{let d=`cheekychimp:${t.id}:${o}`,m=localStorage.getItem(d);return m!==null?m:a},setValue:async(o,a)=>{localStorage.setItem(`cheekychimp:${t.id}:${o}`,a),await i.setValue(o,a)},deleteValue:async o=>{localStorage.removeItem(`cheekychimp:${t.id}:${o}`),await i.deleteValue(o)},listValues:async()=>{let o=[],a=`cheekychimp:${t.id}:`;for(let d=0;d<localStorage.length;d++){let m=localStorage.key(d);m&&m.startsWith(a)&&o.push(m.substring(a.length))}return o},xmlHttpRequest:c,addStyle:async o=>{let a=document.createElement("style");return a.textContent=o,a.setAttribute("data-cheekychimp-style",t.id),document.head.appendChild(a),a},registerMenuCommand:async(o,a,d)=>this.registerMenuCommand(t,o,a,d),addElement:async(o,a)=>{let d=document.createElement(o);for(let[m,f]of Object.entries(a))d.setAttribute(m,String(f));return document.body.appendChild(d),d}},GM_getResourceText:this.createGetResourceTextFunction(t),GM_getResourceURL:this.createGetResourceUrlFunction(t),GM_addStyle:o=>{try{let a=document.createElement("style");a.textContent=o,a.setAttribute("data-cheekychimp-style",t.id),document.head.appendChild(a)}catch(a){console.error(`${u("GMApiFactory")}: Adding style failed:`,a)}},GM_addElement:(o,a)=>{let d=document.createElement(o);for(let[m,f]of Object.entries(a))d.setAttribute(m,String(f));return document.body.appendChild(d),d},GM_registerMenuCommand:(o,a,d)=>this.registerMenuCommand(t,o,a,d),GM_unregisterMenuCommand:o=>{this.unregisterMenuCommand(t,o)},GM_xmlhttpRequest:c,GM_openInTab:(o,a)=>(window.open(o,"_blank"),null),GM_setClipboard:(o,a)=>{navigator.clipboard.writeText(o).catch(d=>console.error("Failed to copy text: ",d))},GM_notification:(o,a)=>{alert(typeof o=="string"?o:o.text)},unsafeWindow:window}}generateSimpleGMAPIs(){return`
        // GM \u5B58\u50A8 API
        window.GM_getValue = function(key, defaultValue) {
            try {
                const storedValue = localStorage.getItem('GM_' + key);
                return storedValue === null ? defaultValue : JSON.parse(storedValue);
            } catch (e) {
                console.error('GM_getValue error:', e);
                return defaultValue;
            }
        };
        
        window.GM_setValue = function(key, value) {
            try {
                localStorage.setItem('GM_' + key, JSON.stringify(value));
            } catch (e) {
                console.error('GM_setValue error:', e);
            }
        };
        
        window.GM_deleteValue = function(key) {
            try {
                localStorage.removeItem('GM_' + key);
            } catch (e) {
                console.error('GM_deleteValue error:', e);
            }
        };
        
        window.GM_listValues = function() {
            try {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('GM_')) {
                        keys.push(key.substring(3));
                    }
                }
                return keys;
            } catch (e) {
                console.error('GM_listValues error:', e);
                return [];
            }
        };
        
        // GM_getResourceText API
        window.GM_getResourceText = function(resourceName) {
            if (window._gmResourceCache && window._gmResourceCache[resourceName]) {
                return window._gmResourceCache[resourceName];
            }
            console.warn('Resource not found:', resourceName);
            return '';
        };
        
        // GM_registerMenuCommand API
        window._gmMenuCommands = [];
        window.GM_registerMenuCommand = function(name, callback, accessKey) {
            console.log("[CheekyChimp] Registering menu command: " + name);
            const id = Date.now() + Math.random();
            window._gmMenuCommands.push({
                id: id,
                name: name,
                callback: callback,
                accessKey: accessKey
            });
            
            // \u68C0\u67E5\u662F\u5426\u9700\u8981\u521B\u5EFA\u83DC\u5355UI
            if (window._gmMenuCommands.length === 1) {
                // \u5728\u9875\u9762\u4E0A\u521B\u5EFA\u4E00\u4E2A\u7B80\u5355\u7684\u83DC\u5355\u6309\u94AE
                setTimeout(function() {
                    try {
                        // \u53EA\u5728\u9876\u7EA7\u7A97\u53E3\u521B\u5EFAUI
                        if (window.self !== window.top) {
                            console.log("[CheekyChimp] Skipping menu UI creation in iframe");
                            return;
                        }
                        
                        console.log("[CheekyChimp] Creating menu UI with " + window._gmMenuCommands.length + " commands");
                        
                        // \u521B\u5EFA\u83DC\u5355\u5BB9\u5668\u548C\u6309\u94AE
                        const setupMenu = function() {
                            // \u68C0\u67E5\u662F\u5426\u5DF2\u521B\u5EFA
                            if (document.getElementById('gm-menu-container')) {
                                console.log("[CheekyChimp] Menu UI already exists, skipping creation");
                                return;
                            }
                            
                            console.log("[CheekyChimp] Starting to create menu UI elements");
                            
                            // \u521B\u5EFA\u83DC\u5355\u5BB9\u5668
                            const menuContainer = document.createElement('div');
                            menuContainer.id = 'gm-menu-container';
                            menuContainer.style.cssText = 'position:fixed;top:10px;right:10px;z-index:9999;display:none;background:#fff;border-radius:5px;box-shadow:0 0 10px rgba(0,0,0,0.2);padding:5px 0;';
                            
                            // \u521B\u5EFA\u83DC\u5355\u6309\u94AE - \u534A\u9690\u85CF\u5F0F\u8BBE\u8BA1
                            const menuButton = document.createElement('div');
                            menuButton.id = 'gm-menu-button';
                            menuButton.innerHTML = '\u2699\uFE0F';
                            menuButton.title = 'UserScript Menu';
                            menuButton.style.cssText = 'position:fixed;top:10px;right:-20px;z-index:10000;cursor:pointer;background:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 5px rgba(0,0,0,0.2);transition:right 0.3s ease;opacity:0.85;';
                            
                            // \u521B\u5EFA\u4E00\u4E2A\u89E6\u53D1\u533A\u57DF
                            const triggerZone = document.createElement('div');
                            triggerZone.id = 'gm-trigger-zone';
                            triggerZone.style.cssText = 'position:fixed;top:0;right:0;width:30px;height:50px;z-index:9999;';
                            
                            // \u6DFB\u52A0\u5230\u6587\u6863
                            document.body.appendChild(menuContainer);
                            document.body.appendChild(menuButton);
                            document.body.appendChild(triggerZone);
                            
                            console.log("[CheekyChimp] Menu UI elements added to DOM");
                            
                            // \u9F20\u6807\u79FB\u5165\u89E6\u53D1\u533A\u57DF\u6216\u6309\u94AE\u65F6\u663E\u793A\u5B8C\u6574\u6309\u94AE
                            const showFullButton = function() {
                                menuButton.style.right = '10px';
                            };
                            
                            // \u9F20\u6807\u79FB\u51FA\u533A\u57DF\u65F6\u534A\u9690\u85CF\u6309\u94AE\uFF08\u9664\u975E\u83DC\u5355\u5DF2\u6253\u5F00\uFF09
                            const hidePartialButton = function() {
                                if (menuContainer.style.display !== 'block') {
                                    menuButton.style.right = '-20px';
                                }
                            };
                            
                            triggerZone.addEventListener('mouseenter', showFullButton);
                            triggerZone.addEventListener('mouseleave', hidePartialButton);
                            menuButton.addEventListener('mouseenter', showFullButton);
                            menuButton.addEventListener('mouseleave', hidePartialButton);
                            
                            // \u70B9\u51FB\u6309\u94AE\u663E\u793A/\u9690\u85CF\u83DC\u5355
                            menuButton.addEventListener('click', function() {
                                const isVisible = menuContainer.style.display === 'block';
                                menuContainer.style.display = isVisible ? 'none' : 'block';
                                
                                console.log("[CheekyChimp] Menu state toggled: " + (isVisible ? "hidden" : "visible"));
                                
                                // \u5982\u679C\u83DC\u5355\u5173\u95ED\u4E14\u9F20\u6807\u4E0D\u5728\u89E6\u53D1\u533A\u57DF\u6216\u6309\u94AE\u4E0A\uFF0C\u5219\u518D\u6B21\u534A\u9690\u85CF\u6309\u94AE
                                if (isVisible) {
                                    // \u68C0\u67E5\u9F20\u6807\u662F\u5426\u5728\u89E6\u53D1\u533A\u57DF\u6216\u6309\u94AE\u4E0A
                                    const checkMousePos = function(e) {
                                        const triggerRect = triggerZone.getBoundingClientRect();
                                        const buttonRect = menuButton.getBoundingClientRect();
                                        
                                        const mouseInTrigger = (
                                            e.clientX >= triggerRect.left && 
                                            e.clientX <= triggerRect.right && 
                                            e.clientY >= triggerRect.top && 
                                            e.clientY <= triggerRect.bottom
                                        );
                                        
                                        const mouseInButton = (
                                            e.clientX >= buttonRect.left && 
                                            e.clientX <= buttonRect.right && 
                                            e.clientY >= buttonRect.top && 
                                            e.clientY <= buttonRect.bottom
                                        );
                                        
                                        if (!mouseInTrigger && !mouseInButton) {
                                            hidePartialButton();
                                            document.removeEventListener('mousemove', checkMousePos);
                                        }
                                    };
                                    
                                    // \u6DFB\u52A0\u4E00\u6B21\u6027\u68C0\u67E5
                                    setTimeout(() => {
                                        document.addEventListener('mousemove', checkMousePos, { once: true });
                                    }, 100);
                                }
                                
                                if (!isVisible) {
                                    // \u6E05\u9664\u65E7\u83DC\u5355\u9879
                                    menuContainer.innerHTML = '';
                                    
                                    // \u6DFB\u52A0\u83DC\u5355\u9879
                                    console.log("[CheekyChimp] Adding menu items: " + window._gmMenuCommands.length + " commands");
                                    
                                    window._gmMenuCommands.forEach(function(command) {
                                        const menuItem = document.createElement('div');
                                        menuItem.className = 'gm-menu-item';
                                        menuItem.textContent = command.name;
                                        menuItem.style.cssText = 'padding:8px 15px;cursor:pointer;white-space:nowrap;';
                                        menuItem.addEventListener('click', function() {
                                            menuContainer.style.display = 'none';
                                            console.log("[CheekyChimp] Executing menu command: "" + command.name + """);
                                            command.callback();
                                        });
                                        menuItem.addEventListener('mouseenter', function() {
                                            this.style.backgroundColor = '#f0f0f0';
                                        });
                                        menuItem.addEventListener('mouseleave', function() {
                                            this.style.backgroundColor = '';
                                        });
                                        menuContainer.appendChild(menuItem);
                                        console.log("[CheekyChimp] Added menu item: "" + command.name + """);
                                    });
                                }
                            });
                            
                            // \u70B9\u51FB\u9875\u9762\u5176\u4ED6\u5730\u65B9\u5173\u95ED\u83DC\u5355
                            document.addEventListener('click', function(e) {
                                if (e.target !== menuButton && !menuContainer.contains(e.target)) {
                                    menuContainer.style.display = 'none';
                                }
                            });
                            
                            console.log("[CheekyChimp] Menu UI event listeners set up");
                        };
                        
                        // \u5982\u679C\u6587\u6863\u5DF2\u7ECF\u52A0\u8F7D\u5B8C\u6210\uFF0C\u76F4\u63A5\u8BBE\u7F6E\u83DC\u5355
                        if (document.body) {
                            console.log("[CheekyChimp] Document already loaded, setting up menu now");
                            setupMenu();
                        } else {
                            // \u5426\u5219\u7B49\u5F85\u6587\u6863\u52A0\u8F7D\u5B8C\u6210
                            console.log("[CheekyChimp] Document not loaded, waiting for DOMContentLoaded");
                            document.addEventListener('DOMContentLoaded', setupMenu);
                        }
                    } catch(e) {
                        console.error("[CheekyChimp] Failed to create GM menu:", e);
                    }
                }, 1000);
            }
            
            return id;
        };
        
        // \u5176\u4ED6API
        window.GM_xmlhttpRequest = function(details) {
            // \u7B80\u5316\u5B9E\u73B0
            const xhr = new XMLHttpRequest();
            xhr.open(details.method || 'GET', details.url, true);
            
            if (details.headers) {
                for (const [key, value] of Object.entries(details.headers)) {
                    xhr.setRequestHeader(key, String(value));
                }
            }
            
            xhr.onload = function() {
                if (details.onload) {
                    details.onload({
                        responseText: xhr.responseText,
                        response: xhr.response,
                        status: xhr.status,
                        statusText: xhr.statusText,
                        readyState: xhr.readyState,
                        responseHeaders: xhr.getAllResponseHeaders(),
                        finalUrl: details.url
                    });
                }
            };
            
            xhr.onerror = function(error) {
                if (details.onerror) {
                    details.onerror(error);
                }
            };
            
            xhr.send(details.data);
            
            return {
                abort: function() {
                    xhr.abort();
                }
            };
        };
        
        // \u57FA\u7840\u7248GM\u5BF9\u8C61
        window.GM = {
            getValue: function(name, defaultValue) {
                return Promise.resolve(GM_getValue(name, defaultValue));
            },
            setValue: function(name, value) {
                GM_setValue(name, value);
                return Promise.resolve();
            },
            deleteValue: function(name) {
                GM_deleteValue(name);
                return Promise.resolve();
            },
            listValues: function() {
                return Promise.resolve(GM_listValues());
            },
            xmlHttpRequest: window.GM_xmlhttpRequest,
            info: {
                scriptHandler: 'Obsidian CheekyChimp',
                version: '0.1.0'
            }
        };

        console.log('[CheekyChimp] GM APIs initialization completed');
        `}createStorageNamespace(t){return{getValue:async(e,n)=>{let r=`${t.id}:${e}`;return await this.scriptStorage.getValue(r,n)},setValue:async(e,n)=>{let r=`${t.id}:${e}`;await this.scriptStorage.setValue(r,n)},deleteValue:async e=>{let n=`${t.id}:${e}`;await this.scriptStorage.deleteValue(n)},listValues:async()=>{let e=await this.scriptStorage.listValues(),n=`${t.id}:`;return e.filter(r=>r.startsWith(n)).map(r=>r.substring(n.length))}}}createXmlHttpRequestFunction(t,e){return n=>{console.log(`${u("GMApiFactory")}: Executing xmlhttpRequest ${n.url}`);try{let r=new XMLHttpRequest,i=new AbortController,o=new URL(n.url).hostname;W(o,e)||console.warn(`${u("GMApiFactory")}: Request ${o} not in @connect list, may be blocked`);let d={abort:()=>{i.abort()}};return fetch(n.url,{method:n.method||"GET",signal:i.signal,credentials:n.withCredentials?"include":"same-origin"}).then(async m=>{let f="";if(m.headers)if(typeof m.headers.forEach=="function"){let y=[];m.headers.forEach((h,v)=>{y.push(`${v}: ${h}`)}),f=y.join(`
`)}else f=m.headers.toString();let g=await m.text();n.onload&&typeof n.onload=="function"&&n.onload({finalUrl:m.url,readyState:4,status:m.status,statusText:m.statusText,responseHeaders:f,responseText:g,response:g})}).catch(m=>{if(m.name==="AbortError"&&n.onabort){n.onabort();return}n.onerror&&typeof n.onerror=="function"&&n.onerror(m)}),d}catch(r){return console.error(`${u("GMApiFactory")}: XMLHttpRequest execution failed:`,r),n.onerror&&typeof n.onerror=="function"&&n.onerror(r),null}}}createGetResourceTextFunction(t){return e=>{console.log(`${u("GMApiFactory")}: Getting resource text ${e}`);try{let r=t.resources.reduce((o,a)=>(o[a.name]=a.url,o),{})[e];if(!r)return console.warn(`${u("GMApiFactory")}: Resource ${e} not found`),"";let i=`cheekychimp_resource:${t.id}:${e}`,c=localStorage.getItem(i);return c?(console.log(`${u("GMApiFactory")}: Using cached resource ${e}`),c):(console.log(`${u("GMApiFactory")}: Resource${e} not cached, starting background load`),setTimeout(()=>{fetch(r).then(o=>{if(!o.ok)throw new Error(`\u83B7\u53D6\u8D44\u6E90\u5931\u8D25: ${o.status} ${o.statusText}`);return o.text()}).then(o=>{try{localStorage.setItem(i,o),console.log(`${u("GMApiFactory")}: Resource ${e} cached for next use`)}catch(a){console.warn(`${u("GMApiFactory")}: Unable to cache resource, may exceed storage limit`,a)}}).catch(o=>{console.error(`${u("GMApiFactory")}: Background resource ${e} load failed:`,o)})},0),"")}catch(n){return console.error(`${u("GMApiFactory")}: Getting resource ${e} failed:`,n),""}}}createGetResourceUrlFunction(t){return e=>{try{let r=t.resources.reduce((i,c)=>(i[c.name]=c.url,i),{})[e];return r||(console.warn(`${u("GMApiFactory")}: Resource ${e} not found`),"")}catch(n){return console.error(`${u("GMApiFactory")}: Getting resource URL ${e} failed:`,n),""}}}registerMenuCommand(t,e,n,r){try{let i=Date.now()+Math.floor(Math.random()*1e3),c=`tampermonkey_commands:${t.id}`,o=[];try{let d=localStorage.getItem(c);d&&(o=JSON.parse(d))}catch(d){console.error("Parsing saved commands failed:",d)}o.push({id:i,name:e,fn:n,accessKey:r}),localStorage.setItem(c,JSON.stringify(o)),document.addEventListener(`cheekychimp-run-command-${i}`,()=>{try{n()}catch(d){console.error(`${u("GMApiFactory")}: Executing command "${e}" failed:`,d)}});let a=new CustomEvent("cheekychimp-command-registered",{detail:{scriptId:t.id,commandId:i,name:e}});return document.dispatchEvent(a),console.log(`${u("GMApiFactory")}: Registered menu command "${e}"`),i}catch(i){return console.error(`${u("GMApiFactory")}: Registering menu command "${e}" failed:`,i),-1}}unregisterMenuCommand(t,e){try{let n=`tampermonkey_commands:${t.id}`,r=[];try{let c=localStorage.getItem(n);c&&(r=JSON.parse(c),r=r.filter(o=>o.id!==e),localStorage.setItem(n,JSON.stringify(r)))}catch(c){console.error("Parsing saved commands failed:",c)}document.removeEventListener(`cheekychimp-run-command-${e}`,()=>{});let i=new CustomEvent("cheekychimp-command-unregistered",{detail:{scriptId:t.id,commandId:e}});document.dispatchEvent(i),console.log(`${u("GMApiFactory")}: Unregistered menu command ID ${e}`)}catch(n){console.error(`${u("GMApiFactory")}: Unregistering menu command ID ${e} failed:`,n)}}createScriptWrapper(t,e,n){let r=t.name.includes("Immersive Translate"),i=t.name.includes("\u591C\u95F4\u6A21\u5F0F")||t.name.includes("Night Mode"),c=t.resources&&t.resources.some(o=>o.name==="swalStyle");return`
            (function() {
                try {
                    // \u5B9A\u4E49\u57FA\u672C\u7684GM\u4FE1\u606F\u5BF9\u8C61
                    const GM_info = ${JSON.stringify(e.GM_info)};
                    console.log('CheekyChimp: \u51C6\u5907\u6267\u884C\u811A\u672C "${t.name}"', GM_info);
                    
                    // \u5B9A\u4E49GM API\u51FD\u6570
                    const GM_getValue = function(name, defaultValue) {
                        return localStorage.getItem('cheekychimp:${t.id}:' + name) || defaultValue;
                    };
                    
                    const GM_setValue = function(name, value) {
                        localStorage.setItem('cheekychimp:${t.id}:' + name, value);
                    };
                    
                    const GM_deleteValue = function(name) {
                        localStorage.removeItem('cheekychimp:${t.id}:' + name);
                    };
                    
                    const GM_listValues = function() {
                        const keys = [];
                        const prefix = 'cheekychimp:${t.id}:';
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith(prefix)) {
                                keys.push(key.substring(prefix.length));
                            }
                        }
                        return keys;
                    };
                    
                    const GM_addStyle = function(css) {
                        try {
                            const style = document.createElement('style');
                            style.textContent = css;
                            document.head.appendChild(style);
                            return style;
                        } catch(e) {
                            console.error('CheekyChimp: GM_addStyle error', e);
                        }
                    };
                    
                    // \u8D44\u6E90\u83B7\u53D6API
                    const GM_getResourceText = function(name) {
                        // \u4ECE\u7F13\u5B58\u4E2D\u83B7\u53D6\u8D44\u6E90
                        const cacheKey = 'cheekychimp_resource:${t.id}:' + name;
                        const cachedResource = localStorage.getItem(cacheKey);
                        
                        // \u4E3A\u591C\u95F4\u6A21\u5F0F\u52A9\u624B\u811A\u672C\u63D0\u4F9B\u9ED8\u8BA4\u6837\u5F0F
                        if (name === 'swalStyle' && !cachedResource && ${i}) {
                            return \`
                                .swal2-popup { background: #fff; color: #333; border-radius: 5px; padding: 20px; }
                                .swal2-title { color: #595959; font-size: 1.8em; margin: 0; }
                                .swal2-content { color: #545454; }
                                .swal2-actions { margin-top: 15px; }
                                .swal2-confirm { background: #3085d6; color: #fff; border: 0; border-radius: 3px; padding: 8px 20px; }
                                .swal2-cancel { background: #aaa; color: #fff; border: 0; border-radius: 3px; padding: 8px 20px; margin-left: 10px; }
                                .darkmode-popup { font-size: 14px !important; }
                                .darkmode-center { display: flex; align-items: center; }
                                .darkmode-setting-label { display: flex; align-items: center; justify-content: space-between; padding-top: 15px; }
                                .darkmode-setting-label-col { display: flex; align-items: flex-start; padding-top: 15px; flex-direction: column; }
                                .darkmode-setting-radio { width: 16px; height: 16px; }
                                .darkmode-setting-textarea { width: 100%; margin: 14px 0 0; height: 100px; resize: none; border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; color: #666; line-height: 1.2; }
                                .darkmode-setting-input { border: 1px solid #bbb; box-sizing: border-box; padding: 5px 10px; border-radius: 5px; width: 100px; }
                            \`;
                        }
                        
                        return cachedResource || '';
                    };
                    
                    // \u83DC\u5355\u547D\u4EE4API
                    const GM_registerMenuCommand = function(name, fn, accessKey) {
                        console.log('CheekyChimp: Script registering menu command:', name);
                        // \u5B58\u50A8\u547D\u4EE4\u5230\u672C\u5730\u5B58\u50A8
                        const commandId = Date.now() + Math.floor(Math.random() * 1000);
                        const commandsKey = 'cheekychimp_commands:${t.id}';
                        let commands = [];
                        try {
                            const savedCommands = localStorage.getItem(commandsKey);
                            if (savedCommands) {
                                commands = JSON.parse(savedCommands);
                            }
                        } catch (e) {}
                        
                        commands.push({
                            id: commandId,
                            name: name,
                            accessKey: accessKey || ''
                        });
                        
                        localStorage.setItem(commandsKey, JSON.stringify(commands));
                        
                        // \u521B\u5EFA\u83DC\u5355UI
                        setTimeout(function() {
                            try {
                                // \u68C0\u67E5\u662F\u5426\u5728iframe\u4E2D
                                if (window.self !== window.top) {
                                    return; // \u907F\u514D\u5728iframe\u4E2D\u521B\u5EFA\u91CD\u590D\u7684\u83DC\u5355
                                }
                                
                                // \u68C0\u67E5\u662F\u5426\u5DF2\u7ECF\u6709\u83DC\u5355\u5BB9\u5668
                                let menuContainer = document.getElementById('gm-menu-container');
                                if (!menuContainer) {
                                    // \u521B\u5EFA\u83DC\u5355\u5BB9\u5668\u548C\u6309\u94AE
                                    const setupMenuUI = function() {
                                        // \u521B\u5EFA\u83DC\u5355\u5BB9\u5668
                                        menuContainer = document.createElement('div');
                                        menuContainer.id = 'gm-menu-container';
                                        menuContainer.style.cssText = 'position:fixed;top:10px;right:10px;z-index:9999;display:none;background:#fff;border-radius:5px;box-shadow:0 0 10px rgba(0,0,0,0.2);padding:5px 0;';
                                        
                                        // \u521B\u5EFA\u83DC\u5355\u6309\u94AE - \u534A\u9690\u85CF\u5F0F\u8BBE\u8BA1
                                        const menuButton = document.createElement('div');
                                        menuButton.id = 'gm-menu-button';
                                        menuButton.innerHTML = '\u2699\uFE0F';
                                        menuButton.title = 'UserScript Menu';
                                        menuButton.style.cssText = 'position:fixed;top:10px;right:-20px;z-index:10000;cursor:pointer;background:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 5px rgba(0,0,0,0.2);transition:right 0.3s ease;opacity:0.85;';
                                        
                                        // \u521B\u5EFA\u4E00\u4E2A\u89E6\u53D1\u533A\u57DF
                                        const triggerZone = document.createElement('div');
                                        triggerZone.id = 'gm-trigger-zone';
                                        triggerZone.style.cssText = 'position:fixed;top:0;right:0;width:30px;height:50px;z-index:9999;';
                                        
                                        // \u6DFB\u52A0\u5230\u6587\u6863
                                        document.body.appendChild(menuContainer);
                                        document.body.appendChild(menuButton);
                                        document.body.appendChild(triggerZone);
                                        
                                        console.log("[CheekyChimp] Menu UI elements added to DOM");
                                        
                                        // \u9F20\u6807\u79FB\u5165\u89E6\u53D1\u533A\u57DF\u6216\u6309\u94AE\u65F6\u663E\u793A\u5B8C\u6574\u6309\u94AE
                                        const showFullButton = function() {
                                            menuButton.style.right = '10px';
                                        };
                                        
                                        // \u9F20\u6807\u79FB\u51FA\u533A\u57DF\u65F6\u534A\u9690\u85CF\u6309\u94AE\uFF08\u9664\u975E\u83DC\u5355\u5DF2\u6253\u5F00\uFF09
                                        const hidePartialButton = function() {
                                            if (menuContainer.style.display !== 'block') {
                                                menuButton.style.right = '-20px';
                                            }
                                        };
                                        
                                        triggerZone.addEventListener('mouseenter', showFullButton);
                                        triggerZone.addEventListener('mouseleave', hidePartialButton);
                                        menuButton.addEventListener('mouseenter', showFullButton);
                                        menuButton.addEventListener('mouseleave', hidePartialButton);
                                        
                                        // \u70B9\u51FB\u6309\u94AE\u663E\u793A/\u9690\u85CF\u83DC\u5355
                                        menuButton.addEventListener('click', function() {
                                            const isVisible = menuContainer.style.display === 'block';
                                            menuContainer.style.display = isVisible ? 'none' : 'block';
                                            
                                            // \u5982\u679C\u83DC\u5355\u5173\u95ED\u4E14\u9F20\u6807\u4E0D\u5728\u89E6\u53D1\u533A\u57DF\u6216\u6309\u94AE\u4E0A\uFF0C\u5219\u518D\u6B21\u534A\u9690\u85CF\u6309\u94AE
                                            if (isVisible) {
                                                // \u68C0\u67E5\u9F20\u6807\u662F\u5426\u5728\u89E6\u53D1\u533A\u57DF\u6216\u6309\u94AE\u4E0A
                                                const checkMousePos = function(e) {
                                                    const triggerRect = triggerZone.getBoundingClientRect();
                                                    const buttonRect = menuButton.getBoundingClientRect();
                                                    
                                                    const mouseInTrigger = (
                                                        e.clientX >= triggerRect.left && 
                                                        e.clientX <= triggerRect.right && 
                                                        e.clientY >= triggerRect.top && 
                                                        e.clientY <= triggerRect.bottom
                                                    );
                                                    
                                                    const mouseInButton = (
                                                        e.clientX >= buttonRect.left && 
                                                        e.clientX <= buttonRect.right && 
                                                        e.clientY >= buttonRect.top && 
                                                        e.clientY <= buttonRect.bottom
                                                    );
                                                    
                                                    if (!mouseInTrigger && !mouseInButton) {
                                                        hidePartialButton();
                                                        document.removeEventListener('mousemove', checkMousePos);
                                                    }
                                                };
                                                
                                                // \u6DFB\u52A0\u4E00\u6B21\u6027\u68C0\u67E5
                                                setTimeout(() => {
                                                    document.addEventListener('mousemove', checkMousePos, { once: true });
                                                }, 100);
                                            }
                                            
                                            if (!isVisible) {
                                                // \u6E05\u9664\u65E7\u83DC\u5355\u9879
                                                menuContainer.innerHTML = '';
                                                
                                                // \u6DFB\u52A0\u83DC\u5355\u9879
                                                console.log("[CheekyChimp] Adding menu items: " + window._gmMenuCommands.length + " commands");
                                                
                                                window._gmMenuCommands.forEach(function(command) {
                                                    const menuItem = document.createElement('div');
                                                    menuItem.className = 'gm-menu-item';
                                                    menuItem.textContent = command.name;
                                                    menuItem.style.cssText = 'padding:8px 15px;cursor:pointer;white-space:nowrap;';
                                                    menuItem.addEventListener('click', function() {
                                                        menuContainer.style.display = 'none';
                                                        console.log("[CheekyChimp] Executing menu command: "" + command.name + """);
                                                        command.callback();
                                                    });
                                                    menuItem.addEventListener('mouseenter', function() {
                                                        this.style.backgroundColor = '#f0f0f0';
                                                    });
                                                    menuItem.addEventListener('mouseleave', function() {
                                                        this.style.backgroundColor = '';
                                                    });
                                                    menuContainer.appendChild(menuItem);
                                                    console.log("[CheekyChimp] Added menu item: "" + command.name + """);
                                                });
                                            }
                                        });
                                        
                                        // \u70B9\u51FB\u9875\u9762\u5176\u4ED6\u5730\u65B9\u5173\u95ED\u83DC\u5355
                                        document.addEventListener('click', function(e) {
                                            if (e.target !== menuButton && !menuContainer.contains(e.target)) {
                                                menuContainer.style.display = 'none';
                                            }
                                        });
                                        
                                        console.log("[CheekyChimp] Menu UI event listeners set up");
                                    };
                                    
                                    // \u5B58\u50A8\u83DC\u5355\u547D\u4EE4
                                    if (!window._gmMenuCommands) {
                                        window._gmMenuCommands = [];
                                    }
                                    
                                    // \u5982\u679C\u6587\u6863\u5DF2\u7ECF\u52A0\u8F7D\u5B8C\u6210\uFF0C\u7ACB\u5373\u8BBE\u7F6E
                                    if (document.body) {
                                        setupMenuUI();
                                    } else {
                                        // \u7B49\u5F85\u6587\u6863\u52A0\u8F7D
                                        document.addEventListener('DOMContentLoaded', setupMenuUI);
                                    }
                                }
                                
                                // \u6DFB\u52A0\u547D\u4EE4\u5230\u5185\u5B58\u4E2D
                                if (!window._gmMenuCommands) {
                                    window._gmMenuCommands = [];
                                }
                                
                                window._gmMenuCommands.push({
                                    id: commandId,
                                    name: name,
                                    callback: fn
                                });
                                
                                // \u5982\u679C\u83DC\u5355\u5DF2\u7ECF\u5B58\u5728\u5E76\u4E14\u6253\u5F00\uFF0C\u5237\u65B0\u83DC\u5355\u9879
                                const menuButton = document.getElementById('gm-menu-button');
                                const menuContainer = document.getElementById('gm-menu-container');
                                if (menuButton && menuContainer && menuContainer.style.display === 'block') {
                                    menuButton.click(); // \u5173\u95ED\u83DC\u5355
                                    menuButton.click(); // \u91CD\u65B0\u6253\u5F00\u83DC\u5355\u4EE5\u5237\u65B0
                                }
                            } catch(e) {
                                console.error('CheekyChimp: Failed to create menu item', e);
                            }
                        }, 500);
                        
                        // \u4E3A\u4E8B\u4EF6\u76D1\u542C\u521B\u5EFA\u81EA\u5B9A\u4E49\u4E8B\u4EF6
                        document.addEventListener('cheekychimp-run-command-' + commandId, function() {
                            try {
                                fn();
                            } catch(e) {
                                console.error('CheekyChimp: Failed to execute command', e);
                            }
                        });
                        
                        return commandId;
                    };
                    
                    // XMLHttpRequest API
                    const GM_xmlhttpRequest = function(details) {
                        try {
                            if (!details.url) {
                                throw new Error('URL is required for GM_xmlhttpRequest');
                            }
                            
                            // \u4F7F\u7528fetch API\u5B9E\u73B0
                            const fetchInit = {
                                method: details.method || 'GET',
                                headers: details.headers || {},
                                body: details.data || null,
                                credentials: details.withCredentials ? 'include' : 'same-origin'
                            };
                            
                            fetch(details.url, fetchInit)
                                .then(function(response) {
                                    if (!response.ok && details.onerror) {
                                        details.onerror(response);
                                        return;
                                    }
                                    
                                    return response.text().then(function(responseText) {
                                        if (details.onload) {
                                            // \u6784\u5EFAheaders\u5BF9\u8C61
                                            let responseHeaders = '';
                                            try {
                                                const headerPairs = [];
                                                response.headers.forEach((value, key) => {
                                                    headerPairs.push(\`\${key}: \${value}\`);
                                                });
                                                responseHeaders = headerPairs.join('\\n');
                                            } catch (e) {
                                                responseHeaders = response.headers.toString();
                                            }
                                            
                                            details.onload({
                                                responseText: responseText,
                                                status: response.status,
                                                statusText: response.statusText,
                                                readyState: 4,
                                                finalUrl: response.url,
                                                responseHeaders: responseHeaders
                                            });
                                        }
                                    });
                                })
                                .catch(function(error) {
                                    if (details.onerror) {
                                        details.onerror(error);
                                    }
                                });
                            
                            // \u8FD4\u56DE\u4E00\u4E2A\u6A21\u62DF\u7684XMLHttpRequest\u5BF9\u8C61\uFF0C\u5E26\u6709abort\u65B9\u6CD5
                            return { abort: function() { console.log('Request aborted'); } };
                        } catch(e) {
                            console.error('CheekyChimp: GM_xmlhttpRequest error', e);
                            if (details.onerror) {
                                details.onerror(e);
                            }
                        }
                    };
                    
                    // \u65B0\u7248GM API\u652F\u6301
                    const GM = {
                        getValue: function(name, defaultValue) {
                            return Promise.resolve(GM_getValue(name, defaultValue));
                        },
                        setValue: function(name, value) {
                            GM_setValue(name, value);
                            return Promise.resolve();
                        },
                        deleteValue: function(name) {
                            GM_deleteValue(name);
                            return Promise.resolve();
                        },
                        listValues: function() {
                            return Promise.resolve(GM_listValues());
                        },
                        xmlHttpRequest: GM_xmlhttpRequest,
                        addStyle: function(css) {
                            return Promise.resolve(GM_addStyle(css));
                        },
                        registerMenuCommand: function(name, fn, accessKey) {
                            return Promise.resolve(GM_registerMenuCommand(name, fn, accessKey));
                        }
                    };
                    
                    // \u5176\u4ED6API
                    const unsafeWindow = window;
                    
                    // \u591C\u95F4\u6A21\u5F0F\u52A9\u624B\u811A\u672C\u652F\u6301
                    if (${i}) {
                        window.Swal = window.Swal || {
                            fire: function(options) {
                                alert(options.title || 'Message');
                                return Promise.resolve({isConfirmed: true});
                            }
                        };
                    }
                    
                    // \u6C89\u6D78\u5F0F\u7FFB\u8BD1\u652F\u6301
                    if (${r}) {
                        console.log('CheekyChimp: \u68C0\u6D4B\u5230\u6C89\u6D78\u5F0F\u7FFB\u8BD1\u811A\u672C\uFF0C\u6DFB\u52A0\u7279\u6B8A\u5904\u7406');
                        
                        // \u4FEE\u590D\u6D4F\u89C8\u5668\u517C\u5BB9\u6027\u5BF9\u8C61
                        window.browser = window.browser || {};
                        window.chrome = window.chrome || {
                            runtime: {
                                sendMessage: () => Promise.resolve(),
                                onMessage: { addListener: () => {} }
                            },
                            i18n: {
                                getMessage: (key) => key
                            }
                        };
                        
                        // \u6DFB\u52A0\u57FA\u7840\u6837\u5F0F
                        try {
                            if (document.head) {
                                const immersiveStyles = document.createElement('style');
                                immersiveStyles.id = 'immersive-translate-styles';
                                immersiveStyles.textContent = \`
                                    /* \u7FFB\u8BD1\u6309\u94AE\u6837\u5F0F */
                                    #immersive-translate-button {
                                        position: fixed;
                                        right: 16px;
                                        top: 16px;
                                        background-color: rgba(127, 127, 127, 0.3);
                                        color: currentColor;
                                        border-radius: 50%;
                                        width: 40px;
                                        height: 40px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        cursor: pointer;
                                        z-index: 9999;
                                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                                        transition: all 0.3s ease;
                                    }
                                    #immersive-translate-button:hover {
                                        background-color: rgba(127, 127, 127, 0.5);
                                        transform: scale(1.1);
                                    }
                                    /* \u7FFB\u8BD1\u9762\u677F\u57FA\u7840\u6837\u5F0F */
                                    .immersive-translate-popup {
                                        position: fixed;
                                        background: white;
                                        border-radius: 8px;
                                        box-shadow: 0 4px 23px 0 rgba(0, 0, 0, 0.2);
                                        z-index: 9999;
                                    }
                                \`;
                                document.head.appendChild(immersiveStyles);
                            }
                        } catch (e) {
                            console.error('CheekyChimp: Adding translation styles failed:', e);
                        }
                        
                        // \u6DFB\u52A0\u7FFB\u8BD1\u6309\u94AE
                        const addTranslationButton = () => {
                            try {
                                // \u68C0\u67E5\u662F\u5426\u5DF2\u5B58\u5728\u6309\u94AE
                                if (document.getElementById('immersive-translate-button')) {
                                    return;
                                }
                                
                                // \u624B\u52A8\u6CE8\u5165\u7FFB\u8BD1\u6309\u94AE
                                const translationButton = document.createElement('div');
                                translationButton.id = 'immersive-translate-button';
                                translationButton.title = '\u6C89\u6D78\u5F0F\u7FFB\u8BD1';
                                translationButton.innerHTML = '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32"><path d="M211.2 883.2A64 64 0 0 1 147.2 819.2V204.8A64 64 0 0 1 211.2 140.8h249.6v61.44H512v7.68l-0.64 3.84A64 64 0 0 1 448.64 256l-0.64 3.2h-232.96A63.36 63.36 0 0 0 192 256v558.08A61.44 61.44 0 0 0 221.44 856.32A64 64 0 0 0 256 864h232.32c33.28-4.48 59.52-30.08 64-61.44V768h-64v-64h126.08A64 64 0 0 1 678.4 768v34.56A128 128 0 0 1 551.04 928H211.2z" fill="currentColor"></path><path d="M812.8 752.64h-60.8v-128c0-32-30.08-62.08-62.08-62.08h-159.36v-62.08h159.36c65.28 0 125.44 60.16 125.44 125.44v126.72zM448 266.24v-64h126.08A64 64 0 0 1 640 266.24z" fill="currentColor"></path><path d="M787.2 659.2l-96-166.4h64l64 115.2 64-115.2h64l-96 166.4z" fill="currentColor"></path></svg>';
                                document.body.appendChild(translationButton);
                                
                                // \u6DFB\u52A0\u70B9\u51FB\u4E8B\u4EF6
                                translationButton.addEventListener('click', () => {
                                    try {
                                        // \u5C1D\u8BD5\u591A\u79CD\u65B9\u5F0F\u6FC0\u6D3B\u7FFB\u8BD1
                                        window.dispatchEvent(new CustomEvent('immersive-translate-toggle'));
                                        
                                        if (window.immersiveTranslate?.toggleTranslate) {
                                            window.immersiveTranslate.toggleTranslate();
                                        }
                                        
                                        // \u5C1D\u8BD5\u4ECE\u83DC\u5355\u547D\u4EE4\u4E2D\u67E5\u627E
                                        if (typeof GM !== 'undefined') {
                                            const menuCommands = localStorage.getItem('cheekychimp_commands:${t.id}');
                                            if (menuCommands) {
                                                try {
                                                    const commands = JSON.parse(menuCommands);
                                                    for (const cmd of commands) {
                                                        if (cmd.name.includes('\u7FFB\u8BD1') || cmd.name.includes('Translate')) {
                                                            document.dispatchEvent(new CustomEvent('cheekychimp-run-command-' + cmd.id));
                                                            break;
                                                        }
                                                    }
                                                } catch (e) {}
                                            }
                                        }
                                    } catch (e) {
                                        console.error('CheekyChimp: Translation trigger failed:', e);
                                        alert('\u6C89\u6D78\u5F0F\u7FFB\u8BD1\u521D\u59CB\u5316\u4E2D\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5');
                                    }
                                });
                            } catch (e) {
                                console.error('CheekyChimp: Adding translation UI failed:', e);
                            }
                        };
                        
                        // \u786E\u4FDD\u5728\u9875\u9762\u5404\u9636\u6BB5\u90FD\u5C1D\u8BD5\u6DFB\u52A0\u6309\u94AE
                        if (document.body) {
                            setTimeout(addTranslationButton, 500);
                        }
                        
                        window.addEventListener('DOMContentLoaded', () => {
                            setTimeout(addTranslationButton, 500);
                        });
                        
                        window.addEventListener('load', () => {
                            setTimeout(addTranslationButton, 1000);
                        });
                        
                        // \u6DFB\u52A0DOM\u89C2\u5BDF\u5668
                        if (!document.body) {
                            const bodyObserver = new MutationObserver(() => {
                                if (document.body) {
                                    bodyObserver.disconnect();
                                    setTimeout(addTranslationButton, 100);
                                }
                            });
                            bodyObserver.observe(document.documentElement || document, { childList: true, subtree: true });
                        }
                        
                        // \u5B9A\u671F\u68C0\u67E5\u6309\u94AE\u662F\u5426\u5B58\u5728
                        const checkInterval = setInterval(() => {
                            if (document.body && !document.getElementById('immersive-translate-button')) {
                                addTranslationButton();
                            }
                        }, 5000);
                        
                        setTimeout(() => clearInterval(checkInterval), 30000);
                    }
                    
                    // \u6267\u884C\u5B9E\u9645\u811A\u672C
                    ${n}
                } catch(e) {
                    console.error('CheekyChimp: Script execution error', e);
                }
            })();
        `}};var L=class{constructor(t,e,n={iframe:{enabled:!0},webview:{enabled:!0}}){this.app=t;this.scriptStore=e;this.options=n;this.initialized=!1;this.injectors=[];this.scripts=[];s.debug("ScriptInjector\u5DF2\u521B\u5EFA",{options:n})}async initialize(){if(this.initialized){s.warn("ScriptInjector\u5DF2\u7ECF\u521D\u59CB\u5316\uFF0C\u8DF3\u8FC7\u91CD\u590D\u521D\u59CB\u5316");return}s.info("\u5F00\u59CB\u521D\u59CB\u5316ScriptInjector"),console.log(`${u("ScriptInjector")}: \u5F00\u59CB\u521D\u59CB\u5316`),await this.loadScripts();let t=new C(this.app,this.scriptStore);this.iframeInjector=new E(this.scripts,t,this.options),this.webviewInjector=new M(this.scripts,t,this.options),this.injectors=[this.iframeInjector,this.webviewInjector],s.debug("\u5F00\u59CB\u521D\u59CB\u5316\u6240\u6709\u6CE8\u5165\u5668");for(let e of this.injectors)await e.initialize();this.initialized=!0,s.info("ScriptInjector\u521D\u59CB\u5316\u5B8C\u6210"),console.log(`${u("ScriptInjector")}: \u521D\u59CB\u5316\u5B8C\u6210`)}cleanup(){s.debug("\u6E05\u7406ScriptInjector\u8D44\u6E90");for(let t of this.injectors)t.cleanup();this.injectors=[],this.initialized=!1,s.info("ScriptInjector\u8D44\u6E90\u5DF2\u6E05\u7406")}async refreshScripts(){s.info("\u5237\u65B0ScriptInjector\u4E2D\u7684\u811A\u672C"),console.log(`${u("ScriptInjector")}: \u5237\u65B0\u811A\u672C`),this.cleanup(),await this.initialize(),s.info("\u811A\u672C\u5237\u65B0\u5B8C\u6210"),console.log(`${u("ScriptInjector")}: \u811A\u672C\u5237\u65B0\u5B8C\u6210`)}async loadScripts(){try{this.scripts.length=0;let t=await this.scriptStore.getAllScripts();s.info(`\u4ECEScriptStore\u8BFB\u53D6\u5230${t.length}\u4E2A\u811A\u672C`);let e=this.sortScriptsByRunAt(t);for(let n of e)n.enabled&&this.scripts.push(n);if(s.info(`\u52A0\u8F7D\u4E86${this.scripts.length}\u4E2A\u542F\u7528\u7684\u811A\u672C`),console.log(`${u("ScriptInjector")}: \u52A0\u8F7D\u4E86${this.scripts.length}\u4E2A\u542F\u7528\u7684\u811A\u672C`),this.scripts.length>0){let n=this.scripts.map(r=>({id:r.id,name:r.name,includes:r.includes,matches:r.matches,excludes:r.excludes,runAt:r.runAt||"document-idle"}));s.debug("\u5DF2\u52A0\u8F7D\u7684\u811A\u672C\u5217\u8868",n)}}catch(t){s.error(`\u52A0\u8F7D\u811A\u672C\u65F6\u51FA\u9519: ${t instanceof Error?t.message:t}`,{error:t}),console.error(`${u("ScriptInjector")}: \u52A0\u8F7D\u811A\u672C\u65F6\u51FA\u9519:`,t)}}sortScriptsByRunAt(t){s.debug("\u5BF9\u811A\u672C\u8FDB\u884CrunAt\u6392\u5E8F");let e={"document-start":0,"document-body":1,"document-end":2,"document-idle":3},n=[...t].sort((r,i)=>{let c=r.runAt||"document-idle",o=i.runAt||"document-idle";return e[c]-e[o]});if(n.length>0){let r=n.map(i=>`${i.name} (${i.runAt||"document-idle"})`);s.debug("\u811A\u672C\u6392\u5E8F\u7ED3\u679C",{order:r})}return n}getInjectedScriptIds(){let t=[];for(let e of this.injectors)if("getInjectedScriptIds"in e){let n=e.getInjectedScriptIds();t.push(...n)}return Array.from(new Set(t))}};var D=class{constructor(){this.translations={zh:{plugin_name:"CheekyChimp",plugin_description:"Obsidian\u7528\u6237\u811A\u672C\u7BA1\u7406\u5668",settings:"\u8BBE\u7F6E",scripts_manager:"\u811A\u672C\u7BA1\u7406\u5668",add_script:"\u6DFB\u52A0\u811A\u672C",import_script:"\u5BFC\u5165\u811A\u672C",create_script:"\u521B\u5EFA\u811A\u672C",edit_script:"\u7F16\u8F91\u811A\u672C",delete_script:"\u5220\u9664\u811A\u672C",enable_script:"\u542F\u7528\u811A\u672C",disable_script:"\u7981\u7528\u811A\u672C",script_settings:"\u811A\u672C\u8BBE\u7F6E",active_scripts:"\u5DF2\u542F\u7528\u7684\u811A\u672C",no_active_scripts:"\u5F53\u524D\u6CA1\u6709\u542F\u7528\u7684\u811A\u672C",script_added:"\u811A\u672C\u5DF2\u6DFB\u52A0",script_updated:"\u811A\u672C\u5DF2\u66F4\u65B0",script_deleted:"\u811A\u672C\u5DF2\u5220\u9664",script_enabled:"\u811A\u672C\u5DF2\u542F\u7528",script_disabled:"\u811A\u672C\u5DF2\u7981\u7528",script_error:"\u811A\u672C\u9519\u8BEF",script_load_error:"\u52A0\u8F7D\u811A\u672C\u5931\u8D25",script_execute_error:"\u6267\u884C\u811A\u672C\u5931\u8D25",error_script_exists:"\u5DF2\u5B58\u5728\u540C\u540D\u811A\u672C",error_invalid_script:"\u65E0\u6548\u7684\u811A\u672C",error_script_not_found:"\u672A\u627E\u5230\u811A\u672C",error_cross_origin:"\u8DE8\u57DF\u8BF7\u6C42\u5931\u8D25",error_injection_failed:"\u6CE8\u5165\u811A\u672C\u5931\u8D25",confirm_delete:"\u786E\u5B9A\u8981\u5220\u9664\u6B64\u811A\u672C\u5417\uFF1F\u6B64\u64CD\u4F5C\u4E0D\u53EF\u64A4\u9500\u3002",confirm_yes:"\u662F",confirm_no:"\u5426",confirm_cancel:"\u53D6\u6D88",log_injecting:"\u6B63\u5728\u6CE8\u5165\u811A\u672C",log_injection_success:"\u811A\u672C\u6CE8\u5165\u6210\u529F",log_injection_failure:"\u811A\u672C\u6CE8\u5165\u5931\u8D25"},en:{plugin_name:"CheekyChimp",plugin_description:"UserScript Manager for Obsidian",settings:"Settings",scripts_manager:"Script Manager",add_script:"Add Script",import_script:"Import Script",create_script:"Create Script",edit_script:"Edit Script",delete_script:"Delete Script",enable_script:"Enable Script",disable_script:"Disable Script",script_settings:"Script Settings",active_scripts:"Active Scripts",no_active_scripts:"No active scripts",script_added:"Script added",script_updated:"Script updated",script_deleted:"Script deleted",script_enabled:"Script enabled",script_disabled:"Script disabled",script_error:"Script error",script_load_error:"Failed to load script",script_execute_error:"Failed to execute script",error_script_exists:"Script with the same name already exists",error_invalid_script:"Invalid script",error_script_not_found:"Script not found",error_cross_origin:"Cross-origin request failed",error_injection_failed:"Script injection failed",confirm_delete:"Are you sure you want to delete this script? This cannot be undone.",confirm_yes:"Yes",confirm_no:"No",confirm_cancel:"Cancel",log_injecting:"Injecting script",log_injection_success:"Script injection successful",log_injection_failure:"Script injection failed"}};this.currentLanguage="zh";this.detectLanguage()}detectLanguage(){try{let t=window.navigator.language;t.startsWith("zh")?this.currentLanguage="zh":this.currentLanguage="en",console.log(`CheekyChimp: \u68C0\u6D4B\u5230\u7CFB\u7EDF\u8BED\u8A00: ${t}, \u4F7F\u7528: ${this.currentLanguage}`)}catch(t){console.warn("CheekyChimp: \u65E0\u6CD5\u68C0\u6D4B\u7CFB\u7EDF\u8BED\u8A00\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u8BED\u8A00(zh)"),this.currentLanguage="zh"}}setLanguage(t){this.translations[t]?this.currentLanguage=t:(console.warn(`CheekyChimp: \u4E0D\u652F\u6301\u7684\u8BED\u8A00 ${t}, \u4F7F\u7528\u9ED8\u8BA4\u8BED\u8A00(zh)`),this.currentLanguage="zh")}getLanguage(){return this.currentLanguage}t(t,e){let r=(this.translations[this.currentLanguage]||this.translations.zh)[t]||t;return e&&Object.keys(e).forEach(i=>{r=r.replace(`{${i}}`,e[i])}),r}},I=new D;var U=class extends b.Plugin{constructor(){super(...arguments);this.webviewObserver=null}async onload(){console.log("Loading CheekyChimp plugin"),this.scriptStorage=new R(this),this.scriptManager=new _,await this.loadSettings(),this.settingTab=new $(this.app,this),this.addSettingTab(this.settingTab),this.scriptManager.loadScripts(this.settings.scripts),await this.setupWebviewHandling(),this.scriptInjector=new L(this.scriptManager.getAllScripts(),this.scriptStorage,{debug:this.settings.debug,iframe:{enabled:!0,sameOriginOnly:!1},webview:{enabled:!0}}),await this.scriptInjector.initialize(),setTimeout(()=>{console.log("\u4E3B\u52A8\u68C0\u67E5\u6240\u6709webview\u548Ciframe..."),this.checkAllWebviews()},1e3),this.registerScriptManagerEvents(),this.loadStyles(),this.setupRibbonIcon(),this.setupEventListeners()}onunload(){console.log("Unloading CheekyChimp plugin"),this.scriptInjector&&this.scriptInjector.cleanup(),this.webviewObserver&&(this.webviewObserver.disconnect(),this.webviewObserver=null),document.removeEventListener("cheekychimp-edit-script",this.editScriptHandler),document.removeEventListener("cheekychimp-create-script",this.createScriptHandler)}async setupWebviewHandling(){console.log("Setting up webview handling..."),this.webviewObserver=new MutationObserver(e=>{for(let n of e)n.type==="childList"&&n.addedNodes.forEach(r=>{r instanceof HTMLElement&&this.findAndHandleWebviews(r)})}),this.webviewObserver.observe(document,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]}),this.registerEvent(this.app.workspace.on("layout-change",()=>{console.log("Layout changed, checking for webviews..."),setTimeout(()=>this.checkAllWebviews(),300)})),this.registerEvent(this.app.workspace.on("active-leaf-change",e=>{e&&(console.log("Active leaf changed, checking for webviews..."),setTimeout(()=>this.handlePotentialWebViewLeaf(e),300))})),this.checkAllWebviews(),document.addEventListener("iframe-load",e=>{var i;let r=(i=e.detail)==null?void 0:i.iframe;r&&(console.log("Detected iframe load event:",r),this.injectIntoWebview(r))})}findAndHandleWebviews(e){let n='webview, iframe, .webview, .obsidian-webview, [data-type="webview"], iframe[allowfullscreen]',r=e.querySelectorAll(n);r.length>0&&console.log(`Found ${r.length} potential webviews in element:`,e),r.forEach(i=>{i instanceof HTMLElement&&this.injectIntoWebview(i)}),(e.tagName.toLowerCase()==="webview"||e.tagName.toLowerCase()==="iframe"||e.classList.contains("webview")||e.classList.contains("obsidian-webview")||e.getAttribute("data-type")==="webview"||e.tagName.toLowerCase()==="iframe"&&e.hasAttribute("allowfullscreen"))&&this.injectIntoWebview(e)}async injectIntoWebview(e){try{if(e.hasAttribute("data-cheekychimp-processed")){this.settings.debug&&console.log("Webview already processed:",e);return}console.log("Attempting to inject into webview:",e),e.setAttribute("data-cheekychimp-processed","true"),e instanceof HTMLIFrameElement?await this.waitForIframeLoad(e):await this.waitForWebviewLoad(e);let n=await this.getWebviewUrl(e);if(!n||n==="about:blank"){console.log("No valid URL found for webview, skipping injection");return}if(console.log("Injecting scripts for URL:",n),this.scriptInjector)try{let r=this.scriptManager.findScriptsForUrl(n);if(r.length>0){console.log(`Found ${r.length} scripts matching URL ${n}`);let i=await this.scriptInjector.injectScripts(e,n,r);console.log("Injection result:",i)}else console.log(`No scripts match URL ${n}`)}catch(r){console.error("Error during script injection:",r)}if(e instanceof HTMLIFrameElement)try{this.setupIframeNavigationListener(e)}catch(r){console.warn("Could not set up iframe navigation listener:",r)}}catch(n){console.error("Error injecting into webview:",n)}}waitForIframeLoad(e){return new Promise(n=>{var i,c,o;if(((i=e.contentDocument)==null?void 0:i.readyState)==="complete"||((o=(c=e.contentWindow)==null?void 0:c.document)==null?void 0:o.readyState)==="complete"){console.log("iframe already loaded"),n();return}let r=setTimeout(()=>{console.log("iframe load timeout, continuing anyway"),n()},3e3);e.addEventListener("load",()=>{clearTimeout(r),console.log("iframe loaded"),n()},{once:!0})})}waitForWebviewLoad(e){return new Promise(n=>{e.getURL?e.addEventListener("dom-ready",()=>n(),{once:!0}):n()})}async getWebviewUrl(e){if(e instanceof HTMLIFrameElement){let r=e.src||e.getAttribute("src")||"";if(r)return r;try{if(e.contentWindow&&e.contentWindow.location.href)return e.contentWindow.location.href}catch(i){console.warn("Cannot access iframe contentWindow (likely cross-origin)")}}if("getURL"in e&&typeof e.getURL=="function")try{return e.getURL()}catch(r){console.warn("getURL method failed:",r)}let n=e.getAttribute("data-src");return n||e.getAttribute("src")||null}checkAllWebviews(){console.log("Checking all webviews in workspace..."),this.app.workspace.iterateAllLeaves(n=>{this.handlePotentialWebViewLeaf(n)}),document.querySelectorAll("webview, iframe").forEach(n=>{n instanceof HTMLElement&&this.injectIntoWebview(n)})}handlePotentialWebViewLeaf(e){if(!e||!e.view)return;let n=e.view.containerEl;if(!n)return;n.querySelectorAll("webview, iframe").forEach(i=>{i instanceof HTMLElement&&this.injectIntoWebview(i)})}setupEventListeners(){this.editScriptHandler=e=>{var i;let r=(i=e.detail)==null?void 0:i.scriptId;r&&this.openScriptEditor(r)},this.createScriptHandler=e=>{var i;let r=(i=e.detail)==null?void 0:i.url;r&&this.createScriptForUrl(r)},document.addEventListener("cheekychimp-edit-script",this.editScriptHandler),document.addEventListener("cheekychimp-create-script",this.createScriptHandler)}async loadSettings(){this.settings=Object.assign({},H,await this.loadData())}async saveSettings(){this.settings.scripts=this.scriptManager.getAllScripts(),await this.saveData(this.settings)}openSettings(){if(this.app.setting){this.app.setting.open();try{this.app.setting.openTabById("obsidian-cheekychimp")}catch(e){console.warn("\u65E0\u6CD5\u76F4\u63A5\u6253\u5F00CheekyChimp\u8BBE\u7F6E\u6807\u7B7E\uFF0C\u5C06\u6253\u5F00\u901A\u7528\u8BBE\u7F6E\u9875\u9762")}}else new b.Notice(I.t("error_open_settings"))}openScriptEditor(e){let n=this.scriptManager.getScript(e);n&&(this.openSettings(),new b.Notice(I.t("opening_script_editor",{name:n.name})))}createScriptForUrl(e){if(!e)return;let n=new URL(e).hostname,r=`// ==UserScript==
// @name         Script for ${n}
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  Add functionality to ${n}
// @author       You
// @match        ${e}
// @grant        none
// ==/UserScript==

(function() {
    'use strict';
    
    // Add your code here...
    console.log('CheekyChimp script running!');
})();`;try{let i=this.scriptManager.addScript(r);new b.Notice(I.t("script_created_for_domain",{domain:n})),this.openScriptEditor(i.id)}catch(i){console.error("\u521B\u5EFA\u811A\u672C\u5931\u8D25:",i),new b.Notice(I.t("error_creating_script"))}}registerScriptManagerEvents(){this.scriptManager.on("onScriptAdded",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptRemoved",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptUpdated",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptEnabled",async()=>{await this.saveSettings()}),this.scriptManager.on("onScriptDisabled",async()=>{await this.saveSettings()})}loadStyles(){document.body.classList.add("cheekychimp-enabled");let e=document.createElement("style");e.id="cheekychimp-ui-styles",e.textContent=`
            .cheekychimp-browser-ui {
                z-index: 9;
                opacity: 0.7;
                transition: opacity 0.3s ease;
            }
            
            .cheekychimp-browser-ui:hover {
                opacity: 1;
            }
            
            .cheekychimp-icon {
                opacity: 0.8;
                transition: all 0.2s ease;
                box-shadow: 0 0 5px rgba(0,0,0,0.1);
            }
            
            .cheekychimp-icon:hover {
                background-color: var(--interactive-hover) !important;
                transform: scale(1.1);
                opacity: 1;
            }
            
            .cheekychimp-menu {
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }
            
            /* GreaseMonkey API \u6837\u5F0F */
            #gm-menu-container {
                position: fixed;
                top: 10px;
                right: 10px;
                z-index: 9999;
                display: none;
                background: #fff;
                border-radius: 5px;
                box-shadow: 0 0 10px rgba(0,0,0,0.2);
                padding: 5px 0;
                max-width: 300px;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            #gm-menu-button {
                position: fixed;
                top: 10px;
                right: -20px;
                z-index: 10000;
                cursor: pointer;
                background: #fff;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 0 5px rgba(0,0,0,0.2);
                transition: right 0.3s ease;
                opacity: 0.85;
                font-size: 16px;
            }
            
            #gm-trigger-zone {
                position: fixed;
                top: 0;
                right: 0;
                width: 30px;
                height: 50px;
                z-index: 9999;
            }
            
            .gm-menu-item {
                padding: 8px 15px;
                cursor: pointer;
                white-space: nowrap;
                font-size: 14px;
                color: #333;
                transition: background-color 0.2s ease;
            }
            
            .gm-menu-item:hover {
                background-color: #f0f0f0;
            }
        `,document.head.appendChild(e)}setupRibbonIcon(){(0,b.addIcon)("cheekychimp",`<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
            <path fill="currentColor" d="M 108.11719 0 L 0 108.11914 L 0 403.88086 L 108.11719 512 L 403.88281 512 L 512 403.88086 L 512 108.11914 L 403.88281 0 L 108.11719 0 z M 196.56055 128 L 315.43945 128 C 324.4555 128 332 135.5445 332 144.56055 L 332 196.56055 L 384 196.56055 C 393.0161 196.56055 400.56055 204.10499 400.56055 213.12109 L 400.56055 298.87891 C 400.56055 307.89501 393.0161 315.43945 384 315.43945 L 332 315.43945 L 332 367.43945 C 332 376.4555 324.4555 384 315.43945 384 L 196.56055 384 C 187.5445 384 180 376.4555 180 367.43945 L 180 315.43945 L 128 315.43945 C 118.98389 315.43945 111.43945 307.89501 111.43945 298.87891 L 111.43945 213.12109 C 111.43945 204.10499 118.98389 196.56055 128 196.56055 L 180 196.56055 L 180 144.56055 C 180 135.5445 187.5445 128 196.56055 128 z"/>
        </svg>`),this.addRibbonIcon("cheekychimp","CheekyChimp",e=>{let n=this.scriptManager.getAllScripts().filter(r=>r.enabled);if(n.length>0){let r=n.map(i=>`- ${i.name}`).join(`
`);new b.Notice(`${I.t("active_scripts")} (${n.length}):
${r}`)}else new b.Notice(I.t("no_active_scripts"));this.openSettings()})}setupIframeNavigationListener(e){try{if(!e.contentWindow)return;e.contentWindow.addEventListener("unload",()=>{console.log("iframe navigation detected"),e.removeAttribute("data-cheekychimp-processed"),setTimeout(()=>this.injectIntoWebview(e),500)}),e.addEventListener("load",()=>{console.log("iframe load event detected"),e.removeAttribute("data-cheekychimp-processed"),setTimeout(()=>this.injectIntoWebview(e),500)})}catch(n){console.warn("Unable to set up iframe navigation listener (likely cross-origin)")}}};
